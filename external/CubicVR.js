/*
  Javascript port of CubicVR 3D engine for WebGL
  by Charles J. Cliffe
  http://www.cubicvr.org/

  May be used under the terms of the MIT license.
  http://www.opensource.org/licenses/mit-license.php
*/

/*globals alert: false */
try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(y,x,q,m,f){function g(a,h){w.registry[a]=!0;var c=h(w),b;for(b in c)c.hasOwnProperty(b)&&(d[b]=c[b])}var r="";try{for(var n=x.querySelectorAll("script"),a=0,c=n.length;a<c;a++){var b=n[a].src.lastIndexOf("/CubicVR.js");b>-1&&(r=n[a].src.substr(0,b)+"/")}}catch(e){}var d=y.CubicVR={},h={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,
emptyLight:null,resizeList:[],canvasSizeFactor:1},o;try{o=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(z){o=m}var v={quality:{LOW:0,MEDIUM:1,HIGH:2}},w={undef:f,nop:m,scriptLocation:r,GLCore:h,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:o,registry:{},enums:v,MAX_LIGHTS:6,features:{},quality:v.HIGH},t={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,
lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};w.features=t.high;h.init=function(a,c,b){var e,z=d.util;c&&b?(c=z.getScriptContents(c),b=z.getScriptContents(b)):d.CubicVRCoreVS&&d.CubicVRCoreFS?(c=d.CubicVRCoreVS,b=d.CubicVRCoreFS):(c=z.getScriptContents(r+"CubicVR_Core.vs"),b=z.getScriptContents(r+"CubicVR_Core.fs"));if(a===f){a=x.createElement("canvas");e||(e=a.getContext("experimental-webgl",{antialias:w.features.antiAlias}));
h.gl=e;if(h.fixed_size!==null)h.width=h.fixed_size[0],h.height=h.fixed_size[1],h.resizeElement(a,h.width,h.height);else if(h.addResizeable(a),h.canvasSizeFactor!==1&&a.getContext!==f){var z=q.round(y.innerWidth*h.canvasSizeFactor),g=q.round(y.innerHeight*h.canvasSizeFactor);h.resizeElement(a,z,g);a.style.top=y.innerHeight/2-g/2+"px";a.style.left=y.innerWidth/2-z/2+"px";a.style.position="absolute"}else h.resizeElement(a,y.innerWidth,y.innerHeight);x.body.appendChild(a)}if(a.getContext!==f&&a.width!==
f&&a.height!==f){try{e||(e=a.getContext("experimental-webgl")),e.viewport(0,0,a.width,a.height),h.canvas=a,h.width=a.width,h.height=a.height,e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}catch(t){}if(!e)return null}else e=a;h.gl=e;h.CoreShader_vs=c;h.CoreShader_fs=b;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(c=v.light.type.NULL;c<v.light.type.MAX;c++)w.ShaderPool[c]=[];b=new d.Texture;a=new d.Material;for(c=0;c<v.texture.map.MAX;c++)c!==v.texture.map.BUMP&&
a.setTexture(b,c);a.opacity=0.5;c=1;try{for(;;){a.use(v.light.type.POINT,c);if(c===8){w.MAX_LIGHTS=c;break}c++}}catch(s){w.MAX_LIGHTS=c}a=h.emptyLight=new d.Light(v.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;o("Calibrated maximum lights per pass to: "+c);for(c=v.light.type.NULL;c<v.light.type.MAX;c++)w.ShaderPool[c]=[];if(h.resizeList.length)y.addEventListener("resize",function(){d.GLCore.onResize()},!1),h.resize_active=!0;return e};h.addResizeable=
function(a){d.GLCore.resizeList.push(a)};h.onResize=function(){var a=y.innerWidth,c=y.innerHeight;h.fixed_size!==null&&(a=d.GLCore.fixed_size[0],c=d.GLCore.fixed_size[1]);for(var b=0,e=d.GLCore.resizeList.length;b<e;b++)h.resizeElement(d.GLCore.resizeList[b],a,c)};h.setFixedAspect=function(a){d.GLCore.fixed_aspect=a};h.setFixedSize=function(a,c){d.GLCore.fixed_size=[a,c]};h.getCanvas=function(){return d.GLCore.canvas};h.resizeElement=function(a,c,b){var e=h.gl;if(h.fixed_aspect!==0){var o=c*(1/d.GLCore.fixed_aspect);
o>b&&(o=b,c=b*d.GLCore.fixed_aspect);b=o}if(a.getContext!==f){a.width=c;a.height=b;if(!d.GLCore.fixed_size)a.style.left=(y.innerWidth/2-c/2|0)+"px",a.style.top=(y.innerHeight/2-b/2|0)+"px",a.style.position="absolute";e.viewport(0,0,c,b)}else a.resize(c,b)};h.setDepthAlpha=function(a,d,c){h.depth_alpha=a;h.depth_alpha_near=d;h.depth_alpha_far=c};h.setDefaultFilter=function(a){h.default_filter=a};h.setSoftShadows=function(a){h.soft_shadow=a};h.setCanvasSizeFactor=function(a){h.canvasSizeFactor=a};h.setQuality=
function(a){if(a===v.quality.HIGH)w.features=t.high;else if(a===v.quality.MEDIUM)w.features=t.medium;else if(a===v.quality.LOW)w.features=t.low;w.quality=a;return w.features};h.getQuality=function(){return w.features};var s={GLCore:h,init:function(a,d,c){for(var b,e=x.getElementsByTagName("script"),o=0;o<e.length;++o){var z=e[o];if(z.getAttribute("data-cubicvr")){var g=z.getAttribute("src");if(g){var t=new XMLHttpRequest;t.open("GET",g,!1);t.send(null);if(t.status===200||t.status===0)z.text=t.responseText}}}if(typeof a===
"object")b=a.canvas,d=a.vertexShader||d,c=a.fragmentShader||c;return h.init(b,d,c)},addResizeable:h.addResizeable,setFixedAspect:h.setFixedAspect,setFixedSize:h.setFixedSize,setCanvasSizeFactor:h.setCanvasSizeFactor,getCanvas:h.getCanvas,enums:v,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:w.Textures,Textures_obj:w.Textures_obj,Images:w.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){d.globalAmbient=a},setGlobalDepthAlpha:h.setDepthAlpha,setDefaultFilter:h.setDefaultFilter,
setSoftShadows:h.setSoftShadows,setQuality:h.setQuality,getQuality:h.getQuality,RegisterModule:g,getScriptLocation:function(){return r}};g("Core",function(){return s})})(window,window.document,Math,function(){});
(function(){function y(){for(var g=0;g<q.length;g++)importScripts(CubicVR.getScriptLocation()+"/source/CubicVR."+q[g]+".js")}var x,q=["Math","Utility","Shader","MainLoop","Texture","Material","Mesh","UVMapper","Renderer","Light","Camera","Motion","Event","Scene","PostProcess","Layout","Primitives","COLLADA","GML","Particles","Landscape","Octree","CVRXML","Worker","Polygon","ScenePhysics","CollisionMap"];try{if(typeof define==="function"&&define.amd){var m=[];for(x=0;x<q.length;x++)m.push("order!./source/CubicVR."+
q[x]);define(m,function(){})}else for(x=0;x<q.length;x++)document.write('<script type="text/javascript" src="'+CubicVR.getScriptLocation()+"/source/CubicVR."+q[x]+'.js"><\/script>')}catch(f){var g=function(r){var n=r.data.data+"";CubicVR.getScriptLocation=function(){return n};y();self.removeEventListener("message",g,!1);CubicVR.InitWorker()};self.addEventListener("message",g,!1)}})();CubicVR.RegisterModule("Math",function(y){function x(a){return this.clearStack(a)}function q(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var m=y.undef,f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=Math.PI/2,r={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*
a[1]+a[2]*a[2]);if(c===0)return[0,0,0];return[a[0]/c,a[1]/c,a[2]/c]},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},angle:function(a,c){return Math.acos((a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])))},cross:function(a,c){return[a[1]*c[2]-c[1]*a[2],a[2]*c[0]-c[2]*a[0],a[0]*c[1]-c[0]*a[1]]},multiply:function(a,c){return[a[0]*c,a[1]*c,a[2]*c]},add:function(a,c){return[a[0]+c[0],a[1]+c[1],a[2]+c[2]]},subtract:function(a,c){return[a[0]-
c[0],a[1]-c[1],a[2]-c[2]]},equal:function(a,c,b){b===m&&(b=1.0E-7);if(a===m&&c===m)return!0;if(a===m||c===m)return!1;return Math.abs(a[0]-c[0])<b&&Math.abs(a[1]-c[1])<b&&Math.abs(a[2]-c[2])<b},moveViewRelative:function(a,c,b,e,d){var h=Math.sqrt(b*b+e*e),c=Math.atan2(c[2]-a[2],c[0]-a[0])+Math.atan2(e,b)+g;if(typeof d==="object")return[d[0]+h*Math.cos(c),d[1],d[2]+h*Math.sin(c)];return[a[0]+h*Math.cos(c),a[1],a[2]+h*Math.sin(c)]},trackTarget:function(a,c,b,e){var c=r.subtract(c,a),d=r.length(c),h;
h=r.normalize(c);h=r.multiply(h,b*(1/(1/(d-e))));d>e?a=r.add(a,h):d<e?(h=r.normalize(c),h=r.multiply(h,b*(1/(1/Math.abs(d-e)))),a=r.subtract(a,h)):a=[a[0],a[1]+h[2],a[2]];return a},getClosestTo:function(a,c,b){c=r.subtract(c,a);b=r.subtract(b,a);return r.add(r.multiply(c,r.dot(c,b)/r.dot(c,c)),a)},linePlaneIntersect:function(a,c,b,e){var d=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2],c=a[0]*(e[0]-b[0])+a[1]*(e[1]-b[1])+a[2]*(e[2]-b[2]);if(Math.abs(c)<0.0010)return!1;a=-(d+a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/c;return[b[0]+
a*(e[0]-b[0]),b[1]+a*(e[1]-b[1]),b[2]+a*(e[2]-b[2])]}},n={lookat:function(a,c,b,e,d,h,o,z,g){var w=[],t=[],s=[],t=[];w[0]=e-a;w[1]=d-c;w[2]=h-b;s[0]=o;s[1]=z;s[2]=g;w=r.normalize(w);t=r.cross(w,s);t=r.normalize(t);s=r.cross(t,w);t=[t[0],s[0],-w[0],0,t[1],s[1],-w[1],0,t[2],s[2],-w[2],0,0,0,0,1];e=new CubicVR.Transform(t);e.translate([-a,-c,-b]);return e.getResult()},multiply:function(a,c,b){b===m&&(b=[]);b[0]=a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12]*c[3];b[1]=a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13]*c[3];b[2]=
a[2]*c[0]+a[6]*c[1]+a[10]*c[2]+a[14]*c[3];b[3]=a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+a[15]*c[3];b[4]=a[0]*c[4]+a[4]*c[5]+a[8]*c[6]+a[12]*c[7];b[5]=a[1]*c[4]+a[5]*c[5]+a[9]*c[6]+a[13]*c[7];b[6]=a[2]*c[4]+a[6]*c[5]+a[10]*c[6]+a[14]*c[7];b[7]=a[3]*c[4]+a[7]*c[5]+a[11]*c[6]+a[15]*c[7];b[8]=a[0]*c[8]+a[4]*c[9]+a[8]*c[10]+a[12]*c[11];b[9]=a[1]*c[8]+a[5]*c[9]+a[9]*c[10]+a[13]*c[11];b[10]=a[2]*c[8]+a[6]*c[9]+a[10]*c[10]+a[14]*c[11];b[11]=a[3]*c[8]+a[7]*c[9]+a[11]*c[10]+a[15]*c[11];b[12]=a[0]*c[12]+a[4]*c[13]+a[8]*
c[14]+a[12]*c[15];b[13]=a[1]*c[12]+a[5]*c[13]+a[9]*c[14]+a[13]*c[15];b[14]=a[2]*c[12]+a[6]*c[13]+a[10]*c[14]+a[14]*c[15];b[15]=a[3]*c[12]+a[7]*c[13]+a[11]*c[14]+a[15]*c[15];return b},vec4_multiply:function(a,c,b){b===m&&(b=[]);b[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12]*a[3];b[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13]*a[3];b[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14]*a[3];b[3]=c[3]*a[0]+c[7]*a[1]+c[11]*a[2]+c[15]*a[3];return b},vec3_multiply:function(a,c,b){b===m&&(b=[]);b[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+
c[12];b[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13];b[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14];return b},perspective:function(a,c,b,e){a=Math.tan(a*Math.PI/360);return[1/(a*c),0,0,0,0,1/a,0,0,0,0,-(e+b)/(e-b),-1,0,0,-(2*e*b)/(e-b),0]},ortho:function(a,c,b,e,d,h){return[2/(c-a),0,0,0,0,2/(e-b),0,0,0,0,-2/(h-d),0,-(a+c)/(c-a),-(e+b)/(e-b),-(h+d)/(h-d),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*
a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var c=[],b=a[0],e=a[1],d=a[2],h=a[4],o=a[5],z=a[6],g=a[8],w=a[9],a=a[10],t=a*o-z*w,s=-a*h+z*g,n=w*h-o*g,r=b*t+e*s+d*n;if(!r)return null;r=1/r;c[0]=t*r;c[1]=(-a*e+d*w)*r;c[2]=(z*
e-d*o)*r;c[3]=s*r;c[4]=(a*b-d*g)*r;c[5]=(-z*b+d*h)*r;c[6]=n*r;c[7]=(-w*b+e*g)*r;c[8]=(o*b-e*h)*r;return c},inverse:function(a,c){var b=a[0]*a[5]-a[1]*a[4],e=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],h=a[1]*a[6]-a[2]*a[5],o=a[1]*a[7]-a[3]*a[5],z=a[2]*a[7]-a[3]*a[6],g=a[8]*a[13]-a[9]*a[12],w=a[8]*a[14]-a[10]*a[12],t=a[8]*a[15]-a[11]*a[12],s=a[9]*a[14]-a[10]*a[13],n=a[9]*a[15]-a[11]*a[13],r=a[10]*a[15]-a[11]*a[14],f=b*r-e*n+d*s+h*t-o*w+z*g;if(f!==0)return c===m&&(c=[]),c[0]=0+a[5]*r-a[6]*n+a[7]*s,c[4]=
0-a[4]*r+a[6]*t-a[7]*w,c[8]=0+a[4]*n-a[5]*t+a[7]*g,c[12]=0-a[4]*s+a[5]*w-a[6]*g,c[1]=0-a[1]*r+a[2]*n-a[3]*s,c[5]=0+a[0]*r-a[2]*t+a[3]*w,c[9]=0-a[0]*n+a[1]*t-a[3]*g,c[13]=0+a[0]*s-a[1]*w+a[2]*g,c[2]=0+a[13]*z-a[14]*o+a[15]*h,c[6]=0-a[12]*z+a[14]*d-a[15]*e,c[10]=0+a[12]*o-a[13]*d+a[15]*b,c[14]=0-a[12]*h+a[13]*e-a[14]*b,c[3]=0-a[9]*z+a[10]*o-a[11]*h,c[7]=0+a[8]*z-a[10]*d+a[11]*e,c[11]=0-a[8]*o+a[9]*d-a[11]*b,c[15]=0+a[8]*h-a[9]*e+a[10]*b,b=1/f,c[0]*=b,c[1]*=b,c[2]*=b,c[3]*=b,c[4]*=b,c[5]*=b,c[6]*=b,
c[7]*=b,c[8]*=b,c[9]*=b,c[10]*=b,c[11]*=b,c[12]*=b,c[13]*=b,c[14]*=b,c[15]*=b,c;return null},identity:function(a){if(a==m)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,c,b,e){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,c,b,1];if(e===m)return a;n.multiply(e.slice(0),a,e)},rotateAxis:function(a,c,b,e,d){var h=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),c=[a+c*c*(1-a),c*b*
(1-a)-e*h,c*e*(1-a)+b*h,0,b*c*(1-a)+e*h,a+b*b*(1-a),b*e*(1-a)-c*h,0,e*c*(1-a)-b*h,e*b*(1-a)+c*h,a+e*e*(1-a),0,0,0,0,1];if(d===m)return c;n.multiply(d.slice(0),c,d)},rotate:function(a,c,b,e){var d;e===m&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);b!==0&&(d=Math.sin(b*(Math.PI/180)),b=Math.cos(b*(Math.PI/180)),n.multiply(e.slice(0),[b,d,0,0,-d,b,0,0,0,0,1,0,0,0,0,1],e));c!==0&&(d=Math.sin(c*(Math.PI/180)),b=Math.cos(c*(Math.PI/180)),n.multiply(e.slice(0),[b,0,-d,0,0,1,0,0,d,0,b,0,0,0,0,1],e));a!==0&&(d=
Math.sin(a*(Math.PI/180)),b=Math.cos(a*(Math.PI/180)),n.multiply(e.slice(0),[1,0,0,0,0,b,d,0,0,-d,b,0,0,0,0,1],e));return e},scale:function(a,c,b,e){if(e===m)return[a,0,0,0,0,c,0,0,0,0,b,0,0,0,0,1];n.multiply(e.slice(0),[a,0,0,0,0,c,0,0,0,0,b,0,0,0,0,1],e)}};x.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=
0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var c=f;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var b=this.valid;b<this.c_stack+1;b++)c=a.multiply(c,this.m_stack[b]),this.m_cache[b]=c;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:f;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=
[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==m?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,c,b){var e=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var d=this.getIdentity();d[12]=a;d[13]=c;d[14]=b;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,c,b){var e=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);
var d=this.getIdentity();d[0]=a;d[5]=c;d[10]=b;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,c,b,e){var d=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var h,o;if(c||b||e)h=Math.sin(-a*(Math.PI/180)),o=Math.cos(-a*(Math.PI/180));c&&(a=this.getIdentity(),a[5]=o*c,a[9]=h*c,a[6]=-h*c,a[10]=o*c,this.m_stack[this.c_stack]=d.multiply(a,
this.m_stack[this.c_stack]));b&&(c=this.getIdentity(),c[0]=o*b,c[8]=-h*b,c[2]=h*b,c[10]=o*b,this.m_stack[this.c_stack]=d.multiply(c,this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=o*e,b[4]=h*e,b[1]=-h*e,b[5]=o*e,this.m_stack[this.c_stack]=d.multiply(b,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};q.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());
this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var c=1+a[0]+a[5]+a[10],b,e,d;c>1.0E-8?(b=Math.sqrt(c)*2,c=(a[9]-a[6])/b,e=(a[2]-a[8])/b,d=(a[4]-a[1])/b,a=0.25*b):a[0]>a[5]&&a[0]>a[10]?(b=Math.sqrt(1+a[0]-a[5]-a[10])*2,c=0.25*b,e=(a[4]+a[1])/b,d=(a[2]+a[8])/b,a=(a[9]-a[6])/b):a[5]>a[10]?(b=Math.sqrt(1+a[5]-a[0]-a[10])*2,c=(a[4]+a[1])/b,e=0.25*b,d=(a[9]+a[6])/b,a=(a[2]-a[8])/b):(b=Math.sqrt(1+a[10]-a[0]-a[5])*2,c=(a[2]+a[8])/b,e=(a[9]+a[6])/b,d=0.25*b,a=(a[4]-a[1])/b);this.x=c;this.y=
e;this.z=d;this.w=a},fromEuler:function(a,c,b){var e=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),d=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),h=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),o=e*d,z=c*b;this.w=o*h-z*a;this.x=o*a+z*h;this.y=c*d*h+e*b*a;this.z=e*b*h-c*d*a},toEuler:function(){var a=this.w*this.w,c=this.x*this.x,b=this.y*this.y,e=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-c-b+e+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*
this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),c-b-e+a)]},multiply:function(a,c){c===m&&(c=a,a=this);return new q(a.x*c.w+a.w*c.x+a.y*c.z-a.z*c.y,a.y*c.w+a.w*c.y+a.z*c.x-a.x*c.z,a.z*c.w+a.w*c.z+a.x*c.y-a.y*c.x,a.w*c.w-a.x*c.x-a.y*c.y-a.z*c.z)}};return{vec2:{equal:function(a,c,b){b===m&&(b=1.0E-8);if(a===m&&c===m)return!0;if(a===m||c===m)return!1;return Math.abs(a[0]-c[0])<b&&Math.abs(a[1]-c[1])<b}},vec3:r,mat3:{transpose_inline:function(a){var c=a[1],b=a[2],e=a[5];a[1]=a[3];a[2]=
a[6];a[3]=c;a[5]=a[7];a[6]=b;a[7]=e},vec3_multiply:function(a,c,b){b===m&&(b=[]);b[0]=c[0]*a[0]+c[3]*a[1]+c[6]*a[2];b[1]=c[1]*a[0]+c[4]*a[1]+c[7]*a[2];b[2]=c[2]*a[0]+c[5]*a[1]+c[8]*a[2];return b}},mat4:n,aabb:{engulf:function(a,c){a[0][0]>c[0]&&(a[0][0]=c[0]);a[0][1]>c[1]&&(a[0][1]=c[1]);a[0][2]>c[2]&&(a[0][2]=c[2]);a[1][0]<c[0]&&(a[1][0]=c[0]);a[1][1]<c[1]&&(a[1][1]=c[1]);a[1][2]<c[2]&&(a[1][2]=c[2])},reset:function(a,c){c===void 0&&(c=[0,0,0]);a[0][0]=c[0];a[0][1]=c[1];a[0][2]=c[2];a[1][0]=c[0];
a[1][1]=c[1];a[1][2]=c[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,c){var b=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3];if(b<0)return-1;else if(b>0)return 1;return 0},normalize:function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c}},sphere:{intersects:function(a,c){var b=CubicVR.vec3.subtract([a[0],a[1],a[2]],
[c[0],c[1],c[2]]),b=Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]),e=a[3]+c[3];if(b*b<e*e)return!0;return!1}},triangle:{normal:function(a,c,b,e){e===m&&(e=[]);var d=a[0]-c[0],h=a[1]-c[1],a=a[2]-c[2],o=c[0]-b[0],z=c[1]-b[1],c=c[2]-b[2];e[0]=h*c-a*z;e[1]=a*o-d*c;e[2]=d*z-h*o;return e}},Transform:x,Quaternion:q}});CubicVR.RegisterModule("Utility",function(y){var x=y.undef;return{util:{getJSONScriptObj:function(q,m){if(typeof q==="string"&&q.length>0&&q.charAt(0)==="#"){var f=document.getElementById(q.substr(1));if(f)return f=JSON.parse(f.innerHTML||f.text),m&&m(f),f}return q},getScriptContents:function(q){var m=document.getElementById(q),f="",g="";if(m){if(m.src!==""||m.attributes.srcUrl!==x)g=m.src!==""?m.src:m.attributes.srcUrl.value}else g=q;if(g.length!==0){if(q=new XMLHttpRequest,q.open("GET",g,!1),q.send(null),
q.status===200||q.status===0)f=q.responseText}else for(g=m.firstChild;g;)g.nodeType===3&&(f+=g.textContent),g=g.nextSibling;return f},getURL:function(q){try{var m=new XMLHttpRequest;m.open("GET",q,!1);m.send(null);if(m.status===200||m.status===0)if(m.responseText.length)return m.responseText;else if(m.responseXML)return m.responseXML}catch(f){alert(q+" failed to load.")}return null},getXML:function(q){try{var m=new XMLHttpRequest;m.open("GET",q,!1);m.overrideMimeType("application/xml");m.send(null);
if(m.status===200||m.status===0)return m.responseXML}catch(f){try{alert(q+" failed to load.")}catch(g){throw f;}}return null},getJSON:function(q){try{var m=new XMLHttpRequest;m.open("GET",q,!1);m.overrideMimeType("application/json");m.send(null);if(m.status===200||m.status===0)return eval("("+m.responseText+")")}catch(f){try{alert(q+" failed to load.")}catch(g){throw f;}}return null},repackArray:function(q,m,f){q.length!==parseInt(m,10)*parseInt(f,10)&&log("array repack error, data size !== stride*count: data.length="+
q.length+" stride="+m+" count="+f);for(var f=[],g=0,r=0,n=q.length;r<n;r++){var a=r%m;a===0&&(f[g]=[]);f[g][a]=q[r];a===m-1&&g++}return f},collectTextNode:function(q){if(!q)return"";for(var m="",q=q.childNodes,f=0,g=q.length;f<g;f++)m+=q[f].nodeValue;return m},floatDelimArray:function(q,m){for(var f=q.split(m?m:","),g=0,r=f.length;g<r;g++)f[g]=parseFloat(f[g]);f[f.length-1]!==f[f.length-1]&&f.pop();return f},intDelimArray:function(q,m){for(var f=q.split(m?m:","),g=0,r=f.length;g<r;g++)f[g]=parseInt(f[g],
10);f[f.length-1]!==f[f.length-1]&&f.pop();return f},textDelimArray:function(q,m){for(var f=q.split(m?m:","),g=0,r=f.length;g<r;g++)f[g]=f[g];return f},xml2badgerfish:function(q){var m={},f=[],g,r,n,a,c,b=/^\s+|\s+$/g;q.jsonParent=m;for(f.push(q);f.length;){r=f.pop();var e=null;n=r.jsonParent;q=0;for(g=r.childNodes.length;q<g;q++)a=r.childNodes[q],c=a.tagName,c!==x&&(e=e||{},e[c]=e[c]||0,e[c]++);if(r.attributes&&r.attributes.length){q=0;for(g=r.attributes.length;q<g;q++)a=r.attributes[q],n["@"+a.name]=
a.value}q=0;for(g=r.childNodes.length;q<g;q++)if(a=r.childNodes[q],c=a.tagName,a.nodeType===1)e[c]>1?(n[c]=n[c]||[],n[c].push({}),a.jsonParent=n[c][n[c].length-1]):(n[c]=n[c]||{},a.jsonParent=n[c]),f.push(a);else if(a.nodeType===3&&a.nodeValue.replace(b,"")!=="")n.$=n.$||"",n.$+=a.nodeValue}return m}}}});CubicVR.RegisterModule("COLLADA",function(y){function x(n,a){function c(a){if(!a.color)return!1;return(a=a.color)?e.floatDelimArray(a.$," "):!1}function b(a){var I;if(!a["float"])return!1;return I=(a=a["float"])?parseFloat(a.$):0,a=I}var e=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var d,h,o,z,v;v=typeof n=="object"?n:n.indexOf(".js")!=-1?e.getJSON(n):CubicVR.util.xml2badgerfish(e.getXML(n));var w,t,s,B,f,G,A,u,K,D,C,x=v;v=null;if(!x.COLLADA)throw Error(n+" does not appear to be a valid COLLADA file.");
x=x.COLLADA;v={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(x.asset){var y=x.asset.up_axis.$;if(y==="X_UP")v.up_axis=0;else if(y==="Y_UP")v.up_axis=1;else if(y==="Z_UP")v.up_axis=2}y=v.up_axis;if(x.library_images){if(x.library_images.image&&!x.library_images.image.length)x.library_images.image=[x.library_images.image];if(x.library_images.image.length){h=x.library_images.image;d=0;for(u=h.length;d<u;d++){var E=h[d],F=E["@id"];B=E["@name"];E=
E.init_from;if(E.$)E=E.$,a!==q&&E.lastIndexOf("/")!==-1&&(E=E.substr(E.lastIndexOf("/")+1)),a!==q&&E.lastIndexOf("\\")!==-1&&(E=E.substr(E.lastIndexOf("\\")+1)),v.images[F]={source:E,id:F,name:B}}}}var H,O,J,P,R;if(x.library_effects){var M=x.library_effects.effect;M&&!M.length&&(M=[M]);E=0;for(H=M.length;E<H;E++){u=M[E];B=u["@id"];z={};z.id=B;z.surfaces=[];z.samplers=[];(F=u.profile_COMMON.newparam)&&!F.length&&(F=[F]);if(F){h=0;for(d=F.length;h<d;h++){var Q=F[h],N=Q["@sid"];if(Q.surface){if(z.surfaces[N]=
{},Q=Q.surface.init_from.$,typeof v.images[Q]==="object")z.surfaces[N].source=a+"/"+v.images[Q].source}else if(Q.sampler2D){z.samplers[N]={};z.samplers[N].source=Q.sampler2D.source.$;if(Q.sampler2D.minfilter)z.samplers[N].minfilter=Q.sampler2D.minfilter.$;if(Q.sampler2D.magfilter)z.samplers[N].magfiter=Q.sampler2D.magfilter.$}}}(h=u.profile_COMMON.technique)&&!h.length&&(h=[h]);z.material={textures_ref:[]};u=0;for(F=h.length;u<F;u++){d=h[u].blinn;if(!d)d=h[u].phong;if(!d)d=h[u].lambert;if(d)for(A in d){var T=
d[A],N=c(T),Q=b(T);T=T.texture?T.texture["@texture"]:!1;N!==!1&&N.length>3&&N.pop();if(A=="emission"){if(N!==!1)z.material.ambient=N}else if(A!="ambient")if(A=="diffuse"){if(N!==!1)z.material.color=N}else if(A=="specular"){if(N!==!1)z.material.specular=N}else if(A=="shininess"&&Q!==!1)z.material.shininess=Q;if(T!==!1)N=z.surfaces[z.samplers[T].source].source,A=="emission"?z.material.textures_ref.push({image:N,type:m.texture.map.AMBIENT}):A=="ambient"?z.material.textures_ref.push({image:N,type:m.texture.map.AMBIENT}):
A=="diffuse"?z.material.textures_ref.push({image:N,type:m.texture.map.COLOR}):A=="specular"?z.material.textures_ref.push({image:N,type:m.texture.map.SPECULAR}):A!="shininess"&&(A=="reflective"?z.material.textures_ref.push({image:N,type:m.texture.map.REFLECT}):A!="reflectivity"&&A=="transparent"&&z.material.textures_ref.push({image:N,type:m.texture.map.ALPHA}))}v.effects[B]=z}}}u=r.getAllOf(x,"instance_geometry");A=[];if(u.length){d=0;for(h=u.length;d<h;d++)if(F=u[d],B=r.getAllOf(F,"instance_material"),
B.length){C=0;for(G=B.length;C<G;C++)H=B[C],E=H["@symbol"],H=H["@target"].substr(1),A[F["@url"].substr(1)+":"+E]=H}}h=x.library_materials;if(h.material){(u=h.material)&&!u.length&&(u=[u]);h=0;for(d=u.length;h<d;h++)if(B=u[h],F=B["@id"],E=B["@name"],B=B.instance_effect)B=B["@url"].substr(1),v.materials.push({id:F,name:E,mat:v.effects[B].material})}h=x.library_geometries;var X;if(h&&((B=h.geometry)&&!B.length&&(B=[B]),B.length)){E=0;for(H=B.length;E<H;E++){var M={id:q,points:[],parts:[]},Y=B[E].mesh;
if(Y){X=B[E]["@id"];z=B[E]["@name"];(d=Y.source)&&!d.length&&(d=[d]);z=[];u=0;for(F=d.length;u<F;u++)if(N=d[u],h=N["@id"],Q=N["@name"],(T=N.float_array)&&(z[h]={id:h,name:Q,data:e.floatDelimArray(T.$?T.$:""," ")}),N=N.technique_common.accessor)if(z[h].count=N["@count"]|0,z[h].stride=N["@stride"]|0,z[h].count)z[h].data=e.repackArray(z[h].data,z[h].stride,z[h].count);h=Y.vertices;var S=T=Q=N=null,$=null;if(h&&(Q=h["@id"],(d=h.input)&&!d.length&&(d=[d]),d)){s=0;for(O=d.length;s<O;s++)J=d[s],J["@semantic"]===
"POSITION"&&(N=J["@source"].substr(1))}var U=Y.triangles;U&&!U.length&&(U=[U]);if(U){u=0;for(F=U.length;u<F;u++){R={material:0,faces:[],normals:[],texcoords:[],colors:[]};h=parseInt(U[u]["@count"],10);(d=U[u].input)&&!d.length&&(d=[d]);P=[];if(d.length){s=0;for(O=d.length;s<O;s++)J=d[s],f=parseInt(J["@offset"],10),o=J["@source"].substr(1),J["@semantic"]==="VERTEX"?(o===Q&&(o=N),P[f]=0):J["@semantic"]==="NORMAL"?(T=o,z[T].count&&(P[f]=1)):J["@semantic"]==="TEXCOORD"?($=o,z[$].count&&(P[f]=2)):J["@semantic"]===
"COLOR"?(S=o,z[S].count&&(P[f]=3)):P[f]=4}s=P.length;d=X+":"+U[u]["@material"];d===null?R.material=0:A[d]===q?(g("missing material ["+d+"]@"+X+"?"),R.material=0):R.material=A[d];d=U[u].p;s=[];d&&(s=e.intDelimArray(d.$," "));if(s.length&&(d=s.length/P.length/3,d===h)){if(M.points.length===0)M.points=z[N].data;d=f=0;h=s.length;for(f=P.length;d<h;d+=f*3){w=[];t=[];o=[];J=[];for(C=0;C<f*3;C++)O=C%f,P[O]===0?t.push(s[d+C]):P[O]===1?w.push(s[d+C]):P[O]===2?o.push(s[d+C]):P[O]===3&&J.push(s[d+C]);t.length&&
(R.faces.push(t),w.length===3&&R.normals.push([r.fixuaxis(v.up_axis,z[T].data[w[0]]),r.fixuaxis(v.up_axis,z[T].data[w[1]]),r.fixuaxis(v.up_axis,z[T].data[w[2]])]),o.length===3&&R.texcoords.push([z[$].data[o[0]],z[$].data[o[1]],z[$].data[o[2]]]),J.length===3&&R.colors.push([z[S].data[J[0]],z[S].data[J[1]],z[S].data[J[2]]]))}}M.parts.push(R)}}U=Y.polylist;if(!U)U=Y.polygons;U&&!U.length&&(U=[U]);if(U){u=0;for(F=U.length;u<F;u++){R={material:0,faces:[],normals:[],texcoords:[],colors:[]};C=parseInt(U[u]["@count"],
10);(d=U[u].input)&&!d.length&&(d=[d]);P=[];if(d.length){s=0;for(O=d.length;s<O;s++)J=d[s],h=J["@offset"],h===null&&(h=J["@idx"]),f=parseInt(h,10),o=J["@source"].substr(1),J["@semantic"]==="VERTEX"?(o===Q&&(o=N),P[f]=0):J["@semantic"]==="NORMAL"?(T=o,P[f]=1):J["@semantic"]==="TEXCOORD"?($=o,P[f]=2):J["@semantic"]==="COLOR"?(S=o,P[f]=3):P[f]=4}h=U[u].vcount;Y=[];h&&(Y=e.intDelimArray(h.$," "));d=X+":"+U[u]["@material"];R.material=d===q?0:A[d];J=U[u].p;s=P.length;O=[];if(J.length>1&&!Y.length){h=0;
for(d=J.length;h<d;h++)f=e.intDelimArray(J[h].$," "),Y[h]=parseInt(f.length/s,10),O.splice(O.length,0,f)}else J&&(O=e.intDelimArray(J.$," "));if(O.length)if(d=Y.length,d!==C)g("poly vcount data doesn't add up, skipping object load: "+d+" !== "+C);else{if(M.points.length===0)M.points=z[N].data;d=f=0;for(h=Y.length;d<h;d++){w=[];t=[];o=[];J=[];C=0;for(G=Y[d]*s;C<G;C++)P[C%s]===0?t.push(O[f]):P[C%s]===1?w.push(O[f]):P[C%s]===2?o.push(O[f]):P[C%s]===3&&J.push(O[f]),f++;if(t.length){R.faces.push(t);if(w.length){C=
[];G=0;for(t=w.length;G<t;G++)C.push(r.fixuaxis(v.up_axis,z[T].data[w[G]]));R.normals.push(C)}if(o.length){C=[];G=0;for(t=o.length;G<t;G++)C.push(z[$].data[o[G]]);R.texcoords.push(C)}if(J.length){C=[];G=0;for(t=J.length;G<t;G++)C.push(z[S].data[J[G]]);R.colors.push(C)}}}}M.parts.push(R)}}if(y!==1){d=0;for(h=M.points.length;d<h;d++)M.points[d]=r.fixuaxis(v.up_axis,M.points[d])}M.id=X;v.meshes.push(M)}}}if(h=x.library_cameras){(B=h.camera)&&!B.length&&(B=[B]);A=0;for(u=B.length;A<u;A++){h=B[A];E=h["@id"];
H=F=d=0;if(h.optics&&h.optics.technique_common&&h.optics.technique_common.perspective)d=h.optics.technique_common.perspective.yfov,F=h.optics.technique_common.perspective.znear,H=h.optics.technique_common.perspective.zfar;var V;if(!d&&!F&&!H){(F=h.param)&&!F.length&&(F=[F]);d=0;for(h=F.length;d<h;d++)H=F[d].$,M=F[d]["@name"],M=="YFOV"?V=parseFloat(H):M=="ZNEAR"?K=parseFloat(H):M=="ZFAR"&&(D=parseFloat(H))}else V=d?parseFloat(d.$):60,K=F?parseFloat(F.$):0.1,D=H?parseFloat(H.$):1E3;v.cameras.push({id:E,
targeted:!1,fov:parseFloat(V),nearclip:parseFloat(K),farclip:parseFloat(D)})}}if(V=x.library_lights)if((V=V.light)&&!V.length&&(V=[V]),V){K=0;for(D=V.length;K<D;K++)if(d=V[K],A=(h=d.technique_common.point)?h:null,h=d["@id"],A!==null)d=(d=A.intensity)?parseFloat(d.$):1,u=(u=A.distance)?parseFloat(u.$):10,A=A.color,J=[1,1,1],A&&(J=e.floatDelimArray(A.$," ")),v.lights.push({id:h,name:h,type:m.light.type.POINT,method:m.light.method.STATIC,diffuse:J,specular:[0,0,0],distance:u,intensity:d})}if(K=x.library_visual_scenes){V=
null;(V=K.visual_scene)&&!V.length&&(V=[V]);K=0;for(D=V.length;K<D;K++){B=V[K];A={id:B["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};u=[];var F=[],W;if(h=x.library_nodes){(H=h.node)&&!H.length&&(H=[H]);u=[];d=0;for(h=H.length;d<h;d++)E=H[d],mnodeId=E["@id"],u[W]=E;for(E=[B];E.length;){H=E.pop();if(H.node&&((C=H.node)&&!C.length&&(C=[C]),C)){d=0;for(h=C.length;d<h;d++)E.push(C[d])}if(H.instance_node){(M=H.instance_node)&&!M.length&&(M=[M]);d=0;for(h=M.length;d<h;d++)if(z=M[d]["@url"].substr(1),
u[z]){if(H.node&&H.node.length)H.node=[H.node];H.node?H.node.push(u[z]):H.node=[u[z]]}}}}for(E=[B];E.length;)if(H=E.pop(),H.node&&((C=H.node)&&!C.length&&(C=[C]),C)){d=0;for(h=C.length;d<h;d++)C[d].parentNode=H,F.push(C[d]),E.push(C[d])}if(F.length){B=0;for(E=F.length;B<E;B++){N=F[B];Q=N.instance_geometry;d=F[B].instance_light;h=F[B].instance_camera;W=N["@id"];H=N["@name"];M=r.cl_getInitalTransform(v.up_axis,N);if(y===2)M.rotation=r.quaternionFilterZYYZ(M.rotation,h?[-90,0,0]:q);S=T=null;if(Q){Q&&
!Q.length&&(Q=[Q]);d=0;for(h=Q.length;d<h;d++){z=Q[d]["@url"].substr(1);S={};S.name=(H?H:W)+(d?d:"");S.id=(W?W:H)+(d?d:"");S.meshId=X;S.meshName=z;if(!T)S.position=M.position,S.rotation=M.rotation,S.scale=M.scale,S.matrix=M.matrix;A.sceneObjects.push(S);u[S.id]=!0;N.parentNode&&((z=N.parentNode["@id"])&&u[z]?A.parentMap.push({parent:z,child:S.id}):Q.length>1&&(T?u[T.id]&&A.parentMap.push({parent:T.id,child:S.id}):(T=S,S={})))}}else h?(h=h["@url"].substr(1),A.cameras.push({name:H?H:W,id:H?H:W,source:h,
position:M.position,rotation:M.rotation})):d?(h=d["@url"].substr(1),A.lights.push({name:H?H:W,id:H?H:W,source:h,position:M.position})):(S={position:M.position,rotation:M.rotation,scale:M.scale,matrix:M.matrix},S.name=H?H:W,S.id=W?W:H,A.sceneObjects.push(S),u[S.id]=!0,N.parentNode&&(z=N.parentNode["@id"])&&u[z]&&A.parentMap.push({parent:z,child:S.id}))}}v.scenes.push(A)}}if(X=x.library_animations)if((W=X.animation)&&!W.length&&(W=[W]),W){y=0;for(V=W.length;y<V;y++){A=W[y];X=A["@id"];v.animations[X]=
{};v.animations[X].sources=[];(u=A.source)&&!u.length&&(u=[u]);if(u.length){K=0;for(D=u.length;K<D;K++){d=u[K];h=d["@id"];M=d.technique_common;B=F=null;d.name_array?F=e.textDelimArray(d.name_array.$," "):d.Name_array?F=e.textDelimArray(d.Name_array.$," "):d.float_array&&(B=e.floatDelimArray(d.float_array.$," "));d=0;H="";E=1;if(M)d=M,M=d.accessor,d=parseInt(M["@count"],10),H=M["@source"].substr(1),(M=M["@stride"])&&(E=parseInt(M,10));v.animations[X].sources[h]={data:F?F:B,count:d,source:H,stride:E};
if(E!==1)v.animations[X].sources[h].data=e.repackArray(v.animations[X].sources[h].data,E,d)}}(u=A.sampler)&&!u.length&&(u=[u]);if(u){v.animations[X].samplers=[];K=0;for(D=u.length;K<D;K++)if(h=u[K],F=h["@id"],(d=h.input)&&!d.length&&(d=[d]),d){E=[];B=0;for(h=d.length;B<h;B++)J=d[B],E[J["@semantic"]]=J["@source"].substr(1);v.animations[X].samplers[F]=E}}(K=A.channel)&&!K.length&&(K=[K]);if(K){v.animations[X].channels=[];A=0;for(u=K.length;A<u;A++)h=K[A],D=h["@source"].substr(1),h=h["@target"],F=h.split("/"),
d=F[0],F=F[1].split("."),v.animations[X].channels.push({source:D,target:h,targetName:d,paramName:F[0],typeName:F[1]})}}}if(x=x.scene)if(B=x.instance_visual_scene)x=B["@url"].substr(1),v.scene=x;return v}var q=y.undef,m=CubicVR.enums,f=y.GLCore,g=y.log,r={fixuaxis:function(g,a){if(g===0)return[a[1],a[0],a[2]];else if(g===1)return a;else if(g===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(g,a){if(g===0)return[a[1],a[0],a[2]];else if(g===1)return a;else if(g===2)return[a[0],a[2],a[1]]},fixukaxis:function(g,
a,c,b){if(a===m.motion.POS&&c===m.motion.Z&&g===m.motion.Z)return-b;return b},getAllOf:function(g,a){for(var c=[g],b=[],e,d,h,o;c.length;)for(d in e=c.pop(),e)if(e.hasOwnProperty(d)){if(d===a)if(e[d].length){h=0;for(o=e[d].length;h<o;h++)b.push(e[d][h])}else b.push(e[d]);if(typeof e[d]=="object")if(e[d].length){h=0;for(o=e[d].length;h<o;h++)c.push(e[d][h])}else c.push(e[d])}return b},quaternionFilterZYYZ:function(g,a){var c=CubicVR.vec3,b=g,e=new CubicVR.Quaternion;a!==q&&(b=c.add(g,a));e.fromEuler(b[0],
b[2],-b[1]);return e.toEuler()},cl_getInitalTransform:function(g,a){var c=CubicVR.util,b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=a.translate,d=a.rotate,h=a.scale;if(a.matrix&&!e&&!d&&!h)return b;if(e)b.position=r.fixuaxis(g,c.floatDelimArray(e.$," "));if(d)for(var e=0,o=d.length;e<o;e++){var z=d[e],v=z["@sid"],z=c.floatDelimArray(z.$," ");if(v=="rotateX"||v=="rotationX")b.rotation[0]=z[3];else if(v=="rotateY"||v=="rotationY")b.rotation[1]=z[3];else if(v=="rotateZ"||v=="rotationZ")b.rotation[2]=
z[3]}if(h)b.scale=r.fixscaleaxis(g,c.floatDelimArray(h.$," "));return b}};return{loadCollada:function(g,a,c){var a=x(g,a,c),b=a.up_axis,e=[],d,h,o,z,v,w,t,s;h=0;for(o=a.materials.length;h<o;h++){v=a.materials[h];t=new CubicVR.Material(v.mat);w=0;for(z=v.mat.textures_ref.length;w<z;w++){s=v.mat.textures_ref[w];var B=null,B=y.Textures_ref[s.image]===void 0?new CubicVR.Texture(s.image,f.default_filter,c,g):y.Textures_obj[y.Textures_ref[s.image]];t.setTexture(B,s.type)}e[v.id]=t}w=[];h=0;for(o=a.meshes.length;h<
o;h++){var B=a.meshes[h],I=new CubicVR.Mesh(B.id);I.points=B.points;var G=!1;t=0;for(s=B.parts.length;t<s;t++){var A=B.parts[t];A.material!==0&&((z=e[A.material])||(z=new CubicVR.Material({name:A.material})),I.setFaceMaterial(z));var u=A.normals.length?!0:!1,K=A.texcoords.length?!0:!1,D=A.colors.length?!0:!1;if(D)e[A.material].color_map=!0;z=0;for(v=A.faces.length;z<v;z++){var C=I.addFace(A.faces[z]);if(u)I.faces[C].point_normals=A.normals[z];if(K)I.faces[C].uvs=A.texcoords[z];if(D)I.faces[C].point_colors=
A.colors[z]}G|=u}I.faces.length&&(c?c.addMesh(g,g+":"+meshId,I):(G||I.calcNormals(),I.triangulateQuads(),I.compile()),w[B.id]=I)}o=[];g=0;for(z=a.cameras.length;g<z;g++)o[a.cameras[g].id]=a.cameras[g];B=[];z=0;for(v=a.lights.length;z<v;z++)B[a.lights[z].id]=a.lights[z];c={};e={};h={};g={};t=0;for(s=a.scenes.length;t<s;t++){I=a.scenes[t];G=new CubicVR.Scene;z=0;for(v=I.sceneObjects.length;z<v;z++)A=I.sceneObjects[z],u=new CubicVR.SceneObject(A),u.obj=(w[A.meshName]?w[A.meshName]:w[A.meshId])||null,
A.matrix&&u.setMatrix(A.matrix),c[A.id]=u,G.bindSceneObject(u);z=0;for(v=I.lights.length;z<v;z++)A=I.lights[z],u=new CubicVR.Light(B[A.source]),u.position=A.position,e[A.id]=u,G.bindLight(u);if(I.cameras.length)z=I.cameras[0],v=new CubicVR.Camera(o[z.source]),v.position=z.position,v.rotation=z.rotation,h[z.id]=v,G.camera=v;z=0;for(v=I.parentMap.length;z<v;z++)A=I.parentMap[z],c[A.parent].bindChild(c[A.child]);g[I.id]=G}for(var Z in a.animations)if(a.animations.hasOwnProperty(Z)&&(w=a.animations[Z],
w.channels.length)){cCount=0;for(z=w.channels.length;cCount<z;cCount++){o=w.channels[cCount];A=w.samplers[o.source];v=w.sources[A.INPUT];t=w.sources[A.OUTPUT];s=w.sources[A.INTERPOLATION];var B=w.sources[A.IN_TANGENT],I=w.sources[A.OUT_TANGENT],G=A.IN_TANGENT!==q,A=A.OUT_TANGENT!==q,u=null,D=c[o.targetName],K=h[o.targetName],L=e[o.targetName];if(D){if(D.motion===null)D.motion=new CubicVR.Motion;u=D.motion}else if(K){if(K.motion===null)K.motion=new CubicVR.Motion;u=K.motion}else if(L){if(L.motion===
null)L.motion=new CubicVR.Motion;u=L.motion}if(u!==null){D=m.motion.POS;C=m.motion.X;if(b===2)u.yzflip=!0;d=o.paramName;if(d==="rotateX"||d==="rotationX")D=m.motion.ROT,C=m.motion.X;else if(d==="rotateY"||d==="rotationY")D=m.motion.ROT,C=m.motion.Y;else if(d==="rotateZ"||d==="rotationZ")D=m.motion.ROT,C=m.motion.Z;else if(d==="location"){D=m.motion.POS;if(o.typeName==="X")C=m.motion.X;if(o.typeName==="Y")C=m.motion.Y;if(o.typeName==="Z")C=m.motion.Z}else if(d==="translate"){D=m.motion.POS;if(o.typeName===
"X")C=m.motion.X;if(o.typeName==="Y")C=m.motion.Y;if(o.typeName==="Z")C=m.motion.Z}else if(d==="LENS")continue;else if(d==="FOV")D=m.motion.FOV,C=3;else if(d==="ZNEAR")D=m.motion.NEARCLIP,C=3;else if(d==="ZFAR")D=m.motion.FARCLIP,C=3;else if(d==="intensity")D=m.motion.INTENSITY,C=3;if(L&&D<3)L.method=m.light.method.DYNAMIC;mCount=0;for(o=v.data.length;mCount<o;mCount++)if(k=null,typeof t.data[mCount]==="object"){i=0;for(iMax=t.data[mCount].length;i<iMax;i++)if(L=i,b===2&&i===2?L=1:b===2&&i===1&&(L=
2),k=u.setKey(D,L,v.data[mCount],r.fixukaxis(a.up_axis,D,L,t.data[mCount][i])),s)if(d=s.data[mCount][i],d==="LINEAR")k.shape=m.envelope.shape.LINE;else if(d==="BEZIER")k.shape=!G&&!A?m.envelope.shape.LINEAR:m.envelope.shape.BEZI}else if(L=C,ofs=0,K&&D===m.motion.ROT&&b===2&&L===0&&(ofs=-90),D===m.motion.ROT?k=u.setKey(D,L,v.data[mCount],t.data[mCount]+ofs):(b===2&&C===2?L=1:b===2&&C===1&&(L=2),k=u.setKey(D,L,v.data[mCount],r.fixukaxis(a.up_axis,D,L,t.data[mCount]))),s)if(d=s.data[mCount],d==="LINEAR")k.shape=
m.envelope.shape.LINE;else if(d==="BEZIER")if(!G&&!A)k.shape=m.envelope.shape.LINEAR,k.continutity=1;else{k.shape=m.envelope.shape.BEZ2;d=B.data[mCount][0];var E,F=I.data[mCount][0];D===m.motion.ROT?(E=B.data[mCount][1],L=I.data[mCount][1],k.param[0]=d-k.time,k.param[1]=E-k.value+ofs,k.param[2]=F-k.time,k.param[3]=L-k.value+ofs):(E=r.fixukaxis(a.up_axis,D,L,B.data[mCount][1]),L=r.fixukaxis(a.up_axis,D,L,I.data[mCount][1]),k.param[0]=d-k.time,k.param[1]=E-k.value,k.param[2]=F-k.time,k.param[3]=L-k.value)}}}}Z=
null;return Z=a.scene?g[a.scene]:g.pop()},parseCollada:x}});CubicVR.RegisterModule("CVRXML",function(y){function x(a,e,d,h){var o=CubicVR.util,z=null,g=null;h.triangles&&(g=o.intDelimArray(c.getTextNode(h,"triangles")," "));if(g&&(h.segments&&(z=o.intDelimArray(c.getTextNode(h,"segments")," ")),z===null&&(z=[0,parseInt(g.length/3,10)]),h=0,a.setFaceMaterial(e),g.length)){p=0;for(pMax=z.length;p<pMax;p+=2){e=z[p+1]*3;a.setSegment(z[p]);j=h;for(jMax=h+e;j<jMax;j+=3)o=a.addFace([g[j],g[j+1],g[j+2]]),d&&a.faces[o].setUV([d[j],d[j+1],d[j+2]]);h+=e}}}function q(a){var e=
CubicVR.util,d=new CubicVR.UVMapper,h=null,o=null;if(a.type)switch(h=c.getTextNode(a,"type"),h){case "planar":d.projection_mode=n.uv.projection.PLANAR;break;case "cylindrical":d.projection_mode=n.uv.projection.CYLINDRICAL;break;case "spherical":d.projection_mode=n.uv.projection.SPHERICAL;break;case "cubic":d.projection_mode=n.uv.projection.CUBIC}if(!h)return null;h==="uv"&&a.uv&&(o=c.getPoints(a,"uv"));if(a.axis)switch(c.getTextNode(a,"axis")){case "x":d.projection_axis=n.uv.axis.X;break;case "y":d.projection_axis=
n.uv.axis.Y;break;case "z":d.projection_axis=n.uv.axis.Z}if(a.center)d.center=e.floatDelimArray(c.getTextNode(a,"center"));if(a.rotation)d.rotation=e.floatDelimArray(c.getTextNode(a,"rotation"));if(a.scale)d.scale=e.floatDelimArray(c.getTextNode(a,"scale"));if(a.wrap_w)d.wrap_w_count=parseFloat(c.getTextNode(a,"wrap_w"));if(a.wrap_h)d.wrap_h_count=parseFloat(c.getTextNode(a,"wrap_h"));return h!==""&&h!=="uv"?d:o}function m(b,e){if(a[b]!==r)return a[b];var d=CubicVR.util,h,o,g,v;h=null;h=typeof b==
"object"?b:b.indexOf(".js")!=-1?d.getJSON(b):CubicVR.util.xml2badgerfish(d.getXML(b));if(h.root)h=h.root;if(h.properties)h=h.properties;d=new CubicVR.Mesh;h.points&&(g=c.getPoints(h,"points"))&&d.addPoint(g);var w=h.material;w&&!w.length&&(w=[w]);var t=[];if(w){h=0;for(g=w.length;h<g;h++){var s=w[h],f;f=s;var m=e,G=new CubicVR.Material(f.name?f.name.$:null);if(f.shininess)G.shininess=c.getFloatNode(f,"shininess",G.shininess)/100;G.opacity=c.getFloatNode(f,"alpha",G.opacity);G.max_smooth=c.getFloatNode(f,
"max_smooth",G.max_smooth);G.color=c.getFloatDelimNode(f,"color",G.color);G.ambient=c.getFloatDelimNode(f,"ambient",G.ambient);G.diffuse=c.getFloatDelimNode(f,"diffuse",G.diffuse);G.specular=c.getFloatDelimNode(f,"specular",G.specular);o=void 0;if(o=c.getTextNode(f,"texture"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.COLOR);if(o=c.getTextNode(f,"texture_luminosity"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:
new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.AMBIENT);if(o=c.getTextNode(f,"texture_normal"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.NORMAL);if(o=c.getTextNode(f,"texture_specular"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.SPECULAR);if(o=c.getTextNode(f,"texture_bump"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:
new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.BUMP);if(o=c.getTextNode(f,"texture_envsphere"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.ENVSPHERE);if(o=c.getTextNode(f,"texture_alpha"))o=(m?m:"")+o,tex=y.Textures_ref[o]!==r?y.Textures_obj[y.Textures_ref[o]]:new CubicVR.Texture(o),G.setTexture(tex,n.texture.map.ALPHA);f=G;var A=null;o=m=null;s.uvmapper&&((m=q(s.uvmapper))&&!m.length?t.push([m,f]):o=m);(G=s.part)&&
!G.length&&(G=[G]);if(G&&G.length){var u=null,K=null;o=0;for(v=G.length;o<v;o++){var D=G[o],u=null;if(A=D.uvmapper)if(u=q(A),s.triangles)K=A=d.faces.length,u&&!u.length?(x(d,f,null,D),K=d.faces.length-1,d.calcFaceNormals(A,K),u.apply(d,f,r,A,K)):u&&u.length?x(d,f,u,D):m&&!m.length&&(x(d,f,null,D),K=d.faces.length-1,d.calcFaceNormals(A,K),m.apply(d,f,r,A,K));if(D.procedural){(A=D.uvmapper)&&(u=q(A));var K=D.transform?c.getTransform(D.transform):r,A=r,D=D.procedural,C=c.getTextNode(D,"type");K&&(A=
new CubicVR.Transform,A.translate(K.position),A.pushMatrix(),A.rotate(K.rotation),A.pushMatrix(),A.scale(K.scale));m||(m=r);u={material:f,uvmapper:m||u};if(C==="box"||C==="cube")u.size=c.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.box(u),A);else if(C==="sphere")u.radius=c.getFloatNode(D,"radius"),u.lat=c.getIntNode(D,"lat"),u.lon=c.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.sphere(u),A);else if(C==="cone")u.base=c.getFloatNode(D,"base"),u.height=c.getFloatNode(D,"height"),u.lon=
c.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cone(u),A);else if(C==="plane")u.size=c.getFloatNode(D,"size"),d.booleanAdd(CubicVR.primitives.plane(u),A);else if(C==="cylinder")u.radius=c.getFloatNode(D,"radius"),u.height=c.getFloatNode(D,"height"),u.lon=c.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.cylinder(u),A);else if(C==="torus")u.innerRadius=c.getFloatNode(D,"innerRadius"),u.outerRadius=c.getFloatNode(D,"outerRadius"),u.lat=c.getIntNode(D,"lat"),u.lon=c.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.torus(u),
A);else if(C==="lathe")u.points=c.getPoints(D,"p"),u.lon=c.getIntNode(D,"lon"),d.booleanAdd(CubicVR.primitives.lathe(u),A);else if(C==="polygon"){K=c.getPoints(D,"p");K=new CubicVR.Polygon(K);(C=D.cut)&&!C.length&&(C=[C]);if(C.length){o=0;for(g=C.length;o<v;o++)K.cut(new CubicVR.Polygon(c.getPoints(C[o])))}u.front=0;u.back=0;u.frontShift=0;u.backShift=0;u.frontDepth=0;u.backDepth=0;if(D.extrude){D=D.extrude;u.front=c.getFloatNode(D,"front",0);u.back=c.getFloatNode(D,"back",0);u.frontShift=c.getFloatNode(D,
"frontBevelShift",0);u.backShift=c.getFloatNode(D,"backBevelShift",0);u.frontDepth=c.getFloatNode(D,"frontBevelDepth",0);u.backDepth=c.getFloatNode(D,"backBevelDepth",0);u.depth=c.getFloatNode(D,"depth",0);u.shift=c.getFloatNode(D,"shift",0);u.bevel=c.getFloatNode(D,"bevel",0);if(u.depth&&!u.backDepth&&!u.frontDepth)u.front=-u.depth/2,u.back=u.depth/2;if(u.shift&&!u.backShift&&!u.frontShift)u.frontShift=u.shift,u.backShift=u.shift;if(u.bevel&&!u.backDepth&&!u.frontDepth)u.frontDepth=u.bevel,u.backDepth=
u.bevel}D=K.toExtrudedBeveledMesh(new CubicVR.Mesh,u);D.setFaceMaterial(u.material);d.booleanAdd(D,A)}}}}else x(d,f,o,s)}}d.triangulateQuads();d.calcNormals();h=0;for(g=t.length;h<g;h++)t[h][0].apply(d,t[h][1]);d.compile();return a[b]=d}function f(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function g(a,c,d){var h=CubicVR.util,o=[];o[0]=a.getElementsByTagName("x");o[1]=
a.getElementsByTagName("y");o[2]=a.getElementsByTagName("z");o[3]=a.getElementsByTagName("fov");var g,v,w,t,s,f;for(f in o)if(o.hasOwnProperty(f)&&o[f]!==r&&o[f].length){g=o[f][0].getElementsByTagName("time");v=o[f][0].getElementsByTagName("value");w=o[f][0].getElementsByTagName("in");t=o[f][0].getElementsByTagName("out");s=o[f][0].getElementsByTagName("tcb");var m=null,q=null,A=null,u=a=null;w.length&&(a=h.collectTextNode(w[0]));t.length&&(u=h.collectTextNode(t[0]));g.length&&(m=h.floatDelimArray(h.collectTextNode(g[0]),
" "));v.length&&(q=h.floatDelimArray(h.collectTextNode(v[0])," "));s.length&&(A=h.floatDelimArray(h.collectTextNode(s[0])," "));if(m!==null&&q!==null){g=0;for(v=m.length;g<v;g++)if(w=d.setKey(c,f,m[g],q[g]),A)w.tension=A[g*3],w.continuity=A[g*3+1],w.bias=A[g*3+2]}q=m=n.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":m=n.envelope.behavior.RESET;break;case "constant":m=n.envelope.behavior.CONSTANT;break;case "repeat":m=n.envelope.behavior.REPEAT;break;case "oscillate":m=n.envelope.behavior.OSCILLATE;
break;case "offset":m=n.envelope.behavior.OFFSET;break;case "linear":m=n.envelope.behavior.LINEAR}if(u)switch(u){case "reset":q=n.envelope.behavior.RESET;break;case "constant":q=n.envelope.behavior.CONSTANT;break;case "repeat":q=n.envelope.behavior.REPEAT;break;case "oscillate":q=n.envelope.behavior.OSCILLATE;break;case "offset":q=n.envelope.behavior.OFFSET;break;case "linear":q=n.envelope.behavior.LINEAR}d.setBehavior(c,f,m,q)}}var r=y.undef,n=CubicVR.enums,a=[],c={getPoints:function(a,e,d){a=e?
c.getTextNode(a,e):a.$;if(!a)return r;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);d&&(a[i][2]=0)}return a},getTransform:function(a){var c=CubicVR.util;if(!a)return null;var d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},h;postition=a.position;h=a.rotation;a=a.scale;if(h)d.rotation=c.floatDelimArray(h.$);if(a)d.scale=c.floatDelimArray(a.$);if(h||a)return d;return null},getTextNode:function(a,c,d){a=a[c];
if(!a)return d;a.length&&(a=a[0]);if(a.$)return a.$;return d},getFloatNode:function(a,e,d){if(a=c.getTextNode(a,e)){a=parseFloat(a);if(a!=a)return d;return a}return d},getIntNode:function(a,e,d){if(a=c.getTextNode(a,e)){a=parseInt(a,10);if(a!=a)return d;return a}return d},getFloatDelimNode:function(a,e,d,h){var o=CubicVR.util;if(a=c.getTextNode(a,e))return o.floatDelimArray(a,h);return d},getIntDelimNode:function(a,e,d,h){var o=CubicVR.util;if(a=c.getTextNode(a,e))return o.intDelimArray(a,h);return d}};
return{loadMesh:m,loadScene:function(a,c,d){var h=CubicVR.util;c===r&&(c="");d===r&&(d="");for(var o=new CubicVR.Mesh,z=h.getXML(a),a=new CubicVR.Scene,v=[],w=z.getElementsByTagName("sceneobjects"),t,s,B,q=0,G=w[0].childNodes.length;q<G;q++){var A=w[0].childNodes[q];if(A.tagName==="sceneobject"){var u="unnamed",x="",D="",o=A.getElementsByTagName("name");o.length&&(u=h.collectTextNode(o[0]));o=A.getElementsByTagName("parent");o.length&&(x=h.collectTextNode(o[0]));o=A.getElementsByTagName("model");
o.length&&(D=h.collectTextNode(o[0]));B=s=t=null;o=A.getElementsByTagName("position");o.length&&(t=o[0]);o=A.getElementsByTagName("rotation");o.length&&(s=o[0]);o=A.getElementsByTagName("scale");o.length&&(B=o[0]);o=null;D!==""&&(o=m(c+D,d));o=new CubicVR.SceneObject(o,u);if(f(t)){if(!o.motion)o.motion=new CubicVR.Motion;g(t,n.motion.POS,o.motion)}else if(t)o.position=h.floatDelimArray(h.collectTextNode(t));if(f(s)){if(!o.motion)o.motion=new CubicVR.Motion;g(s,n.motion.ROT,o.motion)}else o.rotation=
h.floatDelimArray(h.collectTextNode(s));if(f(B)){if(!o.motion)o.motion=new CubicVR.Motion;g(B,n.motion.SCL,o.motion)}else o.scale=h.floatDelimArray(h.collectTextNode(B));a.bindSceneObject(o);x!==""&&v.push([o,x])}}for(var C in v)v.hasOwnProperty(C)&&a.getSceneObject(v[C][1]).bindChild(v[C][0]);c=z.getElementsByTagName("camera");if(c.length){s=t=null;d="";o=c[0].getElementsByTagName("name");C=a.camera;z=null;if(o.length)d=o[0].firstChild.nodeValue;o=c[0].getElementsByTagName("target");if(o.length)d=
o[0].firstChild.nodeValue;if(d!=="")C.targetSceneObject=a.getSceneObject(d);o=c[0].getElementsByTagName("position");o.length&&(t=o[0]);o=c[0].getElementsByTagName("rotation");o.length&&(s=o[0]);o=c[0].getElementsByTagName("fov");o.length&&(z=o[0]);if(f(t)){if(!C.motion)C.motion=new CubicVR.Motion;g(t,n.motion.POS,C.motion)}else if(t)C.position=h.floatDelimArray(t.firstChild.nodeValue);if(f(s)){if(!C.motion)C.motion=new CubicVR.Motion;g(s,n.motion.ROT,C.motion)}else if(s)C.rotation=h.floatDelimArray(s.firstChild.nodeValue);
if(f(z)){if(!C.motion)C.motion=new CubicVR.Motion;g(z,n.motion.FOV,C.motion)}else if(z)C.fov=parseFloat(z.firstChild.nodeValue)}return a}}});CubicVR.RegisterModule("Camera",function(y){function x(a,c,b,e,d){var h=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof a=="object"?(this.position=a.position?a.position:[0,0,0],this.rotation=a.rotation?a.rotation:[0,0,0],this.target=a.target?a.target:[0,0,0],this.fov=a.fov?a.fov:60,this.nearclip=a.nearclip?a.nearclip:0.1,this.farclip=a.farclip?a.farclip:400,this.targeted=a.targeted?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix?a.calcNormalMatrix:!0,this.name=a.name||"camera"+n,c=a.height?
a.height:f,a=a.width?a.width:f):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=b!==f?b:60,this.nearclip=e!==f?e:0.1,this.farclip=d!==f?d:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+n);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(a!==f?a:512,c!==f?c:512);this.mvMatrix=h.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=
null;++n}function q(a){this.position=a!==f?a:[0,0,0]}function m(a,c,b){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=a!==f?a:[8,8,8];this.target=c!==f?c:[0,0,0];this.bounds=b!==f?b:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var f=y.undef,g=CubicVR.enums,r=[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],n=0;x.prototype={trackTarget:function(a,c,b){this.position=CubicVR.vec3.trackTarget(this.position,a,c,b)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?CubicVR.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,c,b,e){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=
c;this.ortho_view.bottom=b;this.ortho_view.top=e},control:function(a,c,b){a===g.motion.ROT?this.rotation[c]=b:a===g.motion.POS?this.position[c]=b:a===g.motion.FOV?this.setFOV(b):a===g.motion.LENS?this.setLENS(b):a===g.motion.NEARCLIP?this.setClip(b,this.farclip):a===g.motion.FARCLIP&&this.setClip(this.nearclip,b)},makeFrustum:function(a,c,b,e,d,h){return[2*d/(c-a),0,0,0,0,2*d/(e-b),0,0,(c+a)/(c-a),(e+b)/(e-b),-(h+d)/(h-d),-1,0,0,-2*h*d/(h-d),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=
CubicVR.mat4,c=CubicVR.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent!==null&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),
this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),c.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,c){this.nearclip=a;this.farclip=c;this.calcProjection()},setDimensions:function(a,c){this.width=a;this.height=c;this.aspect=a/c;this.calcProjection()},resize:function(a,c){this.setDimensions(a,c)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*
Math.atan(16/a)*(180/Math.PI))},lookat:function(a,c,b,e,d,h,o,g,v){var w=CubicVR.mat4,t=CubicVR.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=w.lookat(a,c,b,e,d,h,o,g,v);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&w.multiply(this.mvMatrix.slice(0),w.inverse(this.parent.tMatrix),
this.mvMatrix);this.calc_nmatrix?(this.nMatrix=w.inverse_mat3(this.mvMatrix),t.transpose_inline(this.nMatrix)):this.nMatrix=r;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,c,b){var e=CubicVR.mat4,d=CubicVR.vec3,h=[0,0,this.width,this.height],a=e.vec4_multiply(e.vec4_multiply([(a-h[0])/h[2]*2-1,-((c-h[1])/h[3]*2-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(b!==f)return c=this.getParentedPosition(),d.add(c,d.multiply(d.normalize(d.subtract(a,
c)),b));return a},project:function(a,c,b){var e=CubicVR.mat4,e=e.vec4_multiply(e.vec4_multiply([a,c,b,1],this.mvMatrix),this.pMatrix);e[2]=CubicVR.vec3.length(CubicVR.vec3.subtract([a,c,b],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};q.prototype={control:function(a,c,b){a===g.motion.POS&&(this.position[c]=b)}};m.prototype={inBounds:function(a){var c=CubicVR.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&
a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var b=0,e=this.avoid_sphere.length;b<e;b++)if(c.length(a,this.avoid_sphere[b][0])<this.avoid_sphere[b][1])return!1;return!0},findNextNode:function(a,c){var b=CubicVR.vec3,e=[0,0,0],d=[0,0,0],h=e=0,o=!1;do if(d[0]=Math.random()-0.5,d[1]=Math.random()-0.5,d[2]=Math.random()-0.5,d=b.normalize(d),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,e=b.add(c.position,b.multiply(d,e)),o=this.inBounds(e),h++,h>30){e=c.position;
break}while(!o);return e},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var c=new q,b=new q;this.path_length&&this.camPath.apply(this.path_time-
this.segment_time*2,c);this.camPath.apply(this.path_time-this.segment_time,b);c=this.findNextNode(c,b);this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,c[0]);this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,c[1]);this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,c[2]);this.path_length++}c=new q;this.camPath.apply(a,c);return c.position},addSafeBound:function(a,c){this.safe_bb.push([a,c])},addAvoidSphere:function(a,c){this.avoid_sphere.push([a,c])}};return{Camera:x,AutoCamera:m}});CubicVR.RegisterModule("CollisionMap",function(){CubicVR.enums.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var y=function(x){this.shapes=[];this.result=null;if(x){x&&!x.length&&(x=[x]);for(var q=0,m=x.length;q<m;q++)this.addShape(x[q])}};y.prototype={addShape:function(x){x.position=x.position||[0,0,0];x.rotation=x.rotation||[0,0,0];x.size=x.size||[1,1,1];x.radius=x.radius||1;x.height=x.height||1;x.margin=x.margin||0;x.mesh=x.mesh||null;this.shapes.push(x)},
getShapes:function(){return this.shapes},setResult:function(x){this.result=x},getResult:function(){return this.result}};return{CollisionMap:y}});CubicVR.RegisterModule("GML",function(y){function x(m){var f=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==q){var m=f.getXML(m),g=m.getElementsByTagName("header");if(!g.length)return null;var r=g[0],g=m.getElementsByTagName("environment");if(!g.length)return null;this.name=null;r=r.getElementsByTagName("name");if(r.length)this.name=f.collectTextNode(r[0]);r=g[0].getElementsByTagName("screenBounds");if(r.length)this.bounds=
[parseFloat(f.collectTextNode(r[0].getElementsByTagName("x")[0])),parseFloat(f.collectTextNode(r[0].getElementsByTagName("y")[0])),parseFloat(f.collectTextNode(r[0].getElementsByTagName("z")[0]))];r=g[0].getElementsByTagName("origin");if(r.length)this.origin=[parseFloat(f.collectTextNode(r[0].getElementsByTagName("x")[0])),parseFloat(f.collectTextNode(r[0].getElementsByTagName("y")[0])),parseFloat(f.collectTextNode(r[0].getElementsByTagName("z")[0]))];g=g[0].getElementsByTagName("up");if(g.length)this.upvector=
[parseFloat(f.collectTextNode(g[0].getElementsByTagName("x")[0])),parseFloat(f.collectTextNode(g[0].getElementsByTagName("y")[0])),parseFloat(f.collectTextNode(g[0].getElementsByTagName("z")[0]))];m=m.getElementsByTagName("drawing");g=0;for(r=m.length;g<r;g++)for(var n=m[g].getElementsByTagName("stroke"),a=0,c=0,b=0,e=0,d=0,h=n.length;d<h;d++){for(var o=n[d].getElementsByTagName("pt"),z=o.length,v=Array(z),w,t,s,B=0,I=z;B<I;B++)s=o[B],z=parseFloat(f.collectTextNode(s.getElementsByTagName("x")[0])),
w=parseFloat(f.collectTextNode(s.getElementsByTagName("y")[0])),t=parseFloat(f.collectTextNode(s.getElementsByTagName("z")[0])),s=parseFloat(f.collectTextNode(s.getElementsByTagName("time")[0])),this.upvector[0]===1?v[B]=[w!==w?0:w,z!==z?0:-z,t!==t?0:t,s]:this.upvector[1]===1?v[B]=[z!==z?0:z,w!==w?0:w,t!==t?0:t,s]:this.upvector[2]===1&&(v[B]=[z!==z?0:z,t!==t?0:-t,w!==w?0:w,s]),a<z&&(a=z),c<w&&(c=w),b<t&&(b=t),e<s&&(e=s);if(b>e){o=0;for(B=v.length;o<B;o++)z=v[o][3],v[o][3]=v[o][2],v[o][2]=z/this.bounds[2]}this.strokes[d]=
v}}}var q=y.undef;x.prototype={addStroke:function(m,f){var g=[];f===q&&(f=0.1);for(var r=0,n=m.length;r<n;r++){var a=[m[r][0],m[r][1],m[r][2]];this.manual_pos+=f;a.push(this.manual_pos);g.push(a)}this.strokes.push(g)},recenter:function(){var m=CubicVR.vec3,f=[0,0,0],g=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],r,n,a,c;a=0;for(c=this.strokes.length;a<c;a++){r=0;for(n=this.strokes[a].length;r<n;r++)f[0]>this.strokes[a][r][0]&&(f[0]=this.strokes[a][r][0]),f[1]>this.strokes[a][r][1]&&
(f[1]=this.strokes[a][r][1]),f[2]>this.strokes[a][r][2]&&(f[2]=this.strokes[a][r][2]),g[0]<this.strokes[a][r][0]&&(g[0]=this.strokes[a][r][0]),g[1]<this.strokes[a][r][1]&&(g[1]=this.strokes[a][r][1]),g[2]<this.strokes[a][r][2]&&(g[2]=this.strokes[a][r][2])}m=m.multiply(m.subtract(g,f),0.5);a=0;for(c=this.strokes.length;a<c;a++){r=0;for(n=this.strokes[a].length;r<n;r++)this.strokes[a][r][0]-=m[0],this.strokes[a][r][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[a][r][2]-=m[2]}},generateObject:function(m,
f,g,r,n){var a=CubicVR.vec3;m===q&&(m=0);f===q&&(f=0);n===q&&(n=!1);r===q&&(r=0.02);g===q&&(g=0.015);for(var c=f!==0,b=0,e=0,d=new CubicVR.Mesh(this.name),h,o,z,v,w,t,s=0,B=this.strokes.length;s<B;s++){t=new CubicVR.Envelope;var I=new CubicVR.Envelope,G=new CubicVR.Envelope,A=this.strokes[s].length,u=0,x=[],D=[],C=0,y=this.strokes[s];for(w=0;w<A;w++){var L=y[w],E=t.addKey(L[3],L[0]),F=I.addKey(L[3],L[1]),H;H=n?G.addKey(L[3],L[2]):G.addKey(L[3],0);E.tension=0.5;F.tension=0.5;H.tension=0.5;w!==0?(h=
L[0]-h,o=L[1]-o,z=L[2]-z,v=L[3]-v,z=Math.sqrt(h*h+o*o+z*z),u+=z,x[w-1]=z,D[w-1]=v):C=L[3];h=L[0];o=L[1];z=L[2];v=L[3]}u=C;A=d.points.length;for(w=0;w<x.length;w++){C=D[w];y=u;L=u+C;for(E=C/Math.ceil(x[w]/r*3);y<L-E;y+=E){y===u&&(h=t.evaluate(y),o=I.evaluate(y),z=G.evaluate(y));var O,F=t.evaluate(y+E);H=I.evaluate(y+E);O=G.evaluate(y+E);var J;J=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([F-h,H-o,O-z]))),g/2);d.addPoint([h-J[0],-(o-J[1]),z-J[2]+(c?f/2:0)]);d.addPoint([h+J[0],-(o+J[1]),
z+J[2]+(c?f/2:0)]);h=F;o=H;z=O}u+=C}I=d.points.length;if(c){w=A;for(t=I;w<t;w++)d.addPoint([d.points[w][0],d.points[w][1],d.points[w][2]-(c?f/2:0)])}w=0;for(t=I-A;w<=t-4;w+=2)b%m===0&&e++,d.setSegment(e),G=[A+w,A+w+1,A+w+3,A+w+2],d.addFace(G),c&&(G=[G[3]+I-A,G[2]+I-A,G[1]+I-A,G[0]+I-A],d.addFace(G),G=[A+w,A+w+2,A+w+2+I-A,A+w+I-A],d.addFace(G),G=[A+w+1+I-A,A+w+3+I-A,A+w+3,A+w+1],d.addFace(G),w===0&&(G=[A+w+I-A,A+w+1+I-A,A+w+1,A+w],d.addFace(G)),w===t-4&&(G=[A+w+2,A+w+3,A+w+3+I-A,A+w+2+I-A],d.addFace(G))),
b++}d.calcFaceNormals();d.triangulateQuads();d.calcNormals();d.compile();return d}};return{GML:x}});CubicVR.RegisterModule("Landscape",function(y){function x(g,f,n,a){this.doTransform=function(){};this.tMatrix=m;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=g;this.divisions_w=f;this.divisions_h=n;this.matRef=a;this.children=null;this.obj=new CubicVR.Mesh;this.divisions_w>this.divisions_h?(this.size_w=g,this.size_h=g/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?g/this.divisions_h*this.divisions_w:g,this.size_h=g);for(f=-(this.size_h/2);f<
this.size_h/2;f+=this.size_h/this.divisions_h)for(g=-(this.size_w/2);g<this.size_w/2;g+=this.size_w/this.divisions_w)this.obj.addPoint([g+this.size_w/this.divisions_w/2,0,f+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(f=0;f<this.divisions_h-1;f++)for(g=0;g<this.divisions_w-1;g++)this.obj.addFace([g+(f+1)*this.divisions_w,g+1+f*this.divisions_w,g+f*this.divisions_w]),this.obj.addFace([g+(f+1)*this.divisions_w,g+1+(f+1)*this.divisions_w,g+1+f*this.divisions_w])}var q=y.undef,
m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=Math.PI/2;x.prototype={getMesh:function(){return this.obj},setIndexedHeight:function(g,f,m){obj.points[g+f*this.divisions_w][1]=m},mapGen:function(g,f,m,a,c){if(f!==q&&m!==q&&a!==q&&c!==q){if(!(f>=this.divisions_w)&&!(m>=this.divisions_h)&&(f+a>=this.divisions_w&&(a=this.divisions_w-1-f),m+c>=this.divisions_h&&(c=this.divisions_h-1-m),!(a<=0||c<=0)))for(var b=f,a=f+a;b<a;b++)for(var e=m,d=m+c;e<d;e++)f=this.obj.points[b+e*this.divisions_w],f[1]=g(f[0],f[2])}else{m=
0;for(c=this.obj.points.length;m<c;m++)f=this.obj.points[m],f[1]=g(f[0],f[2])}},getFaceAt:function(g,f){if(typeof g==="object")return this.getFaceAt(g[0],g[2]);var m=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((g+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),m=parseInt(Math.floor((f+m)/this.size_h*this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(m<0)return-1;if(m>=this.divisions_h-1)return-1;var a=parseInt(a+m*(this.divisions_w-
1),10)*2,m=parseInt(a+1,10),c=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(f-c[2])/Math.abs(g-c[0])>=1?a:m},getHeightValue:function(g,f){var m=CubicVR.triangle;if(typeof g==="object")return this.getHeightValue(g[0],g[2]);var a,c=this.getFaceAt(g,f);if(c===-1)return 0;a=this.obj.points[this.obj.faces[c].points[0]];var b=m.normal(this.obj.points[this.obj.faces[c].points[0]],this.obj.points[this.obj.faces[c].points[1]],this.obj.points[this.obj.faces[c].points[2]]),m=b[0],c=b[1],b=b[2];
return(m*g+b*f+(-(m*a[0])-c*a[1]-b*a[2]))/-c},orient:function(g,m,n,a,c,b){b===q&&(b=0);var e,d,h=[];e=n/2;var o=a/2;d=Math.sqrt(o*o+e*e);o=Math.atan2(o,e);c*=Math.PI/180;e=g+Math.sin(c)*b;b=m+Math.cos(c)*b;h[0]=this.getHeightValue([e+d*Math.cos(-o-f+c),0,b+d*-Math.sin(-o-f+c)]);h[1]=this.getHeightValue([e+d*Math.cos(o-f+c),0,b+d*-Math.sin(o-f+c)]);h[2]=this.getHeightValue([e+d*Math.cos(-o+f+c),0,b+d*-Math.sin(-o+f+c)]);h[3]=this.getHeightValue([e+d*Math.cos(o+f+c),0,b+d*-Math.sin(o+f+c)]);d=-Math.atan2(h[1]-
h[2],n);b=-Math.atan2(h[0]-h[1],a);d+=-Math.atan2(h[0]-h[3],n);b+=-Math.atan2(h[3]-h[2],a);d/=2;b/=2;return[[g,(h[2]+h[3]+h[1]+h[0])/4,m],[d*(180/Math.PI),c,b*(180/Math.PI)]]}};return{Landscape:x}});CubicVR.RegisterModule("Layout",function(){function y(q){this.texture=q.texture?q.texture:null;this.width=q.width?q.width:128;this.height=q.height?q.height:128;this.x=q.x?q.x:0;this.y=q.y?q.y:0;this.blend=q.blend?q.blend:!1;this.opacity=typeof q.opacity!=="undefined"?q.opacity:1;this.tint=q.tint?q.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function x(q){this.texture=q.texture?q.texture:null;this.width=q.width?q.width:128;this.height=q.height?q.height:128;
this.x=q.x?q.x:0;this.y=q.y?q.y:0;this.blend=q.blend?q.blend:!1;this.opacity=typeof q.opacity!=="undefined"?q.opacity:1;this.tint=q.tint?q.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}y.prototype={addSubview:function(q){this.childViews.push(q);q.superView=this},makePanel:function(q){return this.superView.makePanel(q)}};x.prototype={resize:function(q,m){this.width=q;this.height=m},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(q){q.setInt("srcTex",0);q.addVector("screen");q.addVector("position");q.addVector("tint");q.addVector("size")}})},addSubview:function(q){this.childViews.push(q);q.superView=this},removeSubview:function(q){q=this.childViews.indexOf(q);q>-1&&this.childViews.splice(q,
1)},makePanel:function(q){var m=CubicVR.GLCore.gl,f={};f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);f.gl_points=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,f.gl_points);m.bufferData(m.ARRAY_BUFFER,f.vbo_points,m.STATIC_DRAW);f.gl_uvs=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,f.gl_uvs);m.bufferData(m.ARRAY_BUFFER,f.vbo_uvs,m.STATIC_DRAW);q.panel=f},renderPanel:function(q){if(!q.texture)return!1;q.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(q){if(q.texture){var m=CubicVR.GLCore.gl,f=q.offsetLeft,g=q.offsetTop;f||(f=0);g||(g=0);var r=this.shader.shader;r.use();r.setVector("screen",[this.width,this.height,0]);r.setVector("position",[q.x+f,q.y+g,0]);r.setVector("size",[q.width,q.height,0]);r.setVector("tint",q.tint);q.blend&&(m.enable(m.BLEND),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA));q.texture.use(m.TEXTURE0);m.drawArrays(m.TRIANGLES,0,6);q.blend&&(m.disable(m.BLEND),m.blendFunc(m.ONE,m.ZERO))}},render:function(){var q=
CubicVR.GLCore.gl;q.disable(q.DEPTH_TEST);this.texture&&this.renderView(this);var m=[];this.offsetTop=this.offsetLeft=0;m.push(this);var f=this.shader.shader;f.use();q.bindBuffer(q.ELEMENT_ARRAY_BUFFER,null);q.bindBuffer(q.ARRAY_BUFFER,this.panel.gl_points);q.vertexAttribPointer(f.uniforms.aVertex,3,q.FLOAT,!1,0,0);q.enableVertexAttribArray(f.uniforms.aVertex);q.bindBuffer(q.ARRAY_BUFFER,this.panel.gl_uvs);q.vertexAttribPointer(f.uniforms.aTex,2,q.FLOAT,!1,0,0);q.enableVertexAttribArray(f.uniforms.aTex);
for(q.bindBuffer(q.ELEMENT_ARRAY_BUFFER,null);m.length;){var g=m.pop();this.renderView(g);if(g.childViews.length)for(var r=g.childViews.length-1;r>=0;r--)g.childViews[r].offsetLeft=g.x+g.offsetLeft,g.childViews[r].offsetTop=g.y+g.offsetTop,m.push(g.childViews[r])}q.disableVertexAttribArray(f.uniforms.aTex);q.enable(q.DEPTH_TEST)}};return{Layout:x,View:y}});CubicVR.RegisterModule("Light",function(y){function x(a,c){var b=CubicVR.aabb,a=g.getJSONScriptObj(a,function(a){a.type=n[a.type];a.method=n[a.method]})||{};if(a===f)a=m.light.type.POINT;if(c===f)c=m.light.method.DYNAMIC;typeof a=="object"?(this.light_type=a.type!==f?a.type:m.light.type.POINT,this.diffuse=a.diffuse!==f?a.diffuse:[1,1,1],this.specular=a.specular!==f?a.specular:[1,1,1],this.intensity=a.intensity!==f?a.intensity:1,this.position=a.position!==f?a.position:[0,0,0],this.direction=a.direction!==
f?a.direction:[0,0,0],this.distance=a.distance!==f?a.distance:this.light_type===m.light.type.AREA?30:10,this.cutoff=a.cutoff!==f?a.cutoff:60,this.map_res=a.map_res!==f?a.map_res:this.light_type===m.light.type.AREA?2048:512,this.map_res=a.mapRes!==f?a.mapRes:this.map_res,this.method=a.method!==f?a.method:c,this.areaCam=a.areaCam!==f?a.areaCam:null,this.areaCeiling=a.areaCeiling!==f?a.areaCeiling:40,this.areaFloor=a.areaFloor!==f?a.areaFloor:-40,this.areaAxis=a.areaAxis!==f?a.areaAxis:[1,1,0],this.projectorTex=
a.projector!==f?a.projector:null):(this.light_type=a,this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===m.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===m.light.type.AREA?2048:512,this.method=c,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=
null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];b.reset(this.aabb,this.position);this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA&&y.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=
null}var q=y.GLCore,m=CubicVR.enums,f=y.undef,g=CubicVR.util,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];m.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};var n={"null":m.light.type.NULL,point:m.light.type.POINT,directional:m.light.type.DIRECTIONAL,spot:m.light.type.SPOT,area:m.light.type.AREA,depth_pack:m.light.type.DEPTH_PACK,spot_shadow:m.light.type.SPOT_SHADOW,spot_shadow_projector:m.light.type.SPOT_SHADOW_PROJECTOR,
global:m.light.method.GLOBAL,"static":m.light.method.STATIC,dynamic:m.light.method.DYNAMIC};x.prototype={setType:function(a){if(a===m.light.type.AREA&&!y.features.lightShadows)this.dummyCam=new CubicVR.Camera,this.areaCam=new CubicVR.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,a=m.light.type.DIRECTIONAL;else if((a===m.light.type.SPOT_SHADOW||a===m.light.type.SPOT_SHADOW_PROJECTOR)&&!y.features.lightShadows)a=m.light.type.SPOT;this.light_type=a},setParent:function(a){this.parent=
a},setMethod:function(a){this.method=a},setDiffuse:function(a){this.diffuse=a},setSpecular:function(a){this.specular=a},setIntensity:function(a){this.intensity=a},setPosition:function(a){this.position=a},setDistance:function(a){this.distance=a},setCutoff:function(a){this.cutoff=a},prepare:function(a){var c=CubicVR.mat4,b=CubicVR.mat3,e=this.light_type;if(this.parent)if(e===m.light.type.SPOT||e===m.light.type.SPOT_SHADOW||e===m.light.type.SPOT_SHADOW_PROJECTOR)e=c.inverse_mat3(this.parent.tMatrix),
b.transpose_inline(e),this.lDir=b.vec3_multiply(this.direction,e),this.lDir=b.vec3_multiply(this.lDir,a.nMatrix),this.lPos=c.vec3_multiply(this.position,c.multiply(a.mvMatrix,this.parent.tMatrix));else{if(e===m.light.type.POINT)this.lPos=c.vec3_multiply(this.position,c.multiply(a.mvMatrix,this.parent.tMatrix))}else if(e===m.light.type.DIRECTIONAL)this.lDir=b.vec3_multiply(this.direction,a.nMatrix);else if(e===m.light.type.SPOT||e===m.light.type.SPOT_SHADOW||e===m.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=
b.vec3_multiply(this.direction,a.nMatrix),this.lPos=c.vec3_multiply(this.position,a.mvMatrix);else if(e===m.light.type.POINT)this.lPos=c.vec3_multiply(this.position,a.mvMatrix);else if(e===m.light.type.AREA)this.lDir=b.vec3_multiply(this.direction,a.nMatrix)},control:function(a,c,b){if(a===m.motion.POS)this.position[c]=b;else if(a===m.motion.INTENSITY)this.intensity=b},getAABB:function(){var a=CubicVR.vec3,c=CubicVR.aabb,b=[[0,0,0],[0,0,0]];c.engulf(b,[this.distance,this.distance,this.distance]);
c.engulf(b,[-this.distance,-this.distance,-this.distance]);b[0]=a.add(b[0],this.position);b[1]=a.add(b[1],this.position);return this.aabb=b},setDirection:function(a,c,b){var e=CubicVR.vec3;if(typeof a==="object")this.setDirection(a[0],a[1],a[2]);else return this.direction=e.normalize([a,c,b]),this},lookat:function(a,c,b){var e=CubicVR.vec3;if(typeof a==="object")this.lookat(a[0],a[1],a[2]);else return this.direction=e.normalize(e.subtract([a,c,b],this.position)),this},setRotation:function(a,c,b){var e=
CubicVR.mat4,d=CubicVR.vec3;if(typeof a==="object")this.setRotation(a[0],a[1],a[2]);else{var h=new CubicVR.Transform;h.rotate([-a,-c,-b]);h.pushMatrix();this.direction=d.normalize(e.vec3_multiply([1,0,0],h.getResult()));this.rotation=[a,c,b];return this}},setupShader:function(a,c){var b=q.gl;b.uniform3fv(a.lDiff[c],this.diffuse);b.uniform3fv(a.lSpec[c],this.specular);this.lPos&&b.uniform3fv(a.lPos[c],this.lPos);this.lDir&&b.uniform3fv(a.lDir[c],this.lDir);b.uniform1f(a.lInt[c],this.intensity);b.uniform1f(a.lDist[c],
this.distance);(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.SPOT)&&b.uniform1f(a.lCut[c],this.cutoff);if(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA)this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(q.gl.TEXTURE0+c*2),b.uniform1i(a.lDepthTex[c],c*2),this.projectorTex.use(q.gl.TEXTURE0+c*2+1),
b.uniform1i(a.lProjTex[c],c*2+1)):(this.shadowMapTex.texture.use(q.gl.TEXTURE0+c),b.uniform1i(a.lDepthTex[c],c)),b.uniform3fv(a.lDepth[c],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),b.uniformMatrix4fv(a.spMatrix[c],!1,this.spMatrix)},setShadow:function(a){if(y.features.lightShadows)this.map_res=a,this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(m.texture.filter.NEAREST),this.dummyCam=new CubicVR.Camera(this.map_res,this.map_res,
80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},setProjector:function(a){this.projectorTex=a},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var a=q.gl,c=CubicVR.mat4,b=CubicVR.mat3;this.shadowMapTex.use();a.viewport(0,0,this.map_res,this.map_res);a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT);this.light_type!==m.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),
this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var e=c.inverse_mat3(this.parent.tMatrix);b.transpose_inline(e);b.vec3_multiply(this.direction,e);c.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);c.multiply(this.dummyCam.mvMatrix.slice(0),c.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],
this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);a.cullFace(a.FRONT)},shadowEnd:function(){var a=q.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.cullFace(a.BACK);this.setupTexGen()},setupTexGen:function(){var a=CubicVR.mat4;this.spMatrix=a.multiply(r,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=a.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=a.multiply(this.spMatrix,
this.dummyCam.mvMatrix)},setAreaAxis:function(a){this.areaAxis=a},updateAreaLight:function(){var a=CubicVR.vec3,c=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var b=0,b=Math.tan(this.areaCam.fov/2*(Math.PI/180)),e=a.subtract(this.areaCam.target,this.areaCam.position);e[1]=0;e=a.normalize(e);a.normalize(a.cross(e,[0,1,0]));var d=-Math.atan2(e[2],e[0]),b=this.distance/2*Math.abs(b)-this.distance/2;b<this.distance/3/2&&(b=this.distance/3/2);e=a.multiply(e,b);b=
[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];d-=Math.atan2(b[0],b[2]);this.position=a.add(a.add(this.areaCam.position,e),a.multiply(b,c));this.position[1]=this.areaCeiling;this.target=a.add(a.add(this.areaCam.position,e),a.multiply(b,-c));this.target[1]=this.areaFloor;this.direction=a.normalize(a.subtract(this.target,this.position));this.dummyCam.rotation[2]=d*(180/Math.PI);a=this.dummyCam.nearclip;c=this.dummyCam.farclip*Math.abs(this.direction[1])*c;a=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);a=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);a[1][1]>this.areaFloor&&(a=a[1][1]-this.areaFloor,c+=a/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=c;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(a,c,b,e,d,h){var e=CubicVR.vec3,
o=e.normalize([d[0],d[4],d[8]]),g=e.normalize([d[1],d[5],d[9]]),d=e.normalize(e.cross(g,o)),v;v=b/2;b=[];c=e.multiply(o,c/2);o=e.multiply(g,v);h=e.multiply(d,h);b[0]=e.add(e.subtract(a,c),e.add(o,h));b[1]=e.add(e.add(a,c),e.add(o,h));b[2]=e.subtract(e.subtract(a,c),e.add(o,h));b[3]=e.subtract(e.add(a,c),e.add(o,h));aabb1=b[0];aabb2=b[0];for(a=1;a<4;a++)aabb1[0]>b[a][0]&&(aabb1[0]=b[a][0]),aabb1[1]>b[a][1]&&(aabb1[1]=b[a][1]),aabb1[2]>b[a][2]&&(aabb1[2]=b[a][2]),aabb2[0]<b[a][0]&&(aabb2[0]=b[a][0]),
aabb2[1]<b[a][1]&&(aabb2[1]=b[a][1]),aabb2[2]<b[a][2]&&(aabb2[2]=b[a][2]);return[aabb1,aabb2]}};return{Light:x}});CubicVR.RegisterModule("MainLoop",function(y){function x(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function q(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(q),CubicVR.GLCore.mainloop.interval())}function m(a,c,b){if(window.requestAnimationFrame===g)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(a===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],d=new x;d.start();this.timer=d;this.func=a;this.doclear=c!==g?c:!0;CubicVR.GLCore.mainloop=this;if(n.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;c=function(){return function(){var c=CubicVR.GLCore.gl;d.update();CubicVR.GLCore.mainloop.doclear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);a(d,CubicVR.GLCore.gl);var b=e[e.length-1],g=b.scenes;b.update&&b.update(d,c);if(g){c=0;for(b=g.length;c<b;++c){var v=g[c];v.paused||(v.update&&v.update(d,CubicVR.GLCore.gl),v.render())}}}}();b?this.loopFunc=c:window.requestAnimationFrame?(this.interval=c,window.requestAnimationFrame(q)):
this.interval=setInterval(c,20)}}function f(a,c,b){this.canvas=a;this.camera=c;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var d in r.keyboard)this.keyState[d]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];
e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var d=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d[0]=a[0]-e.mpos[0];d[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,d,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=
a.keyCode,d=null;e.mEvents.keyPress?(d=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=d!==g?!!d:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(d=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=d!==g?!!d:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,d,c){a.mdown&&a.orbitView(c)},mouseWheel:function(a,d,c){a.zoomView(c)},mouseDown:null,mouseUp:null,
keyDown:null,keyUp:null,keyPress:null};b!==!1&&this.setEvents(b===g?this.eventDefaults:b);this.bind()}var g=y.undef,r=CubicVR.enums,n=y.GLCore;r.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,
KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,
SEMICOLON:186,EQUALS:187,COMMA:188,DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};x.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(){this.lock_rate=1/this.f_rate;
this.lock_state=!0},unlock:function(){var a=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=lock_rate*1E3|0:this.system_milliseconds=Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);
this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(a*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-
this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};m.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},
resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var c=0;c<a.scenes.length;++c)a.scenes[c].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],c=0;c<a.scenes.length;++c)a.scenes[c].disable();this.renderStack.length>1&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var c=
renderStack[renderStack.length-1],b,e=0,d=c.scenes.length;e<d;++e)if(c.scenes[e].scene.name===a){b=c.scenes[e];break}return b},resumeScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var c=renderStack[renderStack.length-1];typeof a==="string"&&(a=this.getScene(a));var b=c.scenes.indexOf(a);b>-1&&c.scenes.splice(b,1);return a},runOnce:function(){this.loopFunc()}};
f.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents={};for(var c in a)this.bindEvent(c,a[c])},orbitView:function(a){var c=CubicVR.vec3,b=c.subtract(this.camera.target,this.camera.position),b=c.length(b);this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-b*a[0]/300,0);this.camera.position[1]+=b*a[1]/300;this.camera.position=c.add(this.camera.target,c.multiply(c.normalize(c.subtract(this.camera.position,this.camera.target)),
b))},panView:function(a,c){var b=CubicVR.vec3;c||(c=!1);var e=b.subtract(this.camera.target,this.camera.position),e=b.length(e),d=this.camera.position;c?this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,-e*a[1]/300):(this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0),this.camera.position[1]+=e*a[1]/300);e=b.subtract(this.camera.position,d);this.camera.target=b.add(this.camera.target,e)},zoomView:function(a,c,b){var e=
CubicVR.vec3,d=e.subtract(this.camera.target,this.camera.position),d=e.length(d);d-=a/1E3;c||(c=0.1);b||(b=1E3);d<c&&(d=c);d>b&&(d=b);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),d))},bindEvent:function(a,c){this.mEvents[a]=c===g?this.eventDefaults[a]:c},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,
!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,
!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:x,MainLoop:m,MouseViewController:f,setMainLoop:function(a){CubicVR.GLCore.mainloop=a}}});CubicVR.RegisterModule("Texture",function(y){function x(a){var d=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var c=this.canvasSource,b=c.width,c=c.height,g=!0;if(b===
1||c===1)g=!1;else{if(b!==1)for(;b%2===0;)b/=2;if(c!==1)for(;c%2===0;)c/=2;b>1&&(g=!1);c>1&&(g=!1)}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;g?(this.setFilter(n.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(n.texture.filter.LINEAR),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function q(a,d,c){var b=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=d;this.canvas.height=c;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;d=this.canvas.height;c=!0;if(a===1||d===1)c=!1;else{if(a!==1)for(;a%
2===0;)a/=2;if(d!==1)for(;d%2===0;)d/=2;a>1&&(c=!1);d>1&&(c=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;c?this.setFilter(n.texture.filter.LINEAR_MIP):(this.setFilter(n.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))}function m(a,d,c){var b=r.gl;this.width=d;this.height=c;this.srcTex=
a;this.outTex=new CubicVR.RenderBuffer(d,c);var a=d,g=c;if(!(a===1||g===1)){if(a!==1)for(;a%2===0;)a/=2;if(g!==1)for(;g%2===0;)g/=2}a=[1/d,1/c,0];this.outputBuffer=new CubicVR.RenderBuffer(d,c,!1);this.fsQuad=CubicVR.fsQuad.make(d,c);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(b.TEXTURE0);this.setFilter(n.texture.filter.LINEAR);
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)}function f(a,d,c){var b=r.gl;this.width=a;this.height=d;this.outTex=new CubicVR.RenderBuffer(a,d,c);this.texture=this.outTex.texture;var g=a,v=d,f=!0;if(g===1||v===1)f=!1;else{if(g!==1)for(;g%2===0;)g/=2;if(v!==1)for(;v%2===0;)v/=2;g>1&&(f=!1);v>1&&(f=!1)}this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;
this.filterType=this.outTex.texture.filterType;this.texture.use(b.TEXTURE0);f?(this.setFilter(n.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)):(this.setFilter(n.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE));this.dims=[a,d];this.depth=c?!0:!1}function g(a,d){this.scene=a;this.renderTex=new f(d?d.width:a.camera.width,
d?d.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var r=y.GLCore,n=CubicVR.enums,a=y.undef;n.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var c=function(a,d){this.img_path=a;this.filter_type=d};c.prototype=
{getTexture:function(a,d){return new b(this.img_path,this.filter_type,a,d)}};var b=function(c,d,b,o,g){var v=r.gl;this.tex_id=y.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;y.Textures[this.tex_id]=v.createTexture();y.Textures_obj[this.tex_id]=this;if(c)typeof c==="string"?y.Images[this.tex_id]=new Image:typeof c==="object"&&c.nodeName==="IMG"&&(y.Images[this.tex_id]=c),y.Textures_ref[c]=this.tex_id;v.bindTexture(v.TEXTURE_2D,y.Textures[this.tex_id]);v.texParameteri(v.TEXTURE_2D,
v.TEXTURE_MAG_FILTER,v.LINEAR);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.LINEAR);if(c){var f=this.tex_id,t=d!==a?d:r.default_filter,m=this;y.Images[this.tex_id].onload=function(){v.bindTexture(v.TEXTURE_2D,y.Textures[f]);v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!0);v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.NONE);var a=y.Images[f];v.texImage2D(v.TEXTURE_2D,0,v.RGBA,v.RGBA,v.UNSIGNED_BYTE,a);var d=a.width,a=a.height,c=!0;if(d===1||a===1)c=!1;else{if(d!==1)for(;d%2===0;)d/=2;if(a!==1)for(;a%
2===0;)a/=2;d>1&&(c=!1);a>1&&(c=!1)}c||(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE));if(y.Textures_obj[f].filterType===-1){if(!c&&t===n.texture.filter.LINEAR_MIP)t=n.texture.filter.LINEAR;y.Textures_obj[f].filterType===-1&&y.Textures_obj[f].setFilter(t)}else y.Textures_obj[f].setFilter(y.Textures_obj[f].filterType);v.bindTexture(v.TEXTURE_2D,null);if(m.onready)m.onready();m.loaded=!0};if(b)y.Images[this.tex_id].deferredSrc=
c,b.addImage(o,c,y.Images[this.tex_id]);else if(typeof c==="string")y.Images[this.tex_id].src=c}this.active_unit=-1};b.prototype={setFilter:function(a){var d=CubicVR.GLCore.gl;d.bindTexture(d.TEXTURE_2D,y.Textures[this.tex_id]);a===n.texture.filter.LINEAR?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR)):a===n.texture.filter.LINEAR_MIP?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,
d.LINEAR_MIPMAP_NEAREST),d.generateMipmap(d.TEXTURE_2D)):a===n.texture.filter.NEAREST?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST)):a===n.texture.filter.NEAREST_MIP&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST_MIPMAP_LINEAR),d.generateMipmap(d.TEXTURE_2D));this.filterType=a},use:function(a){r.gl.activeTexture(a);r.gl.bindTexture(r.gl.TEXTURE_2D,
y.Textures[this.tex_id]);this.active_unit=a},clear:function(){if(this.active_unit!==-1)r.gl.activeTexture(this.active_unit),r.gl.bindTexture(r.gl.TEXTURE_2D,null),this.active_unit=-1}};x.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,y.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===
n.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){var a=CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,y.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===n.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};m.prototype={update:function(){var a=r.gl,d=a.getParameter(a.VIEWPORT);
this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);CubicVR.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(d[0],d[1],d[2],d[3])}};f.prototype={begin:function(){var a=r.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},end:function(){var a=
r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:b,DeferredLoadTexture:c,CanvasTexture:x,TextTexture:function(c,d){var b=d&&d.color||"#fff",o=d&&d.bgcolor,g=d&&d.font||"18pt Arial",v=d&&d.align||"start",f=d&&d.y||0,t=d&&d.width||a,m=d&&d.height||a,n,r=document.createElement("CANVAS"),q=r.getContext("2d"),
A=0,A=typeof c==="string"?1:c.length;q.font=g;var u=d&&d.lineHeight||q.measureText("OO").width,y;if(A===1)y=q.measureText(c).width;else for(n=y=0;n<A;++n){var D=q.measureText(c[n]).width;D>y&&(y=D)}r.width=t||y;r.height=m||u*A;if(o)q.fillStyle=o,q.fillRect(0,0,r.width,r.height);q.fillStyle=b;q.font=g;q.textAlign=v;q.textBaseline="top";if(A===1)b=d&&d.x||v==="center"?r.width/2:v==="right"?r.width:0,q.fillText(c,b,f);else for(n=0;n<A;++n)b=d&&d.x||v==="center"?r.width/2:v==="right"?r.width:0,q.fillText(c[n],
b,f+n*u);q.fill();this.use=x.prototype.use;this.clear=x.prototype.clear;this.update=x.prototype.update;x.apply(this,[r]);this.update();this.canvasSource=null},PJSTexture:q,NormalMapGen:m,RenderTexture:f,SceneRenderTexture:g}});CubicVR.RegisterModule("Material",function(y){function x(a){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;a=g.getJSONScriptObj(a,function(a){for(var b in a.textures)a.textures.hasOwnProperty(b)&&(a.textures[b]=new CubicVR.Texture(a.textures[b]))})||{};this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.opacity=a.opacity===q?1:a.opacity;this.shininess=a.shininess===
q?1:a.shininess;this.max_smooth=a.max_smooth===q?60:a.max_smooth;this.env_amount=a.env_amount===q?0.75:a.env_amount;this.morph=a.morph===q?!1:a.morph;this.color_map=a.colorMap===q?!1:a.colorMap;this.uvOffset=a.uvOffset===q?null:a.uvOffset;a.textures&&(a.textures.color&&this.setTexture(a.textures.color,f.texture.map.COLOR),a.textures.envsphere&&this.setTexture(a.textures.envsphere,f.texture.map.ENVSPHERE),a.textures.normal&&this.setTexture(a.textures.normal,f.texture.map.NORMAL),a.textures.bump&&this.setTexture(a.textures.bump,
f.texture.map.BUMP),a.textures.reflect&&this.setTexture(a.textures.reflect,f.texture.map.REFLECT),a.textures.specular&&this.setTexture(a.textures.specular,f.texture.map.SPECULAR),a.textures.ambient&&this.setTexture(a.textures.ambient,f.texture.map.AMBIENT),a.textures.alpha&&this.setTexture(a.textures.alpha,f.texture.map.ALPHA))}var q=y.undef,m=y.GLCore,f=CubicVR.enums,g=CubicVR.util,r=[f.texture.map.REFLECT,f.texture.map.SPECULAR,f.texture.map.NORMAL,f.texture.map.BUMP],n=[];x.prototype={clone:function(){var a=
new CubicVR.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,name:this.name}),c;for(c in this.textures)a.setTexture(this.textures[c],c);return a},setTexture:function(a,c){c===q&&(c=0);if(y.features.texturePerPixel||r.indexOf(c)===-1)this.textures[c]=a},calcShaderMask:function(){var a=0;a+=typeof this.textures[f.texture.map.COLOR]===
"object"?f.shader.map.COLOR:0;a+=typeof this.textures[f.texture.map.SPECULAR]==="object"?f.shader.map.SPECULAR:0;a+=typeof this.textures[f.texture.map.NORMAL]==="object"?f.shader.map.NORMAL:0;a+=typeof this.textures[f.texture.map.BUMP]==="object"?f.shader.map.BUMP:0;a+=typeof this.textures[f.texture.map.REFLECT]==="object"?f.shader.map.REFLECT:0;a+=typeof this.textures[f.texture.map.ENVSPHERE]==="object"?f.shader.map.ENVSPHERE:0;a+=typeof this.textures[f.texture.map.AMBIENT]==="object"?f.shader.map.AMBIENT:
0;a+=typeof this.textures[f.texture.map.ALPHA]==="object"?f.shader.map.ALPHA:0;a+=this.opacity!==1?f.shader.map.ALPHA:0;a+=this.color_map?f.shader.map.COLORMAP:0;return a},getShaderHeader:function(a,c){return(c!==q?"#define loopCount "+c+"\n":"")+"#define hasColorMap "+(typeof this.textures[f.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[f.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+(typeof this.textures[f.texture.map.NORMAL]==="object"?1:
0)+"\n#define hasBumpMap "+(typeof this.textures[f.texture.map.BUMP]==="object"?1:0)+"\n#define hasReflectMap "+(typeof this.textures[f.texture.map.REFLECT]==="object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[f.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+(typeof this.textures[f.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[f.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+(this.opacity!==1?1:0)+"\n#define lightPoint "+
(a===f.light.type.POINT?1:0)+"\n#define lightDirectional "+(a===f.light.type.DIRECTIONAL?1:0)+"\n#define lightSpot "+(a===f.light.type.SPOT||a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define hasShadow "+(a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.AREA?1:0)+"\n#define hasProjector "+(a===f.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define softShadow "+(m.soft_shadow?1:0)+"\n#define lightArea "+(a===f.light.type.AREA?1:0)+
"\n#define depthPack "+(a===f.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(m.depth_alpha?1:0)+"\n#define hasMorph "+(this.morph?1:0)+"\n#define hasVertexColorMap "+(this.color_map?1:0)+"\n#define perPixel "+(y.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(a,c){var b=m.gl,e=c.aVertexPosition,d=c.aTextureCoord,h=c.aNormal,o=c.aColor;b.bindBuffer(b.ARRAY_BUFFER,a.compiled.gl_points);b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0);b.enableVertexAttribArray(e);d!==null&&a.compiled.gl_uvs!==
null&&d!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,a.compiled.gl_uvs),b.vertexAttribPointer(d,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(d));n.uv=d;h!==null&&a.compiled.gl_normals!==null&&h!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,a.compiled.gl_normals),b.vertexAttribPointer(h,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(h));n.un=h;o!==null&&a.compiled.gl_colors!==null&&o!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,a.compiled.gl_colors),b.vertexAttribPointer(o,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o));n.uc=o;if(a.morphTarget)e=
c.amVertexPosition,h=c.amNormal,b.bindBuffer(b.ARRAY_BUFFER,a.morphTarget.gl_points),b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e),h!==null&&a.morphTarget.gl_normals!==null&&h!==-1&&(b.bindBuffer(b.ARRAY_BUFFER,a.morphTarget.gl_normals),b.vertexAttribPointer(h,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(h)),b.uniform1f(c.morphWeight,a.morphWeight);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,c){var b=m.gl;n.uv!==q&&n.uv!==-1&&b.disableVertexAttribArray(n.uv);
n.un!==q&&n.un!==-1&&b.disableVertexAttribArray(n.un);n.uc!==q&&n.uc!==-1&&b.disableVertexAttribArray(n.uc);if(a.morphTarget&&c)up=c.amVertexPosition,b.disableVertexAttribArray(up),un=c.amNormal,un!==null&&a.compiled.gl_normals!==null&&un!==-1&&b.disableVertexAttribArray(un)},use:function(a,c){var b,e=m.gl,d=this.textures,c=c||0,a=a||0;if(this.customShader)this.customShader.use(a,c);else{this.shader[a]||(this.shader[a]=[]);var h=this.shader[a][c];if(h)h.use();else{b=this.calcShaderMask(a);y.ShaderPool[a][b]||
(y.ShaderPool[a][b]=[]);h=y.ShaderPool[a][b][c];if(!h){h=this.getShaderHeader(a,c);h=new CubicVR.Shader(h+m.CoreShader_vs,h+m.CoreShader_fs);y.ShaderPool[a][b][c]=h;b=0;if(a!==f.light.type.DEPTH_PACK){if(a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.AREA)b+=c,a===f.light.type.SPOT_SHADOW_PROJECTOR&&(b+=c);typeof d[f.texture.map.COLOR]==="object"&&h.addInt("colorMap",b++);typeof d[f.texture.map.ENVSPHERE]==="object"&&h.addInt("envSphereMap",b++);typeof d[f.texture.map.NORMAL]===
"object"&&h.addInt("normalMap",b++);typeof d[f.texture.map.BUMP]==="object"&&h.addInt("bumpMap",b++);typeof d[f.texture.map.REFLECT]==="object"&&h.addInt("reflectMap",b++);typeof d[f.texture.map.SPECULAR]==="object"&&h.addInt("specularMap",b++);typeof d[f.texture.map.AMBIENT]==="object"&&h.addInt("ambientMap",b++)}typeof d[f.texture.map.ALPHA]==="object"&&h.addInt("alphaMap",b++);h.addMatrix("uMVMatrix");h.addMatrix("uPMatrix");h.addMatrix("uOMatrix");h.addMatrix("uNMatrix");h.addVertexArray("aVertexPosition");
h.addVertexArray("aNormal");this.color_map&&h.addVertexArray("aColor");this.morph&&(h.addVertexArray("amVertexPosition"),h.addVertexArray("amNormal"),h.addFloat("morphWeight",0));for(b=0;b<c;b++)if(h.addVector("lDiff["+b+"]"),h.addVector("lSpec["+b+"]"),h.addFloat("lInt["+b+"]"),h.addFloat("lDist["+b+"]"),h.addVector("lPos["+b+"]"),h.addVector("lDir["+b+"]"),(a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.SPOT)&&h.addFloat("lCut["+b+"]"),a===f.light.type.SPOT_SHADOW||
a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.AREA)h.addInt("lDepthTex["+b+"]"),a===f.light.type.SPOT_SHADOW_PROJECTOR&&h.addInt("lProjTex["+b+"]"),h.addVector("lDepth["+b+"]"),h.addMatrix("spMatrix["+b+"]");a!==f.light.type.DEPTH_PACK&&(h.addVector("lAmb"),h.addVector("mDiff"),h.addVector("mColor"),h.addVector("mAmb"),h.addVector("mSpec"),h.addFloat("mShine"),h.addFloat("envAmount"));h.addFloat("mAlpha");(m.depth_alpha||a===f.light.type.DEPTH_PACK||a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||
a===f.light.type.AREA)&&h.addVector("depthInfo");h.addUVArray("aTextureCoord");h.addVector("uTexOffset")}this.shader[a][c]=h;h.use();h.uTexOffset!=-1&&e.uniform2fv(h.uTexOffset,[0,0])}b=0;var o;if(a!==f.light.type.DEPTH_PACK){if(a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.AREA)b+=c,a===f.light.type.SPOT_SHADOW_PROJECTOR&&(b+=c);if(o=d[f.texture.map.COLOR])o.use(m.gl.TEXTURE0+b),b++;if(o=d[f.texture.map.ENVSPHERE])o.use(m.gl.TEXTURE0+b),b++,e.uniform1f(h.envAmount,
this.env_amount);if(o=d[f.texture.map.NORMAL])o.use(m.gl.TEXTURE0+b),b++;if(o=d[f.texture.map.BUMP])o.use(m.gl.TEXTURE0+b),b++;if(o=d[f.texture.map.REFLECT])o.use(m.gl.TEXTURE0+b),b++;if(o=d[f.texture.map.SPECULAR])o.use(m.gl.TEXTURE0+b),b++;if(o=d[f.texture.map.AMBIENT])o.use(m.gl.TEXTURE0+b),b++}(o=d[f.texture.map.ALPHA])&&o.use(m.gl.TEXTURE0+b);a!==f.light.type.DEPTH_PACK?(e.uniform3fv(h.mColor,this.color),e.uniform3fv(h.mDiff,this.diffuse),e.uniform3fv(h.mAmb,this.ambient),e.uniform3fv(h.mSpec,
this.specular),e.uniform1f(h.mShine,this.shininess*128),e.uniform3fv(h.lAmb,CubicVR.globalAmbient),this.opacity!==1&&e.uniform1f(h.mAlpha,this.opacity),(m.depth_alpha||a===f.light.type.SPOT_SHADOW||a===f.light.type.SPOT_SHADOW_PROJECTOR||a===f.light.type.AREA)&&e.uniform3fv(h.depthInfo,[m.depth_alpha_near,m.depth_alpha_far,0])):e.uniform3fv(h.depthInfo,[m.shadow_near,m.shadow_far,0]);this.uvOffset&&e.uniform2fv(h.uTexOffset,this.uvOffset)}}};return{Material:x}});CubicVR.RegisterModule("Mesh",function(y){function x(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function q(g){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=g?g:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.instanceMaterials=null}
var m=y.undef,f=y.GLCore;x.prototype={setUV:function(g,f){f!==m?this.uvs[f]=g:g.length!==2?this.uvs=g:this.uvs.push(g)},setColor:function(g,f){f!==m?this.point_colors[f]=g:typeof g[0]!=="number"?this.point_colors=g:this.point_colors.push(g)},flip:function(){for(var g=0,f=this.point_normals.length;g<f;g++)this.point_normals[g]=[-this.point_normals[g][0],-this.point_normals[g][1],-this.point_normals[g][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],
-this.normal[1],-this.normal[2]]}};q.prototype={showAllSegments:function(){for(var g in this.segment_state)this.segment_state.hasOwnProperty(g)&&(this.segment_state[g]=!0)},hideAllSegments:function(){for(var g in this.segment_state)this.segment_state.hasOwnProperty(g)&&(this.segment_state[g]=!1)},setSegment:function(g,f){f!==m?this.segment_state[g]=f:this.currentSegment=g},addPoint:function(g){if(g.length!==3||typeof g[0]==="object")for(var f=0,m=g.length;f<m;f++)this.points.push(g[f]);else this.points.push(g);
return this.points.length-1},getMaterialIndex:function(g){return this.materials.indexOf(g)},setFaceMaterial:function(g,f){var n;typeof g=="number"?n=g:(n=this.materials.indexOf(g),n===-1&&(this.materials.push(g),n=this.materials.length-1));if(f!==m){if(this.faces[f]!==m)this.faces[f].material=n}else this.currentMaterial=n;return this},addFace:function(g,f,n,a){if(typeof g[0]!=="number"){f=0;for(n=g.length;f<n;f++)this.addFace(g[f])}else{f===m?(this.currentFace=this.faces.length,this.faces.push(new x)):
(this.faces[f]===m&&(this.faces[f]=new x),this.currentFace=f);if(typeof g==="object")this.faces[this.currentFace].points=g;n!==m?this.setFaceMaterial(n,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=a!==m?a:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var g=0,f=this.faces.length;g<f;g++)this.faces[g].flip()},triangulateQuads:function(){for(var g=0,f=this.faces.length;g<f;g++)if(this.faces[g].points.length===
4){var m=this.faces.length;this.addFace([this.faces[g].points[2],this.faces[g].points[3],this.faces[g].points[0]],this.faces.length,this.faces[g].material,this.faces[g].segment);this.faces[g].points.pop();this.faces[m].normal=this.faces[g].normal.slice(0);if(this.faces[g].point_colors.length===4)this.faces[m].point_colors=this.faces[g].point_colors.slice(0);this.faces[g].uvs.length===4&&(this.faces[m].setUV(this.faces[g].uvs[2],0),this.faces[m].setUV(this.faces[g].uvs[3],1),this.faces[m].setUV(this.faces[g].uvs[0],
2),this.faces[g].uvs.pop());this.faces[g].point_normals.length===4&&(this.faces[m].point_normals[0]=this.faces[g].point_normals[2],this.faces[m].point_normals[1]=this.faces[g].point_normals[3],this.faces[m].point_normals[2]=this.faces[g].point_normals[0],this.faces[g].point_normals.pop())}return this},booleanAdd:function(g,f){var n=CubicVR.mat4,a=this.points.length,c,b,e,d;if(f!==m){b=f.getResult();c=0;for(e=g.points.length;c<e;c++)this.addPoint(n.vec3_multiply(g.points[c],b))}else{c=0;for(e=g.points.length;c<
e;c++)this.addPoint([g.points[c][0],g.points[c][1],g.points[c][2]])}n=[];c=0;for(e=g.materials.length;c<e;c++)b=this.materials.indexOf(g.materials[c]),b===-1?(this.materials.push(g.materials[c]),n[c]=this.materials.length-1):n[c]=b;c=0;for(e=g.faces.length;c<e;c++){var h=[];b=0;for(d=g.faces[c].points.length;b<d;b++)h.push(g.faces[c].points[b]+a);h=this.faces[this.addFace(h)];h.segment=g.faces[c].segment;h.material=n[g.faces[c].material];if(h.material===m)h.material=0;b=0;for(d=g.faces[c].uvs.length;b<
d;b++)h.uvs[b]=[g.faces[c].uvs[b][0],g.faces[c].uvs[b][1]];b=0;for(d=g.faces[c].point_normals.length;b<d;b++)h.point_normals[b]=[g.faces[c].point_normals[b][0],g.faces[c].point_normals[b][1],g.faces[c].point_normals[b][2]]}return this},calcFaceNormals:function(g,f){var m=CubicVR.vec3,a=CubicVR.triangle,c=0,b=this.faces.length;g&&(c=g);for(f&&(b=f+1);c<b;c++)this.faces[c].normal=this.faces[c].points.length<3?[0,0,0]:m.normalize(a.normal(this.points[this.faces[c].points[0]],this.points[this.faces[c].points[1]],
this.points[this.faces[c].points[2]]));return this},getMaterial:function(g){for(var f=0,m=this.materials.length;f<m;f++)if(this.materials[f].name===g)return this.materials[f];return null},bindInstanceMaterials:function(g){this.instanceMaterials=g},calcNormals:function(g){var f=CubicVR.vec3,n=!1;g!==m&&(n=!0);this.calcFaceNormals();var a,c,b,e,d=Array(this.points.length);a=0;for(e=d.length;a<e;a++)d[a]=[];b=this.faces.length;for(a=0;a<b;a++){e=this.faces[a].points.length;for(c=0;c<e;c++)d[this.faces[a].points[c]].push([a,
c])}a=0;for(e=this.points.length;a<e;a++){var h=d[a].length;for(c=0;c<h;c++){var o=1,z=d[a][c][0],v=d[a][c][1],w=this.materials.length?this.materials[this.faces[z].material].max_smooth:60,t=this.faces[z];n&&(g[z]===m&&(g[z]=[]),g[z][v]===m&&(g[z][v]=[]));var s=Array(3);s[0]=t.normal[0];s[1]=t.normal[1];s[2]=t.normal[2];if(w!==0)for(b=0;b<h;b++)if(c!==b){var B=d[a][b][0],q=this.faces[B],x=f.angle(q.normal,t.normal);if(x!==x||x*(180/Math.PI)<=w)n&&g[z][v].push(B),s[0]+=q.normal[0],s[1]+=q.normal[1],
s[2]+=q.normal[2],o++}s[0]/=o;s[1]/=o;s[2]/=o;this.faces[z].point_normals[v]=f.normalize(s)}}return this},recalcNormals:function(g){this.calcFaceNormals();for(var f=0,m=this.faces.length;f<m;f++)for(var a=this.faces[f],c=0,b=a.points.length;c<b;c++){var e=g[f][c],d=a.point_normals[c];d[0]=a.normal[0];d[1]=a.normal[1];d[2]=a.normal[2];for(var h=e.length,o=0;o<h;o++){var z=this.faces[e[o]];d[0]+=z.normal[0];d[1]+=z.normal[1];d[2]+=z.normal[2]}h!==0&&(d[0]/=h+1,d[1]/=h+1,d[2]/=h+1,e=Math.sqrt(d[0]*d[0]+
d[1]*d[1]+d[2]*d[2]),d[0]/=e,d[1]/=e,d[2]/=e)}return this},removeDoubles:function(){var g=[],f=[],m,a,c,b;m=0;for(a=this.points.length;m<a;m++){var e=-1,d=this.points[m];c=0;for(b=g.length;c<b;c++)if(CubicVR.vec3.equal(d,g[c])){e=c;break}e!=-1?f[m]=e:(f[m]=g.length,g.push(this.points[m]))}this.points=g;m=0;for(a=this.faces.length;m<a;m++){g=this.faces[m];c=0;for(b=g.points.length;c<b;c++)g.points[c]=f[g.points[c]]}},prepare:function(g){g===m&&(g=!0);this.calcNormals().triangulateQuads().compile();
g&&this.clean();return this},clean:function(){var g,f;g=0;for(f=this.points.length;g<f;g++)delete this.points[g],this.points[g]=null;this.points=[];g=0;for(f=this.faces.length;g<f;g++)delete this.faces[g].points,delete this.faces[g].point_normals,delete this.faces[g].uvs,delete this.faces[g].normal,delete this.faces[g],this.faces[g]=null;this.faces=[];return this},compileMap:function(g){var f=CubicVR.vec3,n=CubicVR.vec2;g===m&&(g=1.0E-5);var a={segments:[],bounds:[]},c=[],b,e,d,h,o,z,v,w;this.materials.length||
this.materials.push(new CubicVR.Material);b=0;for(z=this.materials.length;b<z;b++)c[b]=[];b=0;for(z=this.faces.length;b<z;b++)if(this.faces[b].points.length===3)d=this.faces[b].material,h=this.faces[b].segment,c[d][h]===m&&(c[d][h]=[],a.segments.push(h)),c[d][h].push(b);var t=[],s=0,B=!1,q=!1,x=!1,A;b=0;for(z=c.length;b<z;b++)for(e in c[b])if(c[b].hasOwnProperty(e))for(d=0;d<c[b][e].length;d++)A=c[b][e][d],B=B||this.faces[A].uvs.length!==0,q=q||this.faces[A].point_normals.length!==0,x=x||this.faces[A].point_colors.length!==
0;if(B)for(b=0;b<this.faces.length;b++)if(!this.faces[b].uvs.length)for(e=0;e<this.faces[b].points.length;e++)this.faces[b].uvs.push([0,0]);if(q)for(b=0;b<this.faces.length;b++)if(!this.faces[b].point_normals.length)for(e=0;e<this.faces[b].points.length;e++)this.faces[b].point_normals.push([0,0,0]);if(x)for(b=0;b<this.faces.length;b++)if(!this.faces[b].point_colors.length)for(e=0;e<this.faces[b].points.length;e++)this.faces[b].point_colors.push([0,0,0]);b=0;for(z=c.length;b<z;b++)for(e in c[b])if(c[b].hasOwnProperty(e)){d=
0;for(v=c[b][e].length;d<v;d++){A=c[b][e][d];for(h=0;h<3;h++){var u=this.faces[A].points[h],y=-1;if(t[u]!==m){o=0;for(w=t[u].length;o<w;o++){var D=t[u][o][0],C=t[u][o][1],y=t[u][o][2];q&&(y=f.equal(this.faces[D].point_normals[C],this.faces[A].point_normals[h],g)?y:-1);B&&(y=n.equal(this.faces[D].uvs[C],this.faces[A].uvs[h],g)?y:-1);x&&(y=f.equal(this.faces[D].point_colors[C],this.faces[A].point_colors[h],g)?y:-1)}}if(y!==-1){if(a.elements===m)a.elements=[];a.elements[b]===m&&(a.elements[b]=[]);a.elements[b][e]===
m&&(a.elements[b][e]=[]);a.elements[b][e].push(y)}else{if(a.points===m)a.points=[];a.points.push(u);a.bounds.length===0?(a.bounds[0]=[this.points[u][0],this.points[u][1],this.points[u][2]],a.bounds[1]=[this.points[u][0],this.points[u][1],this.points[u][2]]):(this.points[u][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[u][0]),this.points[u][1]<a.bounds[0][1]&&(a.bounds[0][1]=this.points[u][1]),this.points[u][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[u][2]),this.points[u][0]>a.bounds[1][0]&&(a.bounds[1][0]=
this.points[u][0]),this.points[u][1]>a.bounds[1][1]&&(a.bounds[1][1]=this.points[u][1]),this.points[u][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[u][2]));if(q){if(a.normals===m)a.normals=[];a.normals.push([A,h])}if(x){if(a.colors===m)a.colors=[];a.colors.push([A,h])}if(B){if(a.uvs===m)a.uvs=[];a.uvs.push([A,h])}if(a.elements===m)a.elements=[];a.elements[b]===m&&(a.elements[b]=[]);a.elements[b][e]===m&&(a.elements[b][e]=[]);a.elements[b][e].push(s);t[u]===m&&(t[u]=[]);t[u].push([A,h,s]);s++}}}}return a},
compileVBO:function(g,f,n,a,c,b){typeof f=="object"?(f=f.element!==m?f.element:!0,n=f.vertex!==m?f.vertex:!0,b=f.color!==m?f.color:!0,a=f.normal!==m?f.normal:!0,c=f.uv!==m?f.uv:!0):(f===m&&(f=!0),n===m&&(n=!0),b===m&&(b=!0),a===m&&(a=!0),c===m&&(c=!0));var e={},d,h,o;if(g.points&&n){d=g.points.length;e.vbo_points=new Float32Array(d*3);for(n=h=0;n<d;n++)o=g.points[n],e.vbo_points[h++]=this.points[o][0],e.vbo_points[h++]=this.points[o][1],e.vbo_points[h++]=this.points[o][2]}if(g.normals&&a){d=g.normals.length;
e.vbo_normals=new Float32Array(d*3);for(n=h=0;n<d;n++)o=g.normals[n],e.vbo_normals[h++]=this.faces[o[0]].point_normals[o[1]][0],e.vbo_normals[h++]=this.faces[o[0]].point_normals[o[1]][1],e.vbo_normals[h++]=this.faces[o[0]].point_normals[o[1]][2]}if(g.colors&&b){d=g.colors.length;e.vbo_colors=new Float32Array(d*3);for(n=h=0;n<d;n++)o=g.colors[n],e.vbo_colors[h++]=this.faces[o[0]].point_colors[o[1]][0],e.vbo_colors[h++]=this.faces[o[0]].point_colors[o[1]][1],e.vbo_colors[h++]=this.faces[o[0]].point_colors[o[1]][2]}if(g.uvs&&
c){d=g.uvs.length;e.vbo_uvs=new Float32Array(d*2);for(n=h=0;n<d;n++)o=g.uvs[n],e.vbo_uvs[h++]=this.faces[o[0]].uvs[o[1]][0],e.vbo_uvs[h++]=this.faces[o[0]].uvs[o[1]][1]}if(f){e.elements_ref=[];e.vbo_elements=[];n=0;for(d=g.elements.length;n<d;n++){e.elements_ref[n]=[];var c=0,z;for(z in g.elements[n])if(g.elements[n].hasOwnProperty(z)){b=g.elements[n][z];f=0;for(a=b.length;f<a;f++)e.vbo_elements.push(b[f]);e.elements_ref[n][c]=[z|0,b.length|0];c++}}e.vbo_elements=new Uint16Array(e.vbo_elements)}e.segments=
g.segments;e.bounds=g.bounds;return e},bufferVBO:function(g,r){var n=f.gl,a={};r===m&&(r={});a.gl_points=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,a.gl_points);n.bufferData(n.ARRAY_BUFFER,g.vbo_points,n.STATIC_DRAW);g.vbo_normals?(a.gl_normals=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,a.gl_normals),n.bufferData(n.ARRAY_BUFFER,g.vbo_normals,n.STATIC_DRAW)):a.gl_normals=r.gl_normals?r.gl_normals:null;g.vbo_uvs?(a.gl_uvs=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,a.gl_uvs),n.bufferData(n.ARRAY_BUFFER,
g.vbo_uvs,n.STATIC_DRAW)):a.gl_uvs=r.gl_uvs?r.gl_uvs:null;g.vbo_colors?(a.gl_colors=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,a.gl_colors),n.bufferData(n.ARRAY_BUFFER,g.vbo_colors,n.STATIC_DRAW)):a.gl_colors=r.gl_colors?r.gl_colors:null;!g.vbo_elements&&r.gl_elements?(a.gl_elements=r.gl_elements,a.elements_ref=r.elements_ref):(a.gl_elements=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,a.gl_elements),n.bufferData(n.ELEMENT_ARRAY_BUFFER,g.vbo_elements,n.STATIC_DRAW),a.elements_ref=g.elements_ref);
a.segments=g.segments;a.bounds=g.bounds;r.elements_ref&&!g.elements_ref&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);return a},bindBuffer:function(g){if(this.originBuffer===null)this.originBuffer=g;this.compiled=g;this.segment_state=[];for(var f=0,m=g.segments.length;f<m;f++)this.segment_state[g.segments[f]]=!0;this.bb=g.bounds},compile:function(g){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(g))));return this},addMorphTarget:function(g){if(this.morphTargets===null)this.morphTargets=
[];this.morphTargets.push(g)},setMorphSource:function(g){if(this.morphSourceIndex!==g)this.morphSourceIndex=g,this.bindBuffer(this.morphTargets[g])},setMorphTarget:function(g){if(this.morphTargetIndex!==g)this.morphTargetIndex=g,this.morphTarget=this.morphTargets[g]},setMorphWeight:function(g){this.morphWeight=g},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:q,Face:x}});CubicVR.RegisterModule("Motion",function(y){function x(){this.time=this.value=0;this.shape=g.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function q(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:g.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:g.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=g.envelope.behavior.CONSTANT}function m(a,d){this.env_init=
a;this.key_init=d;this.controllers=[];this.yzflip=!1}var f=y.undef,g=CubicVR.enums;g.motion={POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};g.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var r=function(a,d,c){var b=0,b=c-d;if(b===0)return[d,0];d=a-b*Math.floor((a-d)/b);b=-parseInt((d-a)/b+(d>a?0.5:-0.5),10);return[d,b]},n=function(a,d,c,b,g){var f,m;m=g*g;f=3*(d-a);d=3*(c-d)-f;return(b-
a-f-d)*m*g+d*m+f*g+a},a=function(c,d,b,o,g,f,m){var t,s;s=f+(m-f)*0.5;t=n(c,d,b,o,s);return Math.abs(g-t)>1.0E-4?(t>g?m=s:f=s,a(c,d,b,o,g,f,m)):s},c=function(a,d){var c,b,f,m;a.shape===g.envelope.shape.TCB?(c=(1-a.tension)*(1+a.continuity)*(1+a.bias),b=(1-a.tension)*(1-a.continuity)*(1-a.bias),f=d.value-a.value,a.prev?(m=(d.time-a.time)/(d.time-a.prev.time),c=m*(c*(a.value-a.prev.value)+b*f)):c=b*f):a.shape===g.envelope.shape.LINE?(f=d.value-a.value,a.prev?(m=(d.time-a.time)/(d.time-a.prev.time),
c=m*(a.value-a.prev.value+f)):c=f):a.shape===g.envelope.shape.BEZI||a.shape===g.envelope.shape.HERM?(c=a.param[1],a.prev&&(c*=(d.time-a.time)/(d.time-a.prev.time))):a.shape===g.envelope.shape.BEZ2?(c=a.param[3]*(d.time-a.time),Math.abs(a.param[2])>1.0E-5?c/=a.param[2]:c*=1E5):c=0;return c},b=function(a,d){var c,b,f,m;d.shape===g.envelope.shape.LINE?(f=d.value-a.value,d.next?(m=(d.time-a.time)/(d.next.time-a.time),c=m*(d.next.value-d.value+f)):c=f):d.shape===g.envelope.shape.TCB?(c=(1-d.tension)*(1-
d.continuity)*(1+d.bias),b=(1-d.tension)*(1+d.continuity)*(1-d.bias),f=d.value-a.value,d.next?(m=(d.time-a.time)/(d.next.time-a.time),c=m*(b*(d.next.value-d.value)+c*f)):c*=f):d.shape===g.envelope.shape.HERM||d.shape===g.envelope.shape.BEZI?(c=d.param[0],d.next&&(c*=(d.time-a.time)/(d.next.time-a.time))):d.shape===g.envelope.shape.BEZ2?(c=d.param[1]*(d.time-a.time),Math.abs(d.param[0])>1.0E-5?c/=d.param[0]:c*=1E5):c=0;return c};q.prototype={setBehavior:function(a,d){this.in_behavior=a;this.out_behavior=
d},empty:function(){return this.nKeys===0},addKey:function(a,d,c){var b=typeof a=="object"?a:c;d||(d=0);a||(a=0);b?(b=a,a=b.time,c=this.insertKey(a),c.value=b.value?b.value:d,c.time=b.time?b.time:a,c.shape=b.shape?b.shape:g.envelope.shape.TCB,c.tension=b.tension?b.tension:0,c.continuity=b.continuity?b.continuity:0,c.bias=b.bias?b.bias:0,c.param=b.param?b.param:[0,0,0,0]):(c=this.insertKey(a),c.value=d);return c},insertKey:function(a){var d=new x;d.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=
this.keys=d,this.nKeys++,d;for(var c=this.keys;c;){if(this.firstKey.time>a)this.firstKey=d;else if(this.lastKey.time<a)this.lastKey=d;if(c.time>d.time){d.prev=c.prev;if(d.prev)d.prev.next=d;d.next=c;d.next.prev=d;this.nKeys++;return d}else if(!c.next)return d.prev=c,c.next=d,this.nKeys++,d;c=c.next}return null},evaluate:function(e){var d,h,o,f,m,w=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;h=this.firstKey;d=this.lastKey;if(e<h.time)if(f=this.in_behavior,f===g.envelope.behavior.RESET)return 0;
else if(f===g.envelope.behavior.CONSTANT)return h.value;else if(f===g.envelope.behavior.REPEAT)f=r(e,h.time,d.time),e=f[0];else if(f===g.envelope.behavior.OCILLATE)f=r(e,h.time,d.time),e=f[0],f=f[1],f%2&&(e=d.time-h.time-e);else if(f===g.envelope.behavior.OFFSET)f=r(e,h.time,d.time),e=f[0],f=f[1],w=f*(d.value-h.value);else{if(f===g.envelope.behavior.LINEAR)return m=c(h,h.next)/(h.next.time-h.time),m*(e-h.time)+h.value}else if(e>d.time)if(f=this.out_behavior,f===g.envelope.behavior.RESET)return 0;
else if(f===g.envelope.behavior.CONSTANT)return d.value;else if(f===g.envelope.behavior.REPEAT)f=r(e,h.time,d.time),e=f[0];else if(f===g.envelope.behavior.OCILLATE)f=r(e,h.time,d.time),e=f[0],f=f[1],f%2&&(e=d.time-h.time-e);else if(f===g.envelope.behavior.OFFSET)f=r(e,h.time,d.time),e=f[0],f=f[1],w=f*(d.value-h.value);else if(f===g.envelope.behavior.LINEAR)return f=b(d.prev,d)/(d.time-d.prev.time),f*(e-d.time)+d.value;if(this.lastKey0)if(e>this.lastKey0.time)d=this.lastKey0;else if(e<this.lastKey0.time)for(d=
this.lastKey;e<d.time&&d.prev;)d=d.prev;else d=this.keys;else d=this.keys;for(;e>d.next.time;)d=d.next;h=d.next;this.lastKey0=d;if(e===d.time)return d.value+w;else if(e===h.time)return h.value+w;o=(e-d.time)/(h.time-d.time);f=h.shape;if(f===g.envelope.shape.TCB||f===g.envelope.shape.BEZI||f===g.envelope.shape.HERM){m=c(d,h);f=b(d,h);var t,s;s=o*o;t=o*s;e=3*s-t-t;t-=s;e=[1-e,e,t-s+o,t];return e[0]*d.value+e[1]*h.value+e[2]*m+e[3]*f+w}else return f===g.envelope.shape.BEZ2?(e=a(d.time,d.shape===g.envelope.shape.BEZ2?
d.time+d.param[2]:d.time+(h.time-d.time)/3,h.time+h.param[0],h.time,e,0,1),w=n(d.value,d.shape===g.envelope.shape.BEZ2?d.value+d.param[3]:d.value+d.param[1]/3,h.param[1]+h.value,h.value,e)+w):w=f===g.envelope.shape.LINE?d.value+o*(h.value-d.value)+w:f===g.envelope.shape.STEP?d.value+w:w,w}};m.prototype={envelope:function(a,d){this.controllers[a]===f&&(this.controllers[a]=[]);this.controllers[a][d]===f&&(this.controllers[a][d]=new q(this.env_init));return this.controllers[a][d]},evaluate:function(a){var d=
[],c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){d[c]=[];for(var b in this.controllers[c])this.controllers[c].hasOwnProperty(b)&&(d[c][b]=this.controllers[c][b].evaluate(a))}return d},apply:function(a,d){for(var c in this.controllers)if(this.controllers.hasOwnProperty(c)){var b=parseInt(c,10);if(this.yzflip&&b===g.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var f=this.q,m=this.controllers[c][0].evaluate(a),w=this.controllers[c][1].evaluate(a),t=this.controllers[c][2].evaluate(a);
f.fromEuler(m,t,-w);f=f.toEuler();d.control(b,0,f[0]);d.control(b,1,f[1]);d.control(b,2,f[2])}else for(var s in this.controllers[c])this.controllers[c].hasOwnProperty(s)&&d.control(b,parseInt(s,10),this.controllers[c][s].evaluate(a))}},setKey:function(a,d,c,b,g){return this.envelope(a,d).addKey(c,b,g?g:this.key_init)},setArray:function(a,d,c,b){var g=[],f;for(f in c)if(c.hasOwnProperty(f)){var m=this.envelope(a,f);g[f]=m.addKey(d,c[f],b?b:this.key_init)}return g},setBehavior:function(a,d,c,b){this.envelope(a,
d).setBehavior(c,b)},setBehaviorArray:function(a,d,c){for(var b in this.controllers[a])this.controllers[a].hasOwnProperty(b)&&this.envelope(a,b).setBehavior(d,c)}};return{Motion:m,Envelope:q,EnvelopeKey:x}});CubicVR.RegisterModule("Octree",function(y){function x(a,b,e,d,h){var o=this._children=[];this._dirty=!1;o[0]=null;o[1]=null;o[2]=null;o[3]=null;o[4]=null;o[5]=null;o[6]=null;o[7]=null;this._child_index=h||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;d=this._position=d||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[d[0],d[1],d[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=CubicVR.aabb;e.reset(b,d);a/=2;e.engulf(b,[d[0]+
a,d[1]+a,d[2]+a]);e.engulf(b,[d[0]-a,d[1]-a,d[2]-a]);this._debug_visible=!1}function q(){this.position=[0,0,0];this.visible=!1;this._object=null}function m(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var f=y.undef,g=CubicVR.plane,r=CubicVR.sphere,n=CubicVR.enums;n.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};n.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,b,e){e=a.slice((e||
b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,e)};x.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].destroy();a=
0;for(b=this._nodes.length;a<b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};x.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};x.prototype.remove=function(c){var b=!1,e=this._nodes.length,d;d=e-1;for(e=this._nodes.length;d>=0;--d)if(c===this._nodes[d]){a(this._nodes,d);this.dirty_lineage();b=!0;break}if(!b)for(d=e-1;d>=0;--d)if(c===this._lights[d]){a(this._lights,d);this.dirty_lineage();break}};x.prototype.dirty_lineage=function(){this._dirty=
!0;this._root!==null&&this._root.dirty_lineage()};x.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var d=this._children[e];if(d!==null){var h=!0;d._dirty===!0&&(h=d.cleanup());h?++b:this._children[e]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(b===0||a===0))return!1;return!0};x.prototype.insert_light=function(a){this.insert(a,!0)};x.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<e;++b)this._nodes[b].static_lights.indexOf(a)===
-1&&this._nodes[b].static_lights.push(a);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].propagate_static_light(a)};x.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)a.static_lights.indexOf(this._static_lights[b])===-1&&a.static_lights.push(this._static_lights[b]);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].collect_static_lights(a)};x.prototype.insert=function(a,b){function e(a,d,c,b){var h,e;if(c)if(d.method===n.light.method.STATIC){a._static_lights.indexOf(d)===
-1&&a._static_lights.push(d);c=0;for(h=a._nodes.length;c<h;++c)a._nodes[c].static_lights.indexOf(d)===-1&&a._nodes[c].static_lights.push(d);for(e=a._root;e!==null;){c=0;for(l=e._nodes.length;c<l;++c)h=e._nodes[c],h.static_lights.indexOf(d)===-1&&h.static_lights.push(d);e=e._root}}else a._lights.indexOf(d)===-1&&a._lights.push(d);else{a._nodes.push(d);c=0;for(h=a._static_lights.length;c<h;++c)d.static_lights.indexOf(a._static_lights[c])===-1&&d.static_lights.push(a._static_lights[c]);for(e=a._root;e!==
null;){c=0;for(h=e._static_lights.length;c<h;++c){var o=e._static_lights[c];d.static_lights.indexOf(o)===-1&&d.static_lights.push(o)}e=e._root}}d.octree_leaves.push(a);d.octree_common_root=b;b=CubicVR.aabb;b.engulf(d.octree_aabb,a._bbox[0]);b.engulf(d.octree_aabb,a._bbox[1])}b===f&&(b=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,b,this._root);else{var d=this._position,h,o,g,m,w,t,s;o=a.getAABB();s=[o[0][0],o[0][1],o[0][2]];var B=[o[1][0],o[1][1],
o[1][2]];h=s[0]<d[0]&&s[1]<d[1]&&s[2]<d[2];o=B[0]>d[0]&&s[1]<d[1]&&s[2]<d[2];w=s[0]<d[0]&&B[1]>d[1]&&s[2]<d[2];t=B[0]>d[0]&&B[1]>d[1]&&s[2]<d[2];g=s[0]<d[0]&&s[1]<d[1]&&B[2]>d[2];m=B[0]>d[0]&&s[1]<d[1]&&B[2]>d[2];s=s[0]<d[0]&&B[1]>d[1]&&B[2]>d[2];d=B[0]>d[0]&&B[1]>d[1]&&B[2]>d[2];if(h&&o&&w&&t&&g&&m&&s&&d)e(this,a,b,this),b?a.method==n.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var B=0,r=this._static_lights.length;B<r;++B){if(a.static_lights===f)a.static_lights=
[];a.static_lights.indexOf(this._static_lights[B])===-1&&a.static_lights.push(this._static_lights[B])}var B=this._size/2,r=this._size/4,q=0,A=this._position[0],u=this._position[1],y=this._position[2];h&&(h=[A-r,u-r,y-r],this._children[n.octree.TOP_NW]===null&&(this._children[n.octree.TOP_NW]=new x(B,this._max_depth-1,this,h,n.octree.TOP_NW)),this._children[n.octree.TOP_NW].insert(a,b),++q);o&&(h=[A+r,u-r,y-r],this._children[n.octree.TOP_NE]===null&&(this._children[n.octree.TOP_NE]=new x(B,this._max_depth-
1,this,h,n.octree.TOP_NE)),this._children[n.octree.TOP_NE].insert(a,b),++q);w&&(h=[A-r,u+r,y-r],this._children[n.octree.BOTTOM_NW]===null&&(this._children[n.octree.BOTTOM_NW]=new x(B,this._max_depth-1,this,h,n.octree.BOTTOM_NW)),this._children[n.octree.BOTTOM_NW].insert(a,b),++q);t&&(h=[A+r,u+r,y-r],this._children[n.octree.BOTTOM_NE]===null&&(this._children[n.octree.BOTTOM_NE]=new x(B,this._max_depth-1,this,h,n.octree.BOTTOM_NE)),this._children[n.octree.BOTTOM_NE].insert(a,b),++q);g&&(h=[A-r,u-r,
y+r],this._children[n.octree.TOP_SW]===null&&(this._children[n.octree.TOP_SW]=new x(B,this._max_depth-1,this,h,n.octree.TOP_SW)),this._children[n.octree.TOP_SW].insert(a,b),++q);m&&(h=[A+r,u-r,y+r],this._children[n.octree.TOP_SE]===null&&(this._children[n.octree.TOP_SE]=new x(B,this._max_depth-1,this,h,n.octree.TOP_SE)),this._children[n.octree.TOP_SE].insert(a,b),++q);s&&(h=[A-r,u+r,y+r],this._children[n.octree.BOTTOM_SW]===null&&(this._children[n.octree.BOTTOM_SW]=new x(B,this._max_depth-1,this,
h,n.octree.BOTTOM_SW)),this._children[n.octree.BOTTOM_SW].insert(a,b),++q);d&&(h=[A+r,u+r,y+r],this._children[n.octree.BOTTOM_SE]===null&&(this._children[n.octree.BOTTOM_SE]=new x(B,this._max_depth-1,this,h,n.octree.BOTTOM_SE)),this._children[n.octree.BOTTOM_SE].insert(a,b),++q);if(q>1||a.octree_common_root===null)a.octree_common_root=this}}};x.prototype.draw_on_map=function(a,b,e){function d(a,d,c,e,g){var f=a<c?a:c,t=d<e?d:e,a=a<c?c-a:a-c,d=d<e?e-d:d-e;b.save();if(g!==void 0)b.fillStyle=g,b.fillRect(h+
f,o+t,a,d);b.strokeRect(h+f,o+t,a,d);b.restore()}var h=a.width/2,o=a.height/2,g,m,w,t,s,n,r;if(e===f||e==="map")b.save(),this._debug_visible!==!1?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),s=this._size/2,g=this._position[0],m=this._position[2],b.moveTo(h+g-s,h+m-s),b.lineTo(h+g-s,h+m+s),b.lineTo(h+g+s,h+m+s),b.lineTo(h+g+s,h+m-s),b.stroke(),b.fill(),b.restore();if(e===f||e==="objects"){b.save();s=0;for(r=this._nodes.length;s<
r;++s)n=this._nodes[s],b.fillStyle="#5500FF",b.strokeStyle=n.visible===!0&&n.culled===!1?"#FFFFFF":"#000000",b.beginPath(),g=n.aabb[0][0],m=n.aabb[0][2],w=n.aabb[1][0]-g,t=n.aabb[1][2]-m,b.rect(h+g,o+m,w,t),b.stroke();b.restore()}if(e===f||e==="lights"){s=0;for(r=this._lights.length;s<r;++s)t=this._lights[s],b.fillStyle=t.culled===!1&&t.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),n=t.distance,g=t.position[0],m=t.position[2],b.arc(h+g,o+
m,n,0,Math.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),g=t.aabb[0][0],m=t.aabb[0][2],w=t.aabb[1][0]-g,t=t.aabb[1][2]-m,b.rect(h+g,o+m,w,t),b.closePath(),b.stroke();s=0;for(r=this._static_lights.length;s<r;++s)t=this._static_lights[s],b.fillStyle=t.culled===!1&&t.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),n=t.distance,g=t.position[0],m=t.position[2],b.arc(h+g,o+m,n,0,Math.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),
g=t.aabb[0][0],m=t.aabb[0][2],w=t.aabb[1][0]-g,t=t.aabb[1][2]-m,b.rect(h+g,o+m,w,t),b.closePath(),b.stroke()}if(e!="lights"&&e!="objects"&&e!="map"){b.save();g=this._nodes;s=0;for(t=g.length;s<t;++s)if(n=g[s],n.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();g=n.aabb[0][0];m=n.aabb[0][2];w=n.aabb[1][0]-g;t=n.aabb[1][2]-m;b.rect(h+g,o+m,w,t);b.closePath();b.stroke();g=n.octree_aabb;b.strokeStyle="#0000FF";d(g[0][0],g[0][2],g[1][0],g[1][2]);b.lineWidth=1;if(n.common_root!==null)b.strokeStyle=
"#00FF00";break}b.lineWidth=1;b.strokeStyle="#FFFF00";d(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}s=0;for(r=this._children.length;s<r;++s)this._children[s]!==null&&this._children[s].draw_on_map(a,b,e)};x.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=
this._position[2]-this._size/2};x.prototype.get_frustum_hits=function(a,b){var e={objects:[],lights:[]};if((b===f||b===!0)&&!this.contains_point(a.position)){if(r.intersects(a.frustum.sphere,this._sphere)===!1)return e;var d=a.frustum.contains_sphere(this._sphere);if(d===-1)return this._debug_visible=!1,e;else if(d===1)this._debug_visible=2,b=!1;else if(d===0)if(this._debug_visible=!0,d=a.frustum.contains_box(this._bbox),d===-1)return this._debug_visible=!1,e;else if(d===1)this._debug_visible=3,b=
!1}var h,g,d=0;for(h=this._nodes.length;d<h;++d)g=this._nodes[d],e.objects.push(g),g.dynamic_lights=[].concat(this._lights),g.was_culled=g.culled,g.culled=!1,g.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;d=0;for(h=this._lights.length;d<h;++d)if(g=this._lights[d],g.visible===!0)e.lights.push(g),g.was_culled=g.culled,g.culled=!1;d=0;for(h=this._static_lights.length;d<h;++d)if(g=this._static_lights[d],g.visible===!0)g.culled=!1;for(d=0;d<8;++d)if(this._children[d]!==
null){h=this._children[d].get_frustum_hits(a,b);var m;g=0;for(m=h.objects.length;g<m;++g){e.objects.push(h.objects[g]);for(var v=h.objects[g].dynamic_lights,w=0,t=this._lights.length;w<t;++w)v.indexOf(this._lights[w])<0&&v.push(this._lights[w])}g=0;for(m=h.lights.length;g<m;++g)e.lights.indexOf(h.lights[g])<0&&e.lights.push(h.lights[g])}return e};x.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=!0;a=0;for(b=this._lights.length;a<
b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};q.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};q.prototype.attach=function(a){this._object=a};m.prototype.extract=function(a,b,e){var d=CubicVR.vec3;if(!(b===f||e===f)){var h=CubicVR.mat4.multiply(e,b),b=this._planes;b[n.frustum.plane.LEFT][0]=h[3]+h[0];b[n.frustum.plane.LEFT][1]=
h[7]+h[4];b[n.frustum.plane.LEFT][2]=h[11]+h[8];b[n.frustum.plane.LEFT][3]=h[15]+h[12];b[n.frustum.plane.RIGHT][0]=h[3]-h[0];b[n.frustum.plane.RIGHT][1]=h[7]-h[4];b[n.frustum.plane.RIGHT][2]=h[11]-h[8];b[n.frustum.plane.RIGHT][3]=h[15]-h[12];b[n.frustum.plane.TOP][0]=h[3]-h[1];b[n.frustum.plane.TOP][1]=h[7]-h[5];b[n.frustum.plane.TOP][2]=h[11]-h[9];b[n.frustum.plane.TOP][3]=h[15]-h[13];b[n.frustum.plane.BOTTOM][0]=h[3]+h[1];b[n.frustum.plane.BOTTOM][1]=h[7]+h[5];b[n.frustum.plane.BOTTOM][2]=h[11]+
h[9];b[n.frustum.plane.BOTTOM][3]=h[15]+h[13];b[n.frustum.plane.NEAR][0]=h[3]+h[2];b[n.frustum.plane.NEAR][1]=h[7]+h[6];b[n.frustum.plane.NEAR][2]=h[11]+h[10];b[n.frustum.plane.NEAR][3]=h[15]+h[14];b[n.frustum.plane.FAR][0]=h[3]-h[2];b[n.frustum.plane.FAR][1]=h[7]-h[6];b[n.frustum.plane.FAR][2]=h[11]-h[10];b[n.frustum.plane.FAR][3]=h[15]-h[14];for(var o=0;o<6;++o)g.normalize(b[o]);o=-b[n.frustum.plane.NEAR][3];b=b[n.frustum.plane.FAR][3]-o;e=b*(1/e[5]);e=d.subtract([0,0,o+b*0.5],[e,e,o+b]);e=d.length(e);
h=[h[3],h[9],h[10]];o=d.length(h);h=d.multiply(h,1/o);a=[a.position[0],a.position[1],a.position[2]];a=d.add(a,d.multiply(h,b*0.5));a=d.add(a,d.multiply(h,1));this.sphere=[a[0],a[1],a[2],e]}};m.prototype.contains_sphere=function(a){for(var b=CubicVR.vec3,e=this._planes,d=0;d<6;++d){var h=e[d],h=b.dot([h[0],h[1],h[2]],[a[0],a[1],a[2]])+h.d;this.last_in[d]=1;if(h<-a[3])return-1;if(Math.abs(h)<a[3])return 0}return 1};m.prototype.draw_on_map=function(a,b){var e=a.width/2,d=a.height/2;b.save();for(var h=
this._planes,g=[0,1,4,5],f=0,m=g.length;f<m;++f){var w=h[g[f]];b.strokeStyle="#FF00FF";if(f<this.last_in.length&&this.last_in[f])b.strokeStyle="#FFFF00";var t=-e,s=e,n=(-w[3]-w[0]*s)/w[2];b.moveTo(e+t,d+(-w[3]-w[0]*t)/w[2]);b.lineTo(e+s,d+n);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(e+this.sphere[0],d+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);b.closePath();b.stroke();b.restore()};m.prototype.contains_box=function(a){var b=0,e=[];e[0]=a[0];e[1]=[a[0][0],a[0][1],a[1][2]];e[2]=[a[0][0],
a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,d=0;d<6;++d){for(var h=8,o=1,f=0;f<8;++f)g.classifyPoint(a[d],e[f])===-1&&(o=0,--h);this.last_in[d]=o;if(h===0)return-1;b+=o}if(b===6)return 1;return 0};return{Frustum:m,Octree:x}});CubicVR.RegisterModule("Particles",function(y){function x(f,g,m,n,a,c,b){if(f){this.last_particle=this.particles=null;this.pTex=m!==q?m:null;this.vWidth=n;this.vHeight=a;this.alpha=c!==q?c:!1;this.alphaCut=b!==q?b:0;this.pfunc=function(a,d){var c=d-a.start_time;if(c<0)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];this.pgov!==null&&this.pgov(a,
d);return 1};this.pgov=null;this.hasColor=g===q?!1:g;m=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",m?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",m?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",m?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",m?"uniform sampler2D pMap;":"","varying vec4 color;",m?"varying vec2 screenPos;":"",m?"uniform vec3 screenDim;":"",m?"varying float pSize;":"","void main(void) {\nvec4 c = color;",m?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",m?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",m?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=f;this.numParticles=0;this.arPoints=new Float32Array(f*3);this.glPoints=null;if(g)this.arColor=new Float32Array(f*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[n,a,0]));this.genBuffer()}}var q=y.undef,m=y.GLCore;x.prototype={resizeView:function(f,g){this.vWidth=f;this.vHeight=g;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[f,g,0]))},addParticle:function(f){this.last_particle===null?this.particles=f:this.last_particle.nextParticle=f;this.last_particle=f},genBuffer:function(){var f=m.gl;this.glPoints=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,this.glPoints);f.bufferData(f.ARRAY_BUFFER,this.arPoints,f.DYNAMIC_DRAW);if(this.hasColor)this.glColor=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.glColor),f.bufferData(f.ARRAY_BUFFER,this.arColor,f.DYNAMIC_DRAW)},updatePoints:function(){var f=m.gl;f.bindBuffer(f.ARRAY_BUFFER,
this.glPoints);f.bufferData(f.ARRAY_BUFFER,this.arPoints,f.DYNAMIC_DRAW)},updateColors:function(){var f=m.gl;this.hasColor&&(f.bindBuffer(f.ARRAY_BUFFER,this.glColor),f.bufferData(f.ARRAY_BUFFER,this.arColor,f.DYNAMIC_DRAW))},draw:function(f,g,r){var n=m.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(n.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",f);this.shader_particle.setMatrix("uPMatrix",g);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);
n.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,n.FLOAT,!1,0,0);n.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(r!==q){this.numParticles=0;if(this.particles===null){n.disable(n.BLEND);return}for(var f=this.particles,g=null,a=0;f!==null;){var c=this.numParticles*
3,b=this.pfunc(f,r);if(b===1){if(this.arPoints[c]=f.pos[0],this.arPoints[c+1]=f.pos[1],this.arPoints[c+2]=f.pos[2],f.color!==null&&this.arColor!==q&&(this.arColor[c]=f.color[0],this.arColor[c+1]=f.color[1],this.arColor[c+2]=f.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(b===-1){if(g!==null)g.nextParticle=f.nextParticle}else b===0&&a++;g=f;f=f.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(n.enable(n.BLEND),n.enable(n.DEPTH_TEST),n.depthMask(0),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_COLOR));n.drawArrays(n.POINTS,0,this.numParticles);this.alpha&&(n.disable(n.BLEND),n.depthMask(1),n.blendFunc(n.ONE,n.ONE));this.hasColor&&n.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:x,Particle:function(f,g,m,n,a){this.startpos=new Float32Array(f);this.pos=new Float32Array(f);this.velocity=new Float32Array(n!==q?n:[0,0,0]);this.accel=new Float32Array(a!==q?a:[0,0,
0]);this.start_time=g!==q?g:0;this.life_time=m!==q?m:0;this.nextParticle=this.color=null}}});CubicVR.RegisterModule("PostProcess",function(y){function x(a){if(a.shader_vertex===f)return null;if(a.shader_fragment===f)return null;this.outputMode=a.outputMode===f?r.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===f?null:a.onresize;this.onupdate=a.onupdate===f?null:a.onupdate;this.init=a.init===f?null:a.init;this.enabled=a.enabled===f?!0:a.enabled;this.outputDivisor=a.outputDivisor===f?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,a.shader_fragment);this.shader.use();
this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function q(a,b,e){var d=g.gl;this.width=a;this.height=b;this.accum=e===f?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,b,!0);this.bufferA=new CubicVR.RenderBuffer(a,b,!1);this.bufferB=new CubicVR.RenderBuffer(a,b,!1);this.bufferC=new CubicVR.RenderBuffer(a,
b,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,b,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),this.blur_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.bufferB.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,b)}function m(a,b,e){this.createBuffer(a,b,e)}var f=y.undef,g=y.GLCore,r=CubicVR.enums;r.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var n=[],a=[];q.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,b){var e=g.gl,d=[],h=a/a,o=b/b;d.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);d.vbo_uvs=new Float32Array([0,0,h,0,h,o,0,o,0,0,h,o]);d.gl_points=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,
d.gl_points);e.bufferData(e.ARRAY_BUFFER,d.vbo_points,e.STATIC_DRAW);d.gl_uvs=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d.gl_uvs);e.bufferData(e.ARRAY_BUFFER,d.vbo_uvs,e.STATIC_DRAW);return d},destroyFSQuad:function(a){var b=g.gl;b.deleteBuffer(a.gl_points);b.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,b){var e=g.gl;a.use();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindBuffer(e.ARRAY_BUFFER,b.gl_points);e.vertexAttribPointer(a.aVertex,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aVertex);
e.bindBuffer(e.ARRAY_BUFFER,b.gl_uvs);e.vertexAttribPointer(a.aTex,2,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aTex);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.drawArrays(e.TRIANGLES,0,6)},addShader:function(c){this.shaders[this.shaders.length]=c;c.shader.use();c.shader.setVector("texel",this.vTexel);if(c.outputDivisor&&c.outputDivisor!=1&&n[c.outputDivisor]===f){var b=this.width/c.outputDivisor|0,e=this.height/c.outputDivisor|0;n[c.outputDivisor]=new CubicVR.RenderBuffer(b,e,!1);a[c.outputDivisor]=
this.makeFSQuad(b,e)}},resize:function(c,b){var e=g.gl;this.width=c;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var d in n){var e=this.width/d|0,h=this.height/d|0;n[d].destroyBuffer();n[d].createBuffer(e,h,!1);this.destroyFSQuad(a[d]);a[d]=this.makeFSQuad(e,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;d=0;for(e=this.shaders.length;d<e;d++)if(this.shaders[d].shader.use(),this.shaders[d].shader.setVector("texel",this.vTexel),this.shaders[d].onresize!==null)this.shaders[d].onresize(this.shaders[d].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(){this.captureBuffer.use()},end:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var c=g.gl;this.captureBuffer.texture.use(c.TEXTURE1);this.outputBuffer.use();this.captureBuffer.texture.use(c.TEXTURE0);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);
this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var b=0,e=0,d=this.shaders.length;e<d;e++){var h=this.shaders[e];if(h.enabled){this.swap();this.inputBuffer.texture.use(c.TEXTURE0);var o=h.outputMode;if(o===r.post.output.REPLACE)h.outputDivisor!==1?n[h.outputDivisor].use():this.outputBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);else if(o===r.post.output.ADD||o===r.post.output.BLEND)h.outputDivisor!==1?n[h.outputDivisor].use():this.bufferC.use(),c.clearColor(0,
0,0,1),c.clear(c.COLOR_BUFFER_BIT);h.onupdate!==null&&(h.shader.use(),h.onupdate(h.shader));h.outputDivisor!==1?(c.viewport(0,0,n[h.outputDivisor].width,n[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===r.post.output.REPLACE?(this.outputBuffer.use(),n[h.outputDivisor].texture.use(c.TEXTURE0),c.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,this.fsQuad)):c.viewport(0,0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);
o===r.post.output.BLEND?(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(c.TEXTURE0),h.outputDivisor!==1?n[h.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND)):o===r.post.output.ADD&&(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),h.outputDivisor!==1?n[h.outputDivisor].texture.use(c.TEXTURE0):
this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND));this.end();b++}}b===0?this.captureBuffer.texture.use(c.TEXTURE0):this.outputBuffer.texture.use(c.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),c.disable(c.BLEND),
this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(c.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),c.disable(c.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};m.prototype={createBuffer:function(a,b,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=
parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),d=g.gl;this.fbo=d.createFramebuffer();if(e)this.depth=d.createRenderbuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.fbo);e&&(d.bindRenderbuffer(d.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,a,b),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.depth)):(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_STENCIL,a,b),d.framebufferRenderbuffer(d.FRAMEBUFFER,
d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;d.bindTexture(d.TEXTURE_2D,y.Textures[this.texture.tex_id]);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.UNSIGNED_BYTE,null);d.framebufferTexture2D(d.FRAMEBUFFER,
d.COLOR_ATTACHMENT0,d.TEXTURE_2D,y.Textures[this.texture.tex_id],0);d.bindFramebuffer(d.FRAMEBUFFER,null)},destroyBuffer:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(y.Textures[this.texture.tex_id]);y.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=g.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)}};return{RenderBuffer:m,PostProcessShader:x,PostProcessChain:q,fsQuad:{make:q.prototype.makeFSQuad,
destroy:q.prototype.destroyFSQuad,render:q.prototype.renderFSQuad}}});CubicVR.RegisterModule("Polygon",function(y){function x(a){var c=[],b=a.length;if(b<3)return null;var g=[],f;f=a.length;for(var m=0,t=f-1,s=0;s<f;t=s++)m+=a[t][0]*a[s][1]-a[s][0]*a[t][1];if(0<m*0.5)for(f=0;f<b;f++)g[f]=f;else for(f=0;f<b;f++)g[f]=b-1-f;s=2*b;m=0;for(f=b-1;b>2;){if(0>=s--)return null;var n=f;b<=n&&(n=0);f=n+1;b<=f&&(f=0);t=f+1;b<=t&&(t=0);var r;a:{r=a;var q=n,A=f,u=t,x=b,y=g,C=void 0,Z=void 0,L=void 0,E=void 0,F=void 0,H=void 0,O=void 0,J=void 0,P=void 0,Z=r[y[q]][0],L=r[y[q]][1],
E=r[y[A]][0],F=r[y[A]][1],H=r[y[u]][0],O=r[y[u]][1];if(e>(E-Z)*(O-L)-(F-L)*(H-Z))r=!1;else{for(C=0;C<x;C++)if(!(C==q||C==A||C==u)){var J=r[y[C]][0],P=r[y[C]][1],R=void 0,M=void 0,Q=void 0,N=void 0,T=void 0,X=void 0,Y=void 0,S=void 0,$=void 0,U=void 0,V=void 0,W=void 0,R=Q=T=void 0,R=H-E,M=O-F,Q=Z-H,N=L-O,T=E-Z,X=F-L,Y=J-Z,S=P-L,$=J-E,U=P-F,V=J-H,W=P-O,R=R*U-M*$,T=T*S-X*Y,Q=Q*W-N*V;if(R>=0&&Q>=0&&T>=0){r=!1;break a}}r=!0}}if(r){s=g[n];n=g[f];t=g[t];c.push(s);c.push(n);c.push(t);m++;t=f;for(s=f+1;s<
b;t++,s++)g[t]=g[s];b--;s=2*b}}return c}function q(a,c,e){e===b&&(e=0);var g;g=x(c);var f=CubicVR.util.repackArray(g,3,g.length/3),m=[],t=a.points.length;g=0;for(iMax=c.length;g<iMax;g++)m.push([c[g][0],c[g][1],e]);a.addPoint(m);g=0;for(iMax=f.length;g<iMax;g++)a.addFace([f[g][0]+t,f[g][1]+t,f[g][2]+t])}function m(a,c){var b=c[0]-a[0],e=c[1]-a[1];return Math.sqrt(b*b+e*e)}function f(a,c){var b,e,g=[],f=a.length,t=c.length,s=[];for(b=0;b<f;b++)for(e=0;e<t;e++){var n=m(a[b],c[e]);g.push([n,b,e])}g.sort(function(a,
d){return a[0]>d[0]});for(b=0;b<5;b++)for(e=0;e<g.length;e++)b!=e&&g[b][1]!=g[e][1]&&g[b][2]!=g[e][2]&&g[b][1]<g[e][1]&&g[b][2]<g[e][2]&&Math.abs(g[b][1]-g[e][1])<4&&Math.abs(g[b][2]-g[e][2])<4&&s.push([b,e]);s.sort(function(a,d){return g[a[0]][0]+g[a[1]][0]>g[d[0]][0]+g[d[1]][0]});if(s.length>10)s.length=10;e=[];for(b=0;b<s.length;b++)e.push([g[s[b][0]],g[s[b][1]]]);return e}function g(a,b){var c=f(a,b),e;if(!c.length)return null;e=c[0][0];var g=c[0][1],c=g[1]-e[1],g=g[2]-e[2],m=a.slice(e[1]),m=
m.concat(a.slice(0,e[1])),t=b.slice(e[2]),t=t.concat(b.slice(0,e[2])),s=[];for(e=c;e<m.length;e++)s.push(m[e]);s.push(m[0]);for(e=g;e<t.length;e++)s.push(t[e]);s.push(t[0]);var n=[];for(e=0;e<=c;e++)n.push(m[e]);for(e=0;e<=g;e++)n.push(t[e]);return[s,n]}function r(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function n(a,b,c){for(var e=[],g=0;g<a.length;g++){var f=[a[g][0]-b[0],a[g][1]-b[1]],m=Math.sqrt(f[0]*f[0]+f[1]*f[1])+c,f=Math.atan2(f[1],
f[0]);e[g]=[b[0]+Math.cos(f)*m,b[1]+Math.sin(f)*m]}return e}function a(a,b,c,e,g){var f,m=a.points.length;if(b.length!=c.length)return null;var s=b.length;for(f=0;f<s;f++)a.addPoint([b[f][0],b[f][1],e]);for(f=0;f<s;f++)a.addPoint([c[f][0],c[f][1],g]);for(f=0;f<s-1;f++)a.addFace([m+f,m+f+1,m+(f+s+1),m+(f+s)]);f=s-1;a.addFace([m+f,m,m+s,m+(f+s)])}function c(a){this.points=a;this.cuts=[];this.result=[]}var b=y.undef,e=1.0E-10;c.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var c=this.cuts[b].points.slice(0),c=c.reverse(),c=g(this.result[0],c);this.result[0]=c[0];this.result.push(c[1])}for(b=0;b<this.result.length;b++)q(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(d,c,e){if(this.points.length!==0){var f,m;c===b&&(c=0);e===b&&(e=0);var n=c!=e;d||(d=new CubicVR.Mesh);this.result=[this.points];for(m=0;m<this.cuts.length;m++)f=this.cuts[m].points.slice(0),
f=f.reverse(),f=g(this.result[0],f),this.result[0]=f[0],this.result.push(f[1]);f=new CubicVR.Mesh;for(m=0;m<this.result.length;m++)q(f,this.result[m],e);d.booleanAdd(f);f.flipFaces();if(n)for(m=0;m<f.points.length;m++)f.points[m][2]=c;d.booleanAdd(f);if(n){a(d,this.points,this.points,c,e);for(m=0;m<this.cuts.length;m++)f=this.cuts[m].points.slice(0),f=f.reverse(),a(d,f,f,c,e)}d.removeDoubles();return d}},toExtrudedBeveledMesh:function(d,b,c,e,f,m,t){var s=[],B=[],x,y,A,u;if(this.points.length!==0){typeof b===
"object"&&(t=b,b=t.front||0,c=t.back||0,e=t.frontDepth||0,f=t.frontShift||0,m=t.backDepth||0,t=t.backShift||0);var K=b!==c,D=m!==0,C=e!==0;d||(d=new CubicVR.Mesh);C?(y=r(this.points),y=n(this.points,y,-f),this.result=[y.slice(0)]):this.result=[this.points.slice(0)];for(u=0;u<this.cuts.length;u++)A=r(this.cuts[u].points),A=n(this.cuts[u].points,A,f),A=A.reverse(),s.push(A),A=g(this.result[0],A),this.result[0]=A[0],this.result.push(A[1]);f=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)q(f,this.result[u],
b-e);f.flipFaces();d.booleanAdd(f);if(D||C){x=r(this.points);x=n(this.points,x,-t);this.result=[x.slice(0)];for(u=0;u<this.cuts.length;u++)A=r(this.cuts[u].points),A=n(this.cuts[u].points,A,t),A=A.reverse(),B.push(A),A=g(this.result[0],A),this.result[0]=A[0],this.result.push(A[1]);f=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)q(f,this.result[u],c+m)}else{for(u=0;u<f.points.length;u++)f.points[u][2]=c;f.flipFaces()}d.booleanAdd(f);C&&a(d,y,this.points,b-e,b);K&&a(d,this.points,this.points,b,
c);D&&a(d,this.points,x,c,c+m);for(u=0;u<s.length;u++)A=this.cuts[u].points.slice(0).reverse(),C&&a(d,s[u],A,b-e,b),K&&a(d,A,A,b,c),D&&a(d,A,B[u],c,c+m);d.removeDoubles();return d}}};return{polygon:{triangulate2D:x,toMesh:q,findNearPair:function(a,b){for(var c=[0,0],e=m(a[0],b[0]),g=a.length,f=b.length,t=0;t<g;t++)for(var s=0;s<f;s++){var n=m(a[t],b[s]);n<e&&(c[0]=t,c[1]=s,e=n)}return c},subtract:g,addOffset:function(a,b){for(var c=[],e=0,g=a.length;e<g;e++){var f=a[e];c.push([f[0]+b[0],f[1]+b[1]])}return c}},
Polygon:c}});CubicVR.RegisterModule("Primitives",function(y){function x(b,d,h,g,f,m){var n=CubicVR.mat4,t=CubicVR.vec3,s=[],r,q=[0,1,0],x=[1,0,0],A=[0,0,0],u=b.points.length,y,D,C;for(y=r=0;y<c;y+=c/h){if(r===h)break;x=[Math.cos(y),0,Math.sin(y)];D=0;for(C=d.length;D<C;D++)A=t.add(t.multiply(x,d[D][0]),t.multiply(q,d[D][1])),s[r]===a&&(s[r]=[]),s[r].push(A);r++}C=null;f!==a&&(C=f.getResult!==a?f.getResult():f);for(D=0;D<h;D++){f=0;for(r=d.length;f<r;f++)C?b.addPoint(n.vec3_multiply(s[D][f],C)):b.addPoint(s[D][f])}typeof g===
"string"&&(g=new CubicVR.Material(g));b.setFaceMaterial(g);for(f=0;f<h;f++){D=0;for(C=d.length-1;D<C;D++)n=D+d.length*f,s=D+d.length*((f+1)%h),t.equal(b.points[u+n],b.points[u+s])?b.addFace([u+n+1,u+s+1,u+s]):t.equal(b.points[u+n+1],b.points[u+s+1])?b.addFace([u+n,u+n+1,u+s]):b.addFace([u+n,u+n+1,u+s+1,u+s])}m!==a&&(d=null,m.apply!==a?d=m:m&&(d=new CubicVR.UVMapper(m)),d!==null&&(b.calcFaceNormals(),d.apply(b,g)))}function q(b,d,c,g,f){var m=CubicVR.mat4;d*=0.5;var n=b.points.length;typeof c==="string"&&
(c=new CubicVR.Material(c));b.setFaceMaterial(c);g!==a?(g=g.getResult!==a?g.getResult():g,b.addPoint([m.vec3_multiply([d,-d,0],g),m.vec3_multiply([d,d,0],g),m.vec3_multiply([-d,d,0],g),m.vec3_multiply([-d,-d,0],g)])):b.addPoint([[d,-d,0],[d,d,0],[-d,d,0],[-d,-d,0]]);b.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);f!==a&&(m=null,f.apply!==a?m=f:f&&(m=new CubicVR.UVMapper(f)),m!==null&&(b.calcFaceNormals(),m.apply(b,c)))}function m(b,d,c,g,f){var m=CubicVR.mat4,n,t;typeof d==="object"?(n=d[0]/2,t=
d[1]/2,d=d[2]/2):n=t=d/=2;var s=b.points.length;typeof c==="string"&&(c=new CubicVR.Material(c));b.setFaceMaterial(c);g!==a?(g=g.getResult!==a?g.getResult():g,b.addPoint([m.vec3_multiply([n,-t,d],g),m.vec3_multiply([n,t,d],g),m.vec3_multiply([-n,t,d],g),m.vec3_multiply([-n,-t,d],g),m.vec3_multiply([n,-t,-d],g),m.vec3_multiply([n,t,-d],g),m.vec3_multiply([-n,t,-d],g),m.vec3_multiply([-n,-t,-d],g)])):b.addPoint([[n,-t,d],[n,t,d],[-n,t,d],[-n,-t,d],[n,-t,-d],[n,t,-d],[-n,t,-d],[-n,-t,-d]]);b.addFace([[s+
0,s+1,s+2,s+3],[s+7,s+6,s+5,s+4],[s+4,s+5,s+1,s+0],[s+5,s+6,s+2,s+1],[s+6,s+7,s+3,s+2],[s+7,s+4,s+0,s+3]]);f!==a&&(m=null,f.apply!==a?m=f:f&&(m=new CubicVR.UVMapper(f)),m!==null&&(b.calcFaceNormals(),m.apply(b,c)))}function f(a,d,b,g,f,m,n,t){var s=[];b-=d;d+=b/2;for(var r=c/f,q=0,x=0;x<=f;x++)s.push([d+Math.cos(q)*b,Math.sin(q)*b,0]),q+=r;CubicVR.genLatheObject(a,s,g,m,n,t)}function g(a,d,b,c,g,f,m){CubicVR.genLatheObject(a,[[0,-b/2,0],[d/2,-b/2,0],[0,b/2,0]],c,g,f,m)}function r(a,d,b,c,g,f,m){CubicVR.genLatheObject(a,
[[0,-b/2,0],[d,-b/2,0],[d,b/2,0],[0,b/2,0]],c,g,f,m)}function n(a,d,c,g,f,m,n){var t=[],g=(g/=2)|0;c|=0;for(var s=Math.PI/g,r=-b,q=0;q<=g;q++)t.push([Math.cos(r)*d,Math.sin(r)*d,0]),r+=s;CubicVR.genLatheObject(a,t,c,f,m,n)}var a=y.undef,c=2*Math.PI,b=Math.PI/2;return{genPlaneObject:q,genBoxObject:m,genLatheObject:x,genTorusObject:f,genConeObject:g,genCylinderObject:r,genSphereObject:n,primitives:{lathe:function(b){var d,c;if(b.points==a)return null;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?
b.name:a);c=b.material!==a?b.material:new CubicVR.Material;x(d,b.points,b.divisions!==a?b.divisions:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},box:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;m(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},plane:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?
b.material:new CubicVR.Material;q(d,b.size!==a?b.size:1,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},sphere:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;n(d,b.radius!==a?b.radius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},torus:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:
new CubicVR.Material;f(d,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},cone:function(b){var d,c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;g(d,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d},cylinder:function(b){var d,
c;d=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);c=b.material!==a?b.material:new CubicVR.Material;r(d,b.radius!==a?b.radius:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,c,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return d}}}});CubicVR.RegisterModule("Renderer",function(y){var x=y.undef;return{renderObject:function(q,m,f,g,r,n){var a=!1,r=r||!1,n=n||!1;if(q.compiled!==null){var c=0,b=CubicVR.GLCore.gl,e,d=g===x?0:g.length,h,o=0,z,v=null,w=q.instanceMaterials||q.materials,t=!1,s,B,I;b.depthFunc(b.LEQUAL);f===x&&(f=cubicvr_identity);for(var G=0,A=q.compiled.elements_ref.length;G<A;G++){var v=w[G],u=0;e=!1;if(v.opacity<1&&r)a=!0;else if(!(n&&v.opacity>=1)){v.opacity!==1?(b.enable(b.BLEND),b.depthMask(0),b.blendFunc(b.SRC_ALPHA,
b.ONE_MINUS_SRC_ALPHA)):(b.depthMask(1),b.disable(b.BLEND),b.blendFunc(b.ONE,b.ONE));for(var K=0,D=q.compiled.elements_ref[G].length;K<D;K++)if(z=q.compiled.elements_ref[G][K][0],e=!1,o=q.compiled.elements_ref[G][K][1],u+=o,!q.segment_state[z])if(u>o){c+=o*2;u-=o;if(d){B=!1;for(s=0;s<d;){e=d-s;if(e>y.MAX_LIGHTS)e=y.MAX_LIGHTS;s>0&&!B&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),b.depthFunc(b.EQUAL),B=!0);h=g[s];I=h.light_type;for(o=0;o<e;o++)if(g[o+s].light_type!=I){e=o;break}v.use(h.light_type,e);
h=v.shader[h.light_type][e];b.uniformMatrix4fv(h.uMVMatrix,!1,m.mvMatrix);b.uniformMatrix4fv(h.uPMatrix,!1,m.pMatrix);b.uniformMatrix4fv(h.uOMatrix,!1,f);b.uniformMatrix3fv(h.uNMatrix,!1,m.nMatrix);t||(v.bindObject(q,h),t=h.aTextureCoord!=-1);for(o=0;o<e;o++)g[o+s].setupShader(h,o);b.drawElements(b.TRIANGLES,u,b.UNSIGNED_SHORT,c);s+=e}B&&(b.disable(b.BLEND),b.depthFunc(b.LEQUAL))}else v.use(0,0),b.uniformMatrix4fv(v.shader[0][0].uMVMatrix,!1,m.mvMatrix),b.uniformMatrix4fv(v.shader[0][0].uPMatrix,
!1,m.pMatrix),b.uniformMatrix4fv(v.shader[0][0].uOMatrix,!1,f),b.uniformMatrix3fv(v.shader[0][0].uNMatrix,!1,m.nMatrix),t||(v.bindObject(q,v.shader[0][0]),t=v.shader[0][0].aTextureCoord!=-1),b.drawElements(b.TRIANGLES,u,b.UNSIGNED_SHORT,c);c+=u*2;u=0;e=!0}else c+=u*2,u=0;if(!e&&q.segment_state[z]){if(d){B=!1;for(s=0;s<d;){e=d-s;if(e>y.MAX_LIGHTS)e=y.MAX_LIGHTS;s>0&&!B&&(b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),b.depthFunc(b.EQUAL),B=!0);h=g[s];I=h.light_type;for(o=0;o<e;o++)if(g[o+s].light_type!=
I){e=o;break}v.use(h.light_type,e);h=v.shader[h.light_type][e];b.uniformMatrix4fv(h.uMVMatrix,!1,m.mvMatrix);b.uniformMatrix4fv(h.uPMatrix,!1,m.pMatrix);b.uniformMatrix4fv(h.uOMatrix,!1,f);b.uniformMatrix3fv(h.uNMatrix,!1,m.nMatrix);t||(v.bindObject(q,h),t=h.aTextureCoord!=-1);for(o=0;o<e;o++)g[o+s].setupShader(h,o);b.drawElements(b.TRIANGLES,u,b.UNSIGNED_SHORT,c);s+=e}B&&(b.disable(b.BLEND),b.depthFunc(b.LEQUAL))}else v.use(0,0),b.uniformMatrix4fv(v.shader[0][0].uMVMatrix,!1,m.mvMatrix),b.uniformMatrix4fv(v.shader[0][0].uPMatrix,
!1,m.pMatrix),b.uniformMatrix4fv(v.shader[0][0].uOMatrix,!1,f),b.uniformMatrix3fv(v.shader[0][0].uNMatrix,!1,m.nMatrix),t||(v.bindObject(q,v.shader[0][0]),t=v.shader[0][0].aTextureCoord!=-1),b.drawElements(b.TRIANGLES,u,b.UNSIGNED_SHORT,c);c+=u*2}}}v&&h?v.clearObject(q,h):v.clearObject(q,null);b.depthMask(1);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return a}}}});CubicVR.RegisterModule("EventHandler",function(y){function x(g){g=g||{};this.name=g.name;this.id=g.id;this.interval=g.interval||0;this.enabled=g.enabled||!0;this.action=g.action||null;this.properties=g.properties||{};this.event_properties=g.event_properties||{};this.buffered=g.buffered||!1;this.weight=g.weight===m?-1:g.weight;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function q(){this.events=[];this.eventProperties=
[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var m=y.undef,f=CubicVR.enums;f.event={TICK:"tick",MOVE:"move",MATRIX_UPDATE:"matrixUpdate",OCTREE_ADJUST:"octreeAdjust",COLLIDE:"collide",CONTACT:"contact",CONTACT_ADD:"contactAdd",CONTACT_REMOVE:"contactRemove",CONTACT_GHOST:"contactGhost",RIGID_REST:"rigidRest",RIGID_AWAKE:"rigidAwake"};x.prototype={getName:function(){return this.name},setName:function(g){this.name=g},getId:function(){return this.id},
setId:function(g){this.id=g},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},setEnabled:function(g){if(g&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=g},isBuffered:function(){return this.buffered},setBuffered:function(g){this.buffered=g},setInterval:function(g){this.interval=g},getInterval:function(){return this.interval},
setAction:function(g){this.action=g},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(g){this.properties=g},getProperty:function(g){return this.properties[g]},setProperty:function(g,f){this.properties[g]=f},setEventProperties:function(g){this.event_properties=g},getEventProperties:function(){return this.event_properties},getEventProperty:function(g){return this.event_properties[g]},setEventProperty:function(g,f){this.properties[g]=f},
getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(g){this.t_rest=g},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(g){this.setRestInterval(g||0)},awake:function(){this.t_rest=
0},update:function(g,f){if(!this.enabled)return!1;var m=0,a=!0;if(this.n_updates===0)this.t_updatecall=this.t_update=g,m=1/60;else if(g!==this.t_update){if(!this.t_rest)this.t_last=g-this.t_update,this.t_update=g;m=g-this.t_updatecall;this.t_updatecall=g}else a=!1;if(this.t_rest>0){if(a&&(this.t_resting+=m,this.t_rest-=m,this.t_rest<0))this.t_rest=0}else{if(a){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(f);return!0}a&&this.n_updates++;
return!1},callEvent:function(g){if(!this.action)return!1;return this.action(this,g)}};q.prototype={addEvent:function(g){g.callEvent||(g=new x(g));var f=g.getId();this.eventProperties[f]||(this.eventProperties[f]={});this.listeners[f]=this.listeners[f]||0;this.listeners[f]++;this.events.push(g);this.listenerNames.indexOf(f)===-1&&this.listenerNames.push(f);return g},removeEvent:function(g){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(g)==-1&&this.lockRemovals.push(g)}else{var f=
this.events.indexOf(g);f!==-1&&(g=g.getId(),this.events.splice(f,1),this.listeners[g]--,this.listeners[g]||(this.eventHandled[g]=!0,this.eventParameters[g]={},this.eventProperties[g]=[],this.eventPropertyCount[g]=0,f=this.listenerNames.indexOf(g),f>=0&&this.listenerNames.splice(f,1)))}},getProperties:function(g){this.eventParameters[g]=this.eventParameters[g]||{};return this.eventParameters[g]},setProperties:function(g,f){this.eventParameters[g]=f},getProperty:function(g,f){return this.getProperties(g)[f]},
setProperty:function(g,f,m){this.getProperties(g)[f]=m},hasEvent:function(g){return!!this.listeners[g]},triggerEvent:function(g,f){if(!this.listeners[g])return null;this.eventProperties[g]==m&&(this.eventProperties[g]=[]);var n=this.eventProperties[g];this.eventPropertyCount[g]===m&&(this.eventPropertyCount[g]=0);var a=this.eventPropertyCount[g];a>20&&console.log("Warning, event "+g+" count > 20: "+a);n[a]=f&&n?f:n[a]||{};this.eventPropertyCount[g]++;this.eventHandled[g]=!1;return n[a]},update:function(g){var m,
n,a,c,b,e;if(this.hasEvent(f.event.TICK)&&this.eventPropertyCount[f.event.TICK]===0&&(m=this.triggerEvent(f.event.TICK)))m.time=g,m.handler=this;this.lockState=!0;m=0;for(n=this.events.length;m<n;m++){b=this.events[m];e=b.getId();c=this.eventPropertyCount[e];var d=!1;a=!1;if(c){var h=this.eventProperties[e];if(b.isEnabled()){if(b.isBuffered()){if(h.length=c,b.setEventProperties(h),d=d||b.update(g,this),b.isChainBroken()){b.breakChain(!1);break}}else for(a=0;a<c;a++)if(b.setEventProperties(h[m]),d=
d||b.update(g,this),b.isChainBroken()){b.breakChain(!1);break}a=!0}}if(d||!a)this.eventHandled[e]=!0}m=0;for(n=this.listenerNames.length;m<n;m++)e=this.listenerNames[m],this.eventHandled[e]&&(this.eventPropertyCount[e]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){m=0;for(n=this.lockRemovals.length;m<n;m++)this.removeEvent(this.lockRemovals[m]);this.lockRemovals.length=0}}};return{Event:x,EventHandler:q}});CubicVR.RegisterModule("Scene",function(y){function x(a,b){return a.light_type-b.light_type}function q(d,b){var e=null;d!==g&&d!==null&&(e=d.compile?null:d);e?(this.morphWeight=e.morphWeight||0,this.morphSource=e.morphSource||-1,this.morphTarget=e.morphTarget||-1,this.position=e.position===g?[0,0,0]:e.position,this.rotation=e.rotation===g?[0,0,0]:e.rotation,this.scale=e.scale===g?[1,1,1]:e.scale,this.shadowCast=e.shadowCast===g?!0:e.shadowCast,this.motion=e.motion===g?null:e.motion,this.obj=e.mesh===
g?d!==g&&e.faces!==g?d:null:e.mesh,this.name=e.name===g?b!==g?b:null:e.name,this.properties=e.properties||{}):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=d,this.name=b,this.shadowCast=!0,this.properties={});this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=c.identity();this.tMatrix=c.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=
null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null}function m(a,b,c,g,f,m){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=
this.collect_stats=!1;typeof a==="object"?(this.octree=a.octree,this.skybox=a.skybox||null,this.camera=new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip),this.name=a.name||"scene"+e,this.destroy=a.destroy||function(){},this.update=a.update||function(){},this.enable=a.enable||function(){},this.disable=a.disable||function(){},a=a.setup&&a.setup(this),this.update=a.update||this.update,this.enable=a.enable||this.enable,this.disable=a.disable||this.disable,this.destroy=a.destroy||this.destroy):
(this.skybox=null,this.octree=m,this.camera=new CubicVR.Camera(a,b,c,g,f),this.name="scene"+e);this.paused=!1;++e}function f(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var g=y.undef,r=CubicVR.enums,n=y.GLCore,a=CubicVR.aabb,c=CubicVR.mat4,b=0;q.prototype={addEvent:function(a){if(!this.eventHandler)this.eventHandler=new CubicVR.EventHandler;return this.eventHandler.addEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},
setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();
return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),c=0,g=b.length;c<g;c++)if(b[c].name==a)return b[c];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:
0},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(r.event.MATRIX_UPDATE)))a.triggerEvent(r.event.MATRIX_UPDATE).matrix=this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var b=CubicVR.vec3;if(!this.matrixLock&&(!b.equal(this.lposition,this.position)||!b.equal(this.lrotation,this.rotation)||!b.equal(this.lscale,this.scale)||a!==g))if(a!==g?this.tMatrix=a.slice(0):c.identity(this.tMatrix),c.identity(this.lMatrix),
c.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),c.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===1||c.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),c.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],
this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(r.event.MOVE)))a=a.triggerEvent(r.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var b=this.getAABB(),c=this.octree_aabb,e=b[0][0],f=b[0][1],m=b[0][2],n=b[1][0],t=b[1][1],
s=b[1][2],q=c[0][0],r=c[0][1],x=c[0][2],A=c[1][0],u=c[1][1],c=c[1][2];if(this.octree_leaves.length>0&&(e<q||f<r||m<x||n>A||t>u||s>c)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==g&&e._root!==null)e=e._root;else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},
bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,c){a===r.motion.POS?this.position[b]=c:a===r.motion.SCL?this.scale[b]=c:a===r.motion.ROT&&(this.rotation[b]=c)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var c=Array(8);this.doTransform();var e,f;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];e=this.obj.bb[0];f=this.obj.bb[1]}if(!this.obj||e===
g||f===g)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var m=e;e=b.subtract(f,e);c[0]=[m[0],m[1],m[2]];c[1]=[m[0],m[1],m[2]+e[2]];c[2]=[m[0]+e[0],m[1],m[2]];c[3]=[m[0]+e[0],m[1],m[2]+e[2]];c[4]=[m[0],m[1]+e[1],m[2]];c[5]=[m[0],m[1]+e[1],m[2]+e[2]];c[6]=[m[0]+e[0],m[1]+e[1],m[2]];c[7]=[m[0]+e[0],m[1]+e[1],m[2]+e[2]];m=a.vec3_multiply(c[0],this.tMatrix);e=[m[0],m[1],m[2]];f=[m[0],m[1],m[2]];for(b=1;b<8;++b)m=a.vec3_multiply(c[b],this.tMatrix),e[0]>m[0]&&(e[0]=m[0]),
e[1]>m[1]&&(e[1]=m[1]),e[2]>m[2]&&(e[2]=m[2]),f[0]<m[0]&&(f[0]=m[0]),f[1]<m[1]&&(f[1]=m[1]),f[2]<m[2]&&(f[2]=m[2]);this.aabb[0]=e;this.aabb[1]=f;this.dirty=!1}return this.aabb}};var e=0;m.prototype={attachOctree:function(d){this.octree=d;d.init&&d.init(this);d=this.lights;this.lights=[];for(var c=0,e=d.length;c<e;c++)this.bindLight(d[c]);d=this.sceneObjects;if(this.octree!==g){c=0;for(e=d.length;c<e;++c){var f=d[c];if(f.obj!==null){if(f.id<0)f.id=b,++b;this.sceneObjectsById[f.id]=f;a.reset(f.octree_aabb,
f.position);this.octree.insert(f);(f.octree_common_root===void 0||f.octree_common_root===null)&&log("!!",f.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(d,c,e){if(this.sceneObjects.indexOf(d)==-1){this.sceneObjects.push(d);c!==g&&c&&this.pickables.push(d);d.name!==null&&(this.sceneObjectsByName[d.name]=d);if(this.octree!==g&&(e===g||e==="true")){if(d.id<0)d.id=b,++b;this.sceneObjectsById[d.id]=
d;a.reset(d.octree_aabb,d.position);this.octree.insert(d)}if(d.children)for(var f=0,m=d.children.length;f<m;f++)this.bindSceneObject(d.children[f],c,e);return d}},removeLight:function(a){a=this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(a)==-1&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),b>=0&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),
b>=0&&this.pickables.splice(b,1),a.name!==null&&this.sceneObjectsByName[a.name]!==g&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==g&&(b===g||b==="true"))a.method===r.light.method.GLOBAL?this.global_lights.push(a):(a.method===r.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(x)},bindCamera:function(a){this.cameras.indexOf(a)===
-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!=="object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===g)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&
this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(c=this.lights.length;b<c;b++){var e=this.lights[b];e.motion!==null&&e.motion.apply(a,e)}},prepareTransforms:function(a){var b,c;if(a){if(a.doTransform(),a.children){b=0;for(c=a.children.length;b<c;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==
0){b=0;for(c=this.sceneObjects.length;b<c;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=n.gl;if(this.shadows_updated)return!1;else a||this.doTransform(),this.shadows_updated=!0;if(y.features.lightShadows){for(var a=!1,c=b.getParameter(b.VIEWPORT),e=0,g=this.lights.length;e<g;e++){var f=this.lights[e];if(f.light_type==r.light.type.SPOT_SHADOW||f.light_type==r.light.type.SPOT_SHADOW_PROJECTOR||f.light_type==r.light.type.AREA){var a=!0,m=[new CubicVR.Light(r.light.type.DEPTH_PACK)];
if(f.light_type===r.light.type.AREA)f.areaCam=this.camera,f.updateAreaLight();n.shadow_near=f.dummyCam.nearclip;n.shadow_far=f.dummyCam.farclip;f.shadowBegin();for(var s=0,q=this.sceneObjects.length;s<q;s++){var x=this.sceneObjects[s];x.parent||x.visible===!1||x.shadowCast===!1||this.renderSceneObject(x,f.dummyCam,m,!1,!0)}f.shadowEnd()}}a&&b.viewport(c[0],c[1],c[2],c[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],
this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());n.depth_alpha_near=this.camera.nearclip;n.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==g,b=0,c=this.sceneObjects.length;b<c;b++){var e=this.sceneObjects[b];if(e.parent===null&&(this.prepareTransforms(e),a&&(lights=[],e.dirty&&e.obj!==null&&e.adjust_octree(),!(e.visible===
!1||a&&(e.ignore_octree||e.drawn_this_frame===!0||e.culled===!0)))))lights=e.dynamic_lights,lights=lights.concat(e.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(lights_rendered=Math.max(lights.length,lights_rendered),lights_rendered===lights.length&&(lights_list=lights),++objects_rendered),lights=lights.length===0?[n.emptyLight]:lights.sort(x),e.drawn_this_frame=!0}},renderSceneObject:function(a,b,c,e,f,m,t){var n=!1,e=e!==g&&e,f=f||!1,m=m||!1;if(a.visible&&a.obj){a.scale[0]<
0&&(n=!n);a.scale[1]<0&&(n=!n);a.scale[2]<0&&(n=!n);n&&gl.cullFace(gl.FRONT);var q=a.obj;if(q.morphTargets!==null&&(a.morphSource!==-1&&q.setMorphSource(a.morphSource),a.morphTarget!==-1&&q.setMorphTarget(a.morphTarget),a.morphWeight!==null))q.morphWeight=a.morphWeight;a.instanceMaterials&&q.bindInstanceMaterials(a.instanceMaterials);CubicVR.renderObject(q,b,a.tMatrix,c,f,m)&&t&&t.push(a);a.instanceMaterials&&q.bindInstanceMaterials(null);n&&gl.cullFace(gl.BACK)}a=a.children;if(e&&a){e=0;for(n=a.length;e<
n;e++)this.renderSceneObject(a[e],b,c,!0,f,m,t)}},runEvents:function(a){var b,c;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(c=this.sceneObjects.length;b<c;b++){var e=this.sceneObjects[b];e.hasEvents()&&e.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(c=this.lockRemovals.length;b<c;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(){++this.frames;var a=n.gl,b;b=0;if(this.octree!==g)this.octree.reset_node_visibility(),
this.octree.cleanup(),b=this.octree.get_frustum_hits(this.camera),b=b.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e,f;e=0;for(f=this.lights.length;e<f;e++)this.lights[e].prepare(this.camera);var m=[],q=[],t=this.lights;e=0;for(f=this.sceneObjects.length;e<f;e++){var s=this.sceneObjects[e];s.visible===!1||s.parent!==null||this.renderSceneObject(s,this.camera,t,!0,!0,!1,q)}e=0;for(f=q.length;e<f;e++)this.renderSceneObject(q[e],this.camera,
t,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=0,this.stats["lights.num_rendered"]=b,this.stats["lights.rendered"]=m,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)a.cullFace(a.FRONT),b=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?c.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],
this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[b,b,b],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),a.cullFace(a.BACK)},bbRayTest:function(a,b,c){var e=CubicVR.vec3,f=[],b=b.length===2?this.camera.unProject(b[0],b[1]):e.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var m=this.pickables[g];if(m.visible===!0){var n,q;q=m.getAABB();n=q[0];q=q[1];q[0]-
n[0]<0.2&&(n[0]-=0.1,q[0]+=0.1);q[1]-n[1]<0.2&&(n[1]-=0.1,q[1]+=0.1);q[2]-n[2]<0.2&&(n[2]-=0.1,q[2]+=0.1);var r=e.multiply(e.add(n,q),0.5),x=e.getClosestTo(a,b,r),r=e.length(e.subtract(x,r));(x[0]>=n[0]&&x[0]<=q[0]?1:0)+(x[1]>=n[1]&&x[1]<=q[1]?1:0)+(x[2]>=n[2]&&x[2]<=q[2]?1:0)>=c&&f.push({dist:r,obj:m})}}f.length&&f.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return f}};f.prototype={addMesh:function(a,b,c){this.meshBin[a]===g&&(this.meshBin[a]=[],this.meshBinPtr[a]===
g&&(this.meshBinPtr[a]=0));this.meshMap[b]===g&&(this.meshMap[b]=c,this.meshBin[a].push(c))},addImage:function(a,b,c){this.imageBin[a]===g&&(this.imageBin[a]=[],this.imageBinPtr[a]===g&&(this.imageBinPtr[a]=0));this.imageMap[b]===g&&(this.imageMap[b]=c,this.imageBin[a].push(c))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];
if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,
this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:m,SceneObject:q,SkyBox:function(a){var b=a.texture,a=a.mapping,c=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/y.Images[c.texture.tex_id].width;if(c.mapping===null)c.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),
d=new CubicVR.Mesh;d.sky_mapping=c.mapping;CubicVR.primitives.box({mesh:d,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();c.scene_object=new CubicVR.SceneObject(d);c.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:f}});CubicVR.RegisterModule("ScenePhysics",function(y){function x(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function q(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function m(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function f(a){return new Ammo.btVector3(a[0],a[1],a[2])}function g(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function r(a){return[a.x(),a.y(),a.z()]}function n(a){this.setManifold(a)}var a=y.undef,c=CubicVR.enums,
b=y.nop;c.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5}};var e,d,h,o,z,y=function(a,b){var c={};if(!a.position&&a.sceneObject)c=a,a=a.sceneObject,b=c.properties;this.properties=new CubicVR.RigidProperties(b?
b:{});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=c.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=c.angularVelocity||[0,0,0];this.init_impulse=this.impulse=c.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=c.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();
this.transform.setOrigin(f(this.init_position));this.transform.setRotation(g(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};y.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},
setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=a},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();
this.getType()===c.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&
this.body.setRestitution(this.getRestitution()),x(this.linearVelocity,o),this.body.setLinearVelocity(o),x(this.angularVelocity,o),this.body.setAngularVelocity(o),CubicVR.vec3.equal([0,0,0],this.impulse)||(x(this.impulse,o),x(this.impulsePosition,z),this.body.applyImpulse(o,z)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&
(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();
x(this.init_position,a);var a=this.body.getWorldTransform().getRotation(),b=this.init_rotation;d.fromEuler(b[0],b[1],b[2]);a.setX(this.init_rotation[0]);a.setY(this.init_rotation[1]);a.setZ(this.init_rotation[2]);a.setW(this.init_rotation[3]);this.resetMotion();this.activate()}},resetMotion:function(){x(this.init_linearVelocity,o);this.body.setLinearVelocity(o);x(this.init_angularVelocity,o);this.body.setAngularVelocity(o);CubicVR.vec3.equal([0,0,0],this.init_impulse)||(x(this.init_impulse,o),x(this.init_impulsePosition,
z),this.body.applyImpulse(o,z))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var d=a.getShapes(),h,m,n,o,q,r,v,w=[];r=null;m=0;for(n=d.length;m<n;m++){h=d[m];r=null;if(h.type===c.collision.shape.BOX)r=new Ammo.btBoxShape(new Ammo.btVector3(h.size[0]/2,h.size[1]/2,h.size[2]/2));else if(h.type===c.collision.shape.SPHERE)r=new Ammo.btSphereShape(h.radius);else if(h.type===c.collision.shape.CAPSULE)r=new Ammo.btCapsuleShape(h.radius,
h.height);else if(h.type===c.collision.shape.CYLINDER)r=new Ammo.btCylinderShape(new Ammo.btVector3(h.size[0]/2,h.size[1]/2,h.size[2]/2));else if(h.type===c.collision.shape.CONE)r=new Ammo.btConeShape(h.radius,h.height);else if(h.type===c.collision.shape.MESH){v=h.mesh;var z=new Ammo.btTriangleMesh;r=h.size;var y=new Ammo.btVector3(0,0,0),E=new Ammo.btVector3(0,0,0),F=new Ammo.btVector3(0,0,0);o=0;for(q=v.faces.length;o<q;o++){var H=v.faces[o];H.points.length===3&&(y.setValue(v.points[H.points[0]][0]*
r[0],v.points[H.points[0]][1]*r[1],v.points[H.points[0]][2]*r[2]),E.setValue(v.points[H.points[1]][0]*r[0],v.points[H.points[1]][1]*r[1],v.points[H.points[1]][2]*r[2]),F.setValue(v.points[H.points[2]][0]*r[0],v.points[H.points[2]][1]*r[1],v.points[H.points[2]][2]*r[2]),z.addTriangle(y,E,F))}this.getMass()===0||this.getType()==c.physics.body.STATIC||this.getType()==c.physics.body.GHOST?(this.setMass(0),r=new Ammo.btBvhTriangleMeshShape(z,!0)):r=new Ammo.btConvexTriangleMeshShape(z,!0)}else if(h.type===
c.collision.shape.CONVEX_HULL){v=h.mesh;z=new Ammo.btVector3(0,0,0);r=new Ammo.btConvexHullShape;o=0;for(q=v.points.length;o<q;o++)x(v.points[o],z),r.addPoint(z)}else h.type===c.collision.shape.HEIGHTFIELD&&b();r&&(h.margin!==0&&r.setMargin(h.margin),w.push({cShape:h,btShape:r}))}d=null;if(w.length===1)d=w[0].btShape;else if(w.length>1){e=new Ammo.btTransform;d=new Ammo.btCompoundShape(!1);m=0;for(n=w.length;m<n;m++)e.setIdentity(),e.setOrigin(f(w[m].cShape.position)),e.setRotation(g(w[m].cShape.rotation)),
d.addChildShape(e,w[m].btShape)}a.setResult(d);a=d}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(x(a,o),this.body.setAngularVelocity(o))},setGravity:function(a){this.gravity=a;this.body&&(x(a,o),this.body.setGravity(o))},getGravity:function(){if(this.gravity&&!this.body)return this.gravity;return r(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(x(a,o),this.body.setLinearVelocity(o))},applyImpulse:function(a,
b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(x(this.impulse,o),x(this.impulsePosition,z),this.body.applyImpulse(o,z))},applyForce:function(a,b){this.body&&!CubicVR.vec3.equal([0,0,0],a)&&(x(a,o),x(b,z),this.body.applyImpulse(o,z))},getAngularVelocity:function(){return r(this.body.getAngularVelocity())},getLinearVelocity:function(){return r(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&
this.body.setActivationState(Ammo.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),x(b,o),this.body.setAngularFactor(o))},isActive:function(){if(this.body)this.body.isActive();else return!1},isStatic:function(){return this.properties.type==c.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a;this.body&&this.body.setCollisionFlags(a)},
setPosition:function(a){this.position=a;if(this.body||this.ghost)x(a,o),this.body&&this.body.getCenterOfMassTransform().setOrigin(o),this.ghost&&this.ghost.getWorldTransform().setOrigin(o)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(h);this.ghost&&this.ghost.getWorldTransform().getRotation(h);var a=new CubicVR.Quaternion;m(h,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)q(a,
h),this.body&&this.body.getCenterOfMassTransform().setRotation(h),this.ghost&&this.ghost.getWorldTransform().setRotation(h)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new CubicVR.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(h);this.ghost&&this.ghost.getWorldTransform().getRotation(h);m(h,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;h.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),
this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(h);this.ghost&&this.body.getWorldTransform().setRotation(h)}};var v=function(b){b=b||{};this.ctype=b.ctype||c.physics.constraint.P2P;this.strength=b.strength||0.1;this.maxImpulse=b.maxImpulse||0;this.rigidBodyA=b.rigidBodyA||b.rigidBody||null;this.rigidBodyB=b.rigidBodyB||null;this.positionA=b.positionA||[0,0,0];this.positionB=b.positionB||b.position||[0,0,0];this.damping=b.damping!=a?b.damping:1;this.btConstraint=
null;this.localPivotA=f(this.positionA);this.localPivotB=f(this.positionB)};v.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===c.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),
this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=
a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(x(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};n.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);if(a===Ammo.NULL)return null;return{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),
positionA:r(a.getPositionWorldOnA()),positionB:r(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var w=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;
this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!d)o=new Ammo.btVector3,z=new Ammo.btVector3,e=new Ammo.btTransform,d=new CubicVR.Quaternion,h=new Ammo.btQuaternion};w.prototype={addConstraint:function(a){var b=a.getConstraint();if(b)return this.dynamicsWorld.addConstraint(b),
a.rigidBodyA.activate(!0),!0;return!1},removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){x(a,o);this.dynamicsWorld.setGravity(o)},bindSceneObject:function(a,b){var c=new CubicVR.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bindRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(this.ghostObjects.indexOf(a)!==
-1)return;this.ghostObjects.push(a);var b=a.getBody();a.properties.blocker||b.setCollisionFlags(b.getCollisionFlags()+c.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(b)}else{if(this.rigidObjects.indexOf(a)!==-1)return;this.rigidObjects.push(a);b=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(c.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(c.event.COLLIDE)&&
this.collisionObjects.push(a)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,b,d,e=this.dynamicsWorld;if(this.contactObjects.length){var f=e.getDispatcher().getNumManifolds();for(a=0;a<f;a++){var g,h=e.getDispatcher().getManifoldByIndexInternal(a),m=Ammo.wrapPointer(h.getBody0(),
Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(h.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(m&&(g=m.getSceneObject())&&(b=g.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.self=m,d.other=o,d.contacts?d.contacts.setManifold(h):d.contacts=new n(h);else if(o&&o.isStatic()&&(g=o.getSceneObject())&&(b=g.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.other=m,d.self=o,d.contacts?d.contacts.setManifold(h):d.contacts=
new n(h)}}e=this.collisionObjects.length;for(a=0;a<e;a++)if(m=this.collisionObjects[a],(g=m.getSceneObject())&&(b=g.getEventHandler())&&b.hasEvent(c.event.COLLIDE))if(d=b.getProperties(c.event.COLLIDE),h=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],h&&h.length){f=[];m=m.getBody();a=0;for(iMax=h.length;a<iMax;a++){var o=h[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(m,q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(m,q));d.alg[a].processCollision(m,q,this.dynamicsWorld.getDispatchInfo(),
d.mf[a]);d.mf[a].getPersistentManifold().getNumContacts()>0&&(f.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(f.length&&(d=b.triggerEvent(c.event.COLLIDE)))d.collisions=f}e=this.ghostObjects.length;for(a=0;a<e;a++)if(d=this.ghostObjects[a],g=d.getSceneObject())if((b=g.getEventHandler())&&b.hasEvent(c.event.CONTACT_GHOST))if(g=d.getBody(),f=g.getNumOverlappingObjects()){d=b.triggerEvent(c.event.CONTACT_GHOST);d.contacts=d.contacts||[];if(d.contacts.length>
f)d.contacts.length=f;for(b=0;b<f;b++)h=Ammo.btRigidBody.prototype.upcast(g.getOverlappingObject(b)),d.contacts[b]=h._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,c,d){var e,a=f(a);e=f(b);c=c||!1;d=d||!1;b=new Ammo.ClosestRayResultCallback(a,e);this.dynamicsWorld.rayTest(a,e,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&
!d)))return c=body,d=b.get_m_hitPointWorld(),a=c.getCenterOfMassTransform().inverse().op_mul(d),(e=c._cvr_rigidbody)?(Ammo.destroy(b),{position:r(d),localPosition:r(a),rigidBody:e,ammoBody:c}):(Ammo.destroy(b),{position:r(d),localPosition:r(a),rigidBody:null,ammoBody:c});Ammo.destroy(b)}};return{ScenePhysics:w,Constraint:v,RigidProperties:function(b){this.type=b.type!==a?b.type:c.physics.body.DYNAMIC;this.mass=b.mass!==a?b.mass:this.type?1:0;this.size=b.size||[1,1,1];this.restitution=b.restitution||
(this.type?0:1);this.friction=b.friction||1;if((this.collision=b.collision)&&!this.collision.getShapes)this.collision=new CubicVR.CollisionMap(this.collision);this.blocker=b.blocker||!1},RigidBody:y,vec3bt_copy:x,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:q,btquat_copy:m}});CubicVR.RegisterModule("Shader",function(y){function x(a,c){var b=CubicVR.util,e,d;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];a.indexOf("\n")!==-1?e=r(m.gl,a,"x-shader/x-vertex"):(e=n(m.gl,a),e===null&&(d=b.getURL(a),e=r(m.gl,d,"x-shader/x-vertex")));c.indexOf("\n")!==-1?d=r(m.gl,c,"x-shader/x-fragment"):(d=n(m.gl,c),d===null&&(d=b.getURL(c),d=r(m.gl,d,"x-shader/x-fragment")));this.shader=m.gl.createProgram();m.gl.attachShader(this.shader,e);m.gl.attachShader(this.shader,d);m.gl.linkProgram(this.shader);
if(!m.gl.getProgramParameter(this.shader,m.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+a+"), frag("+c+")");}var q=y.undef,m=y.GLCore,f=CubicVR.enums,g=y.log;f.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var r=function(a,c,b){if(b==="x-shader/x-fragment")b=a.createShader(a.FRAGMENT_SHADER);else if(b==="x-shader/x-vertex")b=a.createShader(a.VERTEX_SHADER);
else return null;a.shaderSource(b,c);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))return g(a.getShaderInfoLog(b)),null;return b},n=function(a,c){var b=document.getElementById(c);if(!b)return null;for(var e="",d=b.firstChild;d;)d.nodeType===3&&(e+=d.textContent),d=d.nextSibling;if(b.type==="x-shader/x-fragment")b=a.createShader(a.FRAGMENT_SHADER);else if(b.type==="x-shader/x-vertex")b=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(b,e);a.compileShader(b);a.getShaderParameter(b,
a.COMPILE_STATUS)||g(a.getShaderInfoLog(b));return b};x.prototype={bindSelf:function(a){var c,b,e;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(c=a.split("["),e=c[0],c=c[1].split("]"),b=c[0],c=c[1].split("."),c=c[1],this[e]===q&&(this[e]=[]),this[e][b]===q&&(this[e][b]={}),this[e][b][c]=this.uniforms[a]):(c=a.split("."),e=c[0],c=c[1],this[e]===q&&(this[e]={}),this[e][c]=this.uniforms[a]):a.indexOf("[")!==-1?(c=a.split("["),e=c[0],c=c[1].split("]"),b=c[0],this[e]===q&&(this[e]=[]),this[e][b]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,c){this.use();this.uniforms[a]=m.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setMatrix(a,c);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,c){this.use();this.uniforms[a]=m.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
c!==q&&this.setVector(a,c);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,c){this.use();this.uniforms[a]=m.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setFloat(a,c);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=m.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=m.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=m.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,c){this.use();this.uniforms[a]=m.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=f.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setInt(a,c);this.bindSelf(a);return this.uniforms[a]},use:function(){m.gl.useProgram(this.shader)},setMatrix:function(a,c){var b=this.uniforms[a];if(b!==null){var e=c.length;e===16?m.gl.uniformMatrix4fv(b,!1,c):e===9?m.gl.uniformMatrix3fv(b,!1,c):e===
4&&m.gl.uniformMatrix2fv(b,!1,c)}},setInt:function(a,c){var b=this.uniforms[a];b!==null&&m.gl.uniform1i(b,c)},setFloat:function(a,c){var b=this.uniforms[a];b!==null&&m.gl.uniform1f(b,c)},setVector:function(a,c){var b=this.uniforms[a];if(b!==null){var e=c.length;e==3?m.gl.uniform3fv(b,c):e==2?m.gl.uniform2fv(b,c):m.gl.uniform4fv(b,c)}},clearArray:function(a){a=this.uniforms[a];a!==null&&m.gl.disableVertexAttribArray(a)},bindArray:function(a,c){var b=m.gl,e=this.uniforms[a];if(e!==null){var d=this.uniform_type[a];
d===f.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):d===f.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,2,b.FLOAT,!1,0,0)):d===f.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,1,b.FLOAT,!1,0,0))}}};return{Shader:x}});CubicVR.RegisterModule("UVMapper",function(y){function x(a){a=f.getJSONScriptObj(a,function(a){a.projectionMode=c[a.projectionMode];a.projectionAxis=c[a.projectionAxis]})||{};this.rotation=a.rotation===q?[0,0,0]:a.rotation;this.scale=a.scale===q?[1,1,1]:a.scale;this.center=a.center===q?[0,0,0]:a.center;this.projection_mode=a.projectionMode===q?m.uv.projection.PLANAR:a.projectionMode;this.projection_axis=a.projectionAxis===q?m.uv.axis.X:a.projectionAxis;this.wrap_w_count=a.wrapW===q?1:a.wrapW;this.wrap_h_count=
a.wrapH===q?1:a.wrapH}var q=y.undef,m=CubicVR.enums,f=CubicVR.util,g=2*Math.PI,r=Math.PI/2;m.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var n=function(a,c,d){return a===0&&d===0?0:d===0?a<0?r:-r:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d)},a=function(a,c,d){var f;a===0&&d===0?(f=0,a=c!==0?c<0?-r:r:0):(f=d===0?a<0?r:-r:d<0?-Math.atan(a/d)+Math.PI:-Math.atan(a/d),a=Math.sqrt(a*a+d*d),a=a===0?c<0?-r:r:Math.atan(c/a));return[f,a]},c={x:m.uv.axis.X,y:m.uv.axis.Y,
z:m.uv.axis.Z,uv:m.uv.projection.UV,planar:m.uv.projection.PLANAR,cylindrical:m.uv.projection.CYLINDRICAL,spherical:m.uv.projection.SPHERICAL,cubic:m.uv.projection.CUBIC,sky:m.uv.projection.SKY};x.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=
a},apply:function(b,c,d,f,o){var x=CubicVR.mat4,v,w,t,s,y,I=new CubicVR.Transform,G=!1,A=null;if(this.center[0]||this.center[1]||this.center[2])I.translate(-this.center[0],-this.center[1],-this.center[2]),G=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&I.rotate(this.rotation[2],0,0,1),this.rotation[1]&&I.rotate(this.rotation[1],0,1,0),this.rotation[2]&&I.rotate(this.rotation[0],1,0,0),G=!0;G&&(A=I.getResult());typeof c==="object"&&(c=b.materials.indexOf(c));var I=0,
u=b.faces.length;f&&(I=f);for(o&&(u=o+1);I<u;I++)if(b.faces[I].material===c&&!(d!==q&&b.faces[I].segment!==d)){var K,D,C;if(this.projection_mode===m.uv.projection.CUBIC||this.projection_mode===m.uv.projection.SKY)K=Math.abs(b.faces[I].normal[0]),D=Math.abs(b.faces[I].normal[1]),C=Math.abs(b.faces[I].normal[2]);for(var f=[],o=0,Z=b.faces[I].points.length;o<Z;o++){w=b.faces[I].points[o];var L=b.faces[I].points[(o+1)%3],E=b.faces[I].points[(o+2)%3];v=b.points[w];var F=b.points[L],H=b.points[E],O;G&&
(v=x.vec3_multiply(v,A));O=this.projection_mode;if(O===m.uv.projection.SKY)w=b.sky_mapping,K>=D&&K>=C&&(t=v[2]/this.scale[2]+this.scale[2]/2,s=-v[1]/this.scale[1]+this.scale[1]/2,b.faces[I].normal[0]<0?(t=(w[2][2]-w[2][0])*(1-t),s=1-(w[2][3]-w[2][1])*s,t+=w[2][0],s+=w[2][1]):(t*=w[3][2]-w[3][0],s=1-(w[3][3]-w[3][1])*s,t+=w[3][0],s+=w[3][1])),D>=K&&D>=C&&(t=v[0]/this.scale[0]+this.scale[0]/2,s=-v[2]/this.scale[2]+this.scale[2]/2,b.faces[I].normal[1]<0?(t*=w[1][2]-w[1][0],s=1-(w[1][3]-w[1][1])*s,t+=
w[1][0],s-=w[1][1]):(t*=w[0][2]-w[0][0],s=1-(w[0][3]-w[0][1])*s,t+=w[0][0],s-=w[0][1])),C>=K&&C>=D&&(t=v[0]/this.scale[0]+this.scale[0]/2,s=v[1]/this.scale[1]+this.scale[1]/2,b.faces[I].normal[2]<0?(t*=w[4][2]-w[4][0],s=1-(w[4][3]-w[4][1])*(1-s),t+=w[4][0],s-=w[4][1]):(t=(w[5][2]-w[5][0])*(1-t),s=1-(w[5][3]-w[5][1])*(1-s),t+=w[5][0],s+=w[5][1])),b.faces[I].setUV([t,s],o);else if(O===m.uv.projection.CUBIC)K>=D&&K>=C&&(t=v[2]/this.scale[2]+0.5,s=v[1]/this.scale[1]+0.5),D>=K&&D>=C&&(t=-v[0]/this.scale[0]+
0.5,s=v[2]/this.scale[2]+0.5),C>=K&&C>=D&&(t=-v[0]/this.scale[0]+0.5,s=v[1]/this.scale[1]+0.5),b.faces[I].normal[0]>0&&(t=-t),b.faces[I].normal[1]<0&&(t=-t),b.faces[I].normal[2]>0&&(t=-t),b.faces[I].setUV([t,s],o);else if(O===m.uv.projection.PLANAR)t=this.projection_axis===m.uv.axis.X?v[2]/this.scale[2]+0.5:-v[0]/this.scale[0]+0.5,s=this.projection_axis===m.uv.axis.Y?v[2]/this.scale[2]+0.5:v[1]/this.scale[1]+0.5,b.faces[I].setUV([t,s],o);else{if(O===m.uv.projection.CYLINDRICAL)O=this.projection_axis,
O===m.uv.axis.X?(y=n(v[2],v[0],-v[1]),s=-v[0]/this.scale[0]+0.5):O===m.uv.axis.Y?(y=n(-v[0],v[1],v[2]),s=-v[1]/this.scale[1]+0.5):O===m.uv.axis.Z&&(y=n(-v[0],v[2],-v[1]),s=-v[2]/this.scale[2]+0.5),y=1-y/g,this.wrap_w_count!==1&&(y*=this.wrap_w_count),v=y,w=s;else if(O===m.uv.projection.SPHERICAL){var J,P,R;O=this.projection_axis;O===m.uv.axis.X?(J=f[w]?f[w]:a(v[2],v[0],-v[1]),f[w]||(f[w]=J),P=f[L]?f[L]:a(F[2],F[0],-F[1]),f[L]||(f[L]=P),R=f[E]?f[E]:a(H[2],H[0],-H[1]),f[E]||(f[E]=R)):O===m.uv.axis.Y?
(J=f[w]?f[w]:a(v[0],-v[1],v[2]),f[w]||(f[w]=J),P=f[L]?f[L]:a(F[0],-F[1],F[2]),f[L]||(f[L]=P),R=f[E]?f[E]:a(H[0],-H[1],H[2]),f[E]||(f[E]=R)):O===m.uv.axis.Z&&(J=f[w]?f[w]:a(-v[0],v[2],-v[1]),f[w]||(f[w]=J),P=f[L]?f[L]:a(-F[0],F[2],-F[1]),f[L]||(f[L]=P),R=f[E]?f[E]:a(-H[0],H[2],-H[1]),f[E]||(f[E]=R));Math.abs(J[0]-P[0])>r&&Math.abs(J[0]-R[0])>r&&(J[0]>P[0]&&J[0]>R[0]?J[0]-=g:J[0]+=g);Math.abs(J[1]-P[1])>r&&Math.abs(J[1]-R[1])>r&&(J[1]>P[1]&&J[1]>R[1]?J[1]-=g:J[1]+=g);y=1-J[0]/g;w=0.5-J[1]/Math.PI;this.wrap_w_count!==
1&&(y*=this.wrap_w_count);this.wrap_h_count!==1&&(w*=this.wrap_h_count);v=y}else w=v=0;b.faces[I].setUV([v,w],o)}}}return this}};return{UVMapper:x}});CubicVR.RegisterModule("Worker",function(y){function x(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function q(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new x({message:b})}function m(a){function b(a){a=z.getURL(a);c.send("done",a.length)}var c;c=new x({message:function(a){b(a)}});a&&b(a)}function f(a){function b(a){a=
z.getURL(a);c.send("loaded",a)}var c,d;c=new x({message:function(a){if(a.message==="parse")d=new o,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function g(b){function c(b){var e=new a,f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);b=e.triangulateQuads().compileVBO(e.compileMap());
d.send("done",b)}var d;d=new x({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(r){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var n=y.undef,a=CubicVR.Mesh,c=CubicVR.Texture,b=CubicVR.Material,e=CubicVR.SceneObject,d=CubicVR.Motion,h=CubicVR.Envelope,o=CubicVR.DeferredBin,z=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function d(b){var c=
b.parsed||function(){},e={},f;b.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),d=z.xml2badgerfish(b);console.log(b);f.send("parse",d)}else if(b.message==="getMesh"){var d=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(d[g]=b.data.mesh[g]);d.bindBuffer(d.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(d)}else b.message==="parsed"&&c()}}));this.getSceneObject=function(a,
b){f.send("getMesh",a);e.getMesh=b}}function f(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new d({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(d){var h=d.scene,m=d.object,n=d.assetBase||"",o=g.createSceneFileManager({url:d.mesh,parsed:function(){m&&
o.getSceneObject(m,function(d){for(var d=f(d,new a),g=0,m=d.materials.length;g<m;++g){for(var o=f(d.materials[g],new b),q=0,r=o.textures.length;q<r;++q){var s=o.textures[g];o.textures[g]=new c(n+s.img_path,s.filter_type)}d.materials[g]=o}d=new e(d);h.bindSceneObject(d)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(f,g,m,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var x=[],z=[];q.onmessage=function(g){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,c=[],e=0,f=b.length;e<f;++e){var g=b[e];if(g){for(var m=[],n=0,o=g.length;n<o;++n){var s=g[n];if(s){var t=s.keys[0];if(s.keys.length>1)t.prev=null,t.next=s.keys[1],t=s.keys[1];for(var u=1,v=s.keys.length-1;u<v;++u)t.prev=s.keys[u-1],t.next=s.keys[u+1],t=s.keys[u+1];if(s.keys.length>1)t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null;s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new h;q(s,t);m[n]=t}else g[n]=null}c[e]=m}else b[e]=null}a.motion.controllers=c;b=new d;q(a.motion,b);a.motion=b}}function w(b){var c=new e;q(b,c);if(b.obj!==null){var d=z[b.obj.id];if(d===n)if(d=new a,q(b.obj,d),c.obj=d,z[b.obj.id]=d,o){if(d.points.length>0){o.addMesh(f,f+":"+d.id,d);for(var g=0,h=d.faces.length;g<h;++g){var m=d.faces[g],r=m.material;m.material=x[r]!==n?x[r]:0}}}else c.obj.triangulateQuads(),c.obj.calcNormals(),c.obj.compile(),
c.obj.clean();else c.obj=d}c.trans=new Transform;if(b.children&&b.children.length>0&&(c.children=[],b.children)){d=0;for(g=b.children.length;d<g;++d)h=w(b.children[d]),c.bindChild(h)}return c}var y;y=g.data.message;if(y=="materials"){var B=JSON.parse(g.data.data),g=0;for(y=B.length;g<y;++g){var E=new b(B[g].name),F=E.material_id;q(B[g],E);E.material_id=F;x[B[g].material_id]=F;for(var F=0,H=B[g].textures.length;F<H;++F){var I=B[g].textures[F];if(I){var J=Texture_ref[I.img_path];J===n?(I=new c(I.img_path,
I.filter_type,o,f),E.textures[F]=I):E.textures[F]=Textures_obj[J]}else E.textures[F]=0}}}else if(y=="scene"){B=JSON.parse(g.data.data);g=0;for(y=B.sceneObjects.length;g<y;++g){E=B.sceneObjects[g];E.obj!==null&&nop();if(E.reassembled===n)r(E),E.reassembled=!0;B.sceneObjects[g]=w(E)}E=new Scene;g=E.camera;y=g.transform;q(B.camera,g);q(B.camera.transform,y);r(g);E.camera=g;E.camera.transform=y;E.camera.frustum=new Frustum;g=0;for(y=B.sceneObjects.length;g<y;++g){F=B.sceneObjects[g];E.bindSceneObject(F);
try{F.getAABB()}catch(P){}}g=0;for(y=B.lights.length;g<y;++g)F=new Light,q(B.lights[g],F),F.trans=new Transform,r(F),E.bindLight(F);m(E)}else console.log("message from collada worker:",g.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:f,prefix:g,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:q,prepareMesh:g,file:m,sceneFile:f};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
/* Auto Embed ./CubicVR_Core.vs */
window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\nuniform vec2 uTexOffset;\n#if !perPixel\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#endif\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord + uTexOffset;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if !perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),vNormal),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(vNormal, halfVector),0.0);\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),vNormal),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(vNormal, halfVector),0.0);\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\nspecTotal += spec2;\n}\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vNormal, normalize(l)));\nfloat NdotH = max(0.0, dot(vNormal, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\naccum += att * lDiff[i] * mDiff * NdotL;\nspec2 = lSpec[i] * mSpec * power;\nspecTotal += spec2*spotEffect;\n}\nvColor = accum;\nvSpec = specTotal;\n#endif\n#endif \n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
/* Auto Embed ./CubicVR_Core.fs */
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\n#if perPixel\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\nuniform vec3 mAmb;\nuniform vec3 lAmb;\nuniform vec3 mColor;\n#if perPixel\nuniform vec3 mDiff;\nuniform vec3 mSpec;\nuniform float mShine;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\n#if hasProjector\nuniform sampler2D lProjTex[loopCount];\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#else \nvarying vec3 vColor;\nvarying vec3 vSpec;\n#endif  \nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if perPixel\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !hasProjector\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if hasProjector && hasShadow\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lProjTex[i],shadowCoord.st).rgb;\naccum += att * projTex * lInt[i] * mDiff * lDiff[i] * NdotL;\n}\n#else\naccum += att * lDiff[i] * mDiff * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#else\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb *= vColor;\ncolor.rgb += vSpec;\n#endif\n#endif \n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
